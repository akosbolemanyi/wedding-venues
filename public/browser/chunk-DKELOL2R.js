import{d as ph,e as _h,g as Bt,m as yh,n as wh,o as vh,q as Ih,r as Eh,s as Th,t as Ah,u as Sh,v as bh,w as Rh,x as Ph,y as Ch}from"./chunk-AHPA5K5D.js";import{b as ah,d as uh,e as Fr,f as Ko,g as ch,h as lh,j as $o,k as ct,l as Ki,m as Xt,n as hh,o as dh,p as fh,q as mh,s as gh,u as Qo,v as Wo}from"./chunk-C7U3NQ45.js";import{A as zo,I as nh,N as Gi,O as ji,Oc as oh,S as zi,c as th,gb as sh,h as eh,m as Nr,n as jo,na as rh,qa as kr,r as Qt,ta as ih,xa as It}from"./chunk-HHBLOR6C.js";import{a as Bi,b as Bo,e as Go,f as C}from"./chunk-CQCHLVVT.js";var xh=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Vh={};var be,Ho;(function(){var r;function t(v,p){function w(){}w.prototype=p.prototype,v.D=p.prototype,v.prototype=new w,v.prototype.constructor=v,v.C=function(I,E,A){for(var _=Array(arguments.length-2),ce=2;ce<arguments.length;ce++)_[ce-2]=arguments[ce];return p.prototype[E].apply(I,_)}}function e(){this.blockSize=-1}function n(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(n,e),n.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(v,p,w){w||(w=0);var I=Array(16);if(typeof p=="string")for(var E=0;16>E;++E)I[E]=p.charCodeAt(w++)|p.charCodeAt(w++)<<8|p.charCodeAt(w++)<<16|p.charCodeAt(w++)<<24;else for(E=0;16>E;++E)I[E]=p[w++]|p[w++]<<8|p[w++]<<16|p[w++]<<24;p=v.g[0],w=v.g[1],E=v.g[2];var A=v.g[3],_=p+(A^w&(E^A))+I[0]+3614090360&4294967295;p=w+(_<<7&4294967295|_>>>25),_=A+(E^p&(w^E))+I[1]+3905402710&4294967295,A=p+(_<<12&4294967295|_>>>20),_=E+(w^A&(p^w))+I[2]+606105819&4294967295,E=A+(_<<17&4294967295|_>>>15),_=w+(p^E&(A^p))+I[3]+3250441966&4294967295,w=E+(_<<22&4294967295|_>>>10),_=p+(A^w&(E^A))+I[4]+4118548399&4294967295,p=w+(_<<7&4294967295|_>>>25),_=A+(E^p&(w^E))+I[5]+1200080426&4294967295,A=p+(_<<12&4294967295|_>>>20),_=E+(w^A&(p^w))+I[6]+2821735955&4294967295,E=A+(_<<17&4294967295|_>>>15),_=w+(p^E&(A^p))+I[7]+4249261313&4294967295,w=E+(_<<22&4294967295|_>>>10),_=p+(A^w&(E^A))+I[8]+1770035416&4294967295,p=w+(_<<7&4294967295|_>>>25),_=A+(E^p&(w^E))+I[9]+2336552879&4294967295,A=p+(_<<12&4294967295|_>>>20),_=E+(w^A&(p^w))+I[10]+4294925233&4294967295,E=A+(_<<17&4294967295|_>>>15),_=w+(p^E&(A^p))+I[11]+2304563134&4294967295,w=E+(_<<22&4294967295|_>>>10),_=p+(A^w&(E^A))+I[12]+1804603682&4294967295,p=w+(_<<7&4294967295|_>>>25),_=A+(E^p&(w^E))+I[13]+4254626195&4294967295,A=p+(_<<12&4294967295|_>>>20),_=E+(w^A&(p^w))+I[14]+2792965006&4294967295,E=A+(_<<17&4294967295|_>>>15),_=w+(p^E&(A^p))+I[15]+1236535329&4294967295,w=E+(_<<22&4294967295|_>>>10),_=p+(E^A&(w^E))+I[1]+4129170786&4294967295,p=w+(_<<5&4294967295|_>>>27),_=A+(w^E&(p^w))+I[6]+3225465664&4294967295,A=p+(_<<9&4294967295|_>>>23),_=E+(p^w&(A^p))+I[11]+643717713&4294967295,E=A+(_<<14&4294967295|_>>>18),_=w+(A^p&(E^A))+I[0]+3921069994&4294967295,w=E+(_<<20&4294967295|_>>>12),_=p+(E^A&(w^E))+I[5]+3593408605&4294967295,p=w+(_<<5&4294967295|_>>>27),_=A+(w^E&(p^w))+I[10]+38016083&4294967295,A=p+(_<<9&4294967295|_>>>23),_=E+(p^w&(A^p))+I[15]+3634488961&4294967295,E=A+(_<<14&4294967295|_>>>18),_=w+(A^p&(E^A))+I[4]+3889429448&4294967295,w=E+(_<<20&4294967295|_>>>12),_=p+(E^A&(w^E))+I[9]+568446438&4294967295,p=w+(_<<5&4294967295|_>>>27),_=A+(w^E&(p^w))+I[14]+3275163606&4294967295,A=p+(_<<9&4294967295|_>>>23),_=E+(p^w&(A^p))+I[3]+4107603335&4294967295,E=A+(_<<14&4294967295|_>>>18),_=w+(A^p&(E^A))+I[8]+1163531501&4294967295,w=E+(_<<20&4294967295|_>>>12),_=p+(E^A&(w^E))+I[13]+2850285829&4294967295,p=w+(_<<5&4294967295|_>>>27),_=A+(w^E&(p^w))+I[2]+4243563512&4294967295,A=p+(_<<9&4294967295|_>>>23),_=E+(p^w&(A^p))+I[7]+1735328473&4294967295,E=A+(_<<14&4294967295|_>>>18),_=w+(A^p&(E^A))+I[12]+2368359562&4294967295,w=E+(_<<20&4294967295|_>>>12),_=p+(w^E^A)+I[5]+4294588738&4294967295,p=w+(_<<4&4294967295|_>>>28),_=A+(p^w^E)+I[8]+2272392833&4294967295,A=p+(_<<11&4294967295|_>>>21),_=E+(A^p^w)+I[11]+1839030562&4294967295,E=A+(_<<16&4294967295|_>>>16),_=w+(E^A^p)+I[14]+4259657740&4294967295,w=E+(_<<23&4294967295|_>>>9),_=p+(w^E^A)+I[1]+2763975236&4294967295,p=w+(_<<4&4294967295|_>>>28),_=A+(p^w^E)+I[4]+1272893353&4294967295,A=p+(_<<11&4294967295|_>>>21),_=E+(A^p^w)+I[7]+4139469664&4294967295,E=A+(_<<16&4294967295|_>>>16),_=w+(E^A^p)+I[10]+3200236656&4294967295,w=E+(_<<23&4294967295|_>>>9),_=p+(w^E^A)+I[13]+681279174&4294967295,p=w+(_<<4&4294967295|_>>>28),_=A+(p^w^E)+I[0]+3936430074&4294967295,A=p+(_<<11&4294967295|_>>>21),_=E+(A^p^w)+I[3]+3572445317&4294967295,E=A+(_<<16&4294967295|_>>>16),_=w+(E^A^p)+I[6]+76029189&4294967295,w=E+(_<<23&4294967295|_>>>9),_=p+(w^E^A)+I[9]+3654602809&4294967295,p=w+(_<<4&4294967295|_>>>28),_=A+(p^w^E)+I[12]+3873151461&4294967295,A=p+(_<<11&4294967295|_>>>21),_=E+(A^p^w)+I[15]+530742520&4294967295,E=A+(_<<16&4294967295|_>>>16),_=w+(E^A^p)+I[2]+3299628645&4294967295,w=E+(_<<23&4294967295|_>>>9),_=p+(E^(w|~A))+I[0]+4096336452&4294967295,p=w+(_<<6&4294967295|_>>>26),_=A+(w^(p|~E))+I[7]+1126891415&4294967295,A=p+(_<<10&4294967295|_>>>22),_=E+(p^(A|~w))+I[14]+2878612391&4294967295,E=A+(_<<15&4294967295|_>>>17),_=w+(A^(E|~p))+I[5]+4237533241&4294967295,w=E+(_<<21&4294967295|_>>>11),_=p+(E^(w|~A))+I[12]+1700485571&4294967295,p=w+(_<<6&4294967295|_>>>26),_=A+(w^(p|~E))+I[3]+2399980690&4294967295,A=p+(_<<10&4294967295|_>>>22),_=E+(p^(A|~w))+I[10]+4293915773&4294967295,E=A+(_<<15&4294967295|_>>>17),_=w+(A^(E|~p))+I[1]+2240044497&4294967295,w=E+(_<<21&4294967295|_>>>11),_=p+(E^(w|~A))+I[8]+1873313359&4294967295,p=w+(_<<6&4294967295|_>>>26),_=A+(w^(p|~E))+I[15]+4264355552&4294967295,A=p+(_<<10&4294967295|_>>>22),_=E+(p^(A|~w))+I[6]+2734768916&4294967295,E=A+(_<<15&4294967295|_>>>17),_=w+(A^(E|~p))+I[13]+1309151649&4294967295,w=E+(_<<21&4294967295|_>>>11),_=p+(E^(w|~A))+I[4]+4149444226&4294967295,p=w+(_<<6&4294967295|_>>>26),_=A+(w^(p|~E))+I[11]+3174756917&4294967295,A=p+(_<<10&4294967295|_>>>22),_=E+(p^(A|~w))+I[2]+718787259&4294967295,E=A+(_<<15&4294967295|_>>>17),_=w+(A^(E|~p))+I[9]+3951481745&4294967295,v.g[0]=v.g[0]+p&4294967295,v.g[1]=v.g[1]+(E+(_<<21&4294967295|_>>>11))&4294967295,v.g[2]=v.g[2]+E&4294967295,v.g[3]=v.g[3]+A&4294967295}n.prototype.u=function(v,p){p===void 0&&(p=v.length);for(var w=p-this.blockSize,I=this.B,E=this.h,A=0;A<p;){if(E==0)for(;A<=w;)i(this,v,A),A+=this.blockSize;if(typeof v=="string"){for(;A<p;)if(I[E++]=v.charCodeAt(A++),E==this.blockSize){i(this,I),E=0;break}}else for(;A<p;)if(I[E++]=v[A++],E==this.blockSize){i(this,I),E=0;break}}this.h=E,this.o+=p},n.prototype.v=function(){var v=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);v[0]=128;for(var p=1;p<v.length-8;++p)v[p]=0;var w=8*this.o;for(p=v.length-8;p<v.length;++p)v[p]=w&255,w/=256;for(this.u(v),v=Array(16),p=w=0;4>p;++p)for(var I=0;32>I;I+=8)v[w++]=this.g[p]>>>I&255;return v};function s(v,p){var w=u;return Object.prototype.hasOwnProperty.call(w,v)?w[v]:w[v]=p(v)}function a(v,p){this.h=p;for(var w=[],I=!0,E=v.length-1;0<=E;E--){var A=v[E]|0;I&&A==p||(w[E]=A,I=!1)}this.g=w}var u={};function l(v){return-128<=v&&128>v?s(v,function(p){return new a([p|0],0>p?-1:0)}):new a([v|0],0>v?-1:0)}function d(v){if(isNaN(v)||!isFinite(v))return g;if(0>v)return D(d(-v));for(var p=[],w=1,I=0;v>=w;I++)p[I]=v/w|0,w*=4294967296;return new a(p,0)}function f(v,p){if(v.length==0)throw Error("number format error: empty string");if(p=p||10,2>p||36<p)throw Error("radix out of range: "+p);if(v.charAt(0)=="-")return D(f(v.substring(1),p));if(0<=v.indexOf("-"))throw Error('number format error: interior "-" character');for(var w=d(Math.pow(p,8)),I=g,E=0;E<v.length;E+=8){var A=Math.min(8,v.length-E),_=parseInt(v.substring(E,E+A),p);8>A?(A=d(Math.pow(p,A)),I=I.j(A).add(d(_))):(I=I.j(w),I=I.add(d(_)))}return I}var g=l(0),y=l(1),S=l(16777216);r=a.prototype,r.m=function(){if(k(this))return-D(this).m();for(var v=0,p=1,w=0;w<this.g.length;w++){var I=this.i(w);v+=(0<=I?I:4294967296+I)*p,p*=4294967296}return v},r.toString=function(v){if(v=v||10,2>v||36<v)throw Error("radix out of range: "+v);if(N(this))return"0";if(k(this))return"-"+D(this).toString(v);for(var p=d(Math.pow(v,6)),w=this,I="";;){var E=Q(w,p).g;w=G(w,E.j(p));var A=((0<w.g.length?w.g[0]:w.h)>>>0).toString(v);if(w=E,N(w))return A+I;for(;6>A.length;)A="0"+A;I=A+I}},r.i=function(v){return 0>v?0:v<this.g.length?this.g[v]:this.h};function N(v){if(v.h!=0)return!1;for(var p=0;p<v.g.length;p++)if(v.g[p]!=0)return!1;return!0}function k(v){return v.h==-1}r.l=function(v){return v=G(this,v),k(v)?-1:N(v)?0:1};function D(v){for(var p=v.g.length,w=[],I=0;I<p;I++)w[I]=~v.g[I];return new a(w,~v.h).add(y)}r.abs=function(){return k(this)?D(this):this},r.add=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],I=0,E=0;E<=p;E++){var A=I+(this.i(E)&65535)+(v.i(E)&65535),_=(A>>>16)+(this.i(E)>>>16)+(v.i(E)>>>16);I=_>>>16,A&=65535,_&=65535,w[E]=_<<16|A}return new a(w,w[w.length-1]&-2147483648?-1:0)};function G(v,p){return v.add(D(p))}r.j=function(v){if(N(this)||N(v))return g;if(k(this))return k(v)?D(this).j(D(v)):D(D(this).j(v));if(k(v))return D(this.j(D(v)));if(0>this.l(S)&&0>v.l(S))return d(this.m()*v.m());for(var p=this.g.length+v.g.length,w=[],I=0;I<2*p;I++)w[I]=0;for(I=0;I<this.g.length;I++)for(var E=0;E<v.g.length;E++){var A=this.i(I)>>>16,_=this.i(I)&65535,ce=v.i(E)>>>16,mr=v.i(E)&65535;w[2*I+2*E]+=_*mr,j(w,2*I+2*E),w[2*I+2*E+1]+=A*mr,j(w,2*I+2*E+1),w[2*I+2*E+1]+=_*ce,j(w,2*I+2*E+1),w[2*I+2*E+2]+=A*ce,j(w,2*I+2*E+2)}for(I=0;I<p;I++)w[I]=w[2*I+1]<<16|w[2*I];for(I=p;I<2*p;I++)w[I]=0;return new a(w,0)};function j(v,p){for(;(v[p]&65535)!=v[p];)v[p+1]+=v[p]>>>16,v[p]&=65535,p++}function U(v,p){this.g=v,this.h=p}function Q(v,p){if(N(p))throw Error("division by zero");if(N(v))return new U(g,g);if(k(v))return p=Q(D(v),p),new U(D(p.g),D(p.h));if(k(p))return p=Q(v,D(p)),new U(D(p.g),p.h);if(30<v.g.length){if(k(v)||k(p))throw Error("slowDivide_ only works with positive integers.");for(var w=y,I=p;0>=I.l(v);)w=H(w),I=H(I);var E=z(w,1),A=z(I,1);for(I=z(I,2),w=z(w,2);!N(I);){var _=A.add(I);0>=_.l(v)&&(E=E.add(w),A=_),I=z(I,1),w=z(w,1)}return p=G(v,E.j(p)),new U(E,p)}for(E=g;0<=v.l(p);){for(w=Math.max(1,Math.floor(v.m()/p.m())),I=Math.ceil(Math.log(w)/Math.LN2),I=48>=I?1:Math.pow(2,I-48),A=d(w),_=A.j(p);k(_)||0<_.l(v);)w-=I,A=d(w),_=A.j(p);N(A)&&(A=y),E=E.add(A),v=G(v,_)}return new U(E,v)}r.A=function(v){return Q(this,v).h},r.and=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],I=0;I<p;I++)w[I]=this.i(I)&v.i(I);return new a(w,this.h&v.h)},r.or=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],I=0;I<p;I++)w[I]=this.i(I)|v.i(I);return new a(w,this.h|v.h)},r.xor=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],I=0;I<p;I++)w[I]=this.i(I)^v.i(I);return new a(w,this.h^v.h)};function H(v){for(var p=v.g.length+1,w=[],I=0;I<p;I++)w[I]=v.i(I)<<1|v.i(I-1)>>>31;return new a(w,v.h)}function z(v,p){var w=p>>5;p%=32;for(var I=v.g.length-w,E=[],A=0;A<I;A++)E[A]=0<p?v.i(A+w)>>>p|v.i(A+w+1)<<32-p:v.i(A+w);return new a(E,v.h)}n.prototype.digest=n.prototype.v,n.prototype.reset=n.prototype.s,n.prototype.update=n.prototype.u,Ho=Vh.Md5=n,a.prototype.add=a.prototype.add,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.A,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.toString=a.prototype.toString,a.prototype.getBits=a.prototype.i,a.fromNumber=d,a.fromString=f,be=Vh.Integer=a}).apply(typeof xh<"u"?xh:typeof self<"u"?self:typeof window<"u"?window:{});var $i=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},de={};var Jo,Yo,Rn,Xo,Mr,Qi,Zo,ta,ea;(function(){var r,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(o,c,h){return o==Array.prototype||o==Object.prototype||(o[c]=h.value),o};function e(o){o=[typeof globalThis=="object"&&globalThis,o,typeof window=="object"&&window,typeof self=="object"&&self,typeof $i=="object"&&$i];for(var c=0;c<o.length;++c){var h=o[c];if(h&&h.Math==Math)return h}throw Error("Cannot find global object")}var n=e(this);function i(o,c){if(c)t:{var h=n;o=o.split(".");for(var m=0;m<o.length-1;m++){var T=o[m];if(!(T in h))break t;h=h[T]}o=o[o.length-1],m=h[o],c=c(m),c!=m&&c!=null&&t(h,o,{configurable:!0,writable:!0,value:c})}}function s(o,c){o instanceof String&&(o+="");var h=0,m=!1,T={next:function(){if(!m&&h<o.length){var R=h++;return{value:c(R,o[R]),done:!1}}return m=!0,{done:!0,value:void 0}}};return T[Symbol.iterator]=function(){return T},T}i("Array.prototype.values",function(o){return o||function(){return s(this,function(c,h){return h})}});var a=a||{},u=this||self;function l(o){var c=typeof o;return c=c!="object"?c:o?Array.isArray(o)?"array":c:"null",c=="array"||c=="object"&&typeof o.length=="number"}function d(o){var c=typeof o;return c=="object"&&o!=null||c=="function"}function f(o,c,h){return o.call.apply(o.bind,arguments)}function g(o,c,h){if(!o)throw Error();if(2<arguments.length){var m=Array.prototype.slice.call(arguments,2);return function(){var T=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(T,m),o.apply(c,T)}}return function(){return o.apply(c,arguments)}}function y(o,c,h){return y=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?f:g,y.apply(null,arguments)}function S(o,c){var h=Array.prototype.slice.call(arguments,1);return function(){var m=h.slice();return m.push.apply(m,arguments),o.apply(this,m)}}function N(o,c){function h(){}h.prototype=c.prototype,o.aa=c.prototype,o.prototype=new h,o.prototype.constructor=o,o.Qb=function(m,T,R){for(var F=Array(arguments.length-2),et=2;et<arguments.length;et++)F[et-2]=arguments[et];return c.prototype[T].apply(m,F)}}function k(o){let c=o.length;if(0<c){let h=Array(c);for(let m=0;m<c;m++)h[m]=o[m];return h}return[]}function D(o,c){for(let h=1;h<arguments.length;h++){let m=arguments[h];if(l(m)){let T=o.length||0,R=m.length||0;o.length=T+R;for(let F=0;F<R;F++)o[T+F]=m[F]}else o.push(m)}}class G{constructor(c,h){this.i=c,this.j=h,this.h=0,this.g=null}get(){let c;return 0<this.h?(this.h--,c=this.g,this.g=c.next,c.next=null):c=this.i(),c}}function j(o){return/^[\s\xa0]*$/.test(o)}function U(){var o=u.navigator;return o&&(o=o.userAgent)?o:""}function Q(o){return Q[" "](o),o}Q[" "]=function(){};var H=U().indexOf("Gecko")!=-1&&!(U().toLowerCase().indexOf("webkit")!=-1&&U().indexOf("Edge")==-1)&&!(U().indexOf("Trident")!=-1||U().indexOf("MSIE")!=-1)&&U().indexOf("Edge")==-1;function z(o,c,h){for(let m in o)c.call(h,o[m],m,o)}function v(o,c){for(let h in o)c.call(void 0,o[h],h,o)}function p(o){let c={};for(let h in o)c[h]=o[h];return c}let w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function I(o,c){let h,m;for(let T=1;T<arguments.length;T++){m=arguments[T];for(h in m)o[h]=m[h];for(let R=0;R<w.length;R++)h=w[R],Object.prototype.hasOwnProperty.call(m,h)&&(o[h]=m[h])}}function E(o){var c=1;o=o.split(":");let h=[];for(;0<c&&o.length;)h.push(o.shift()),c--;return o.length&&h.push(o.join(":")),h}function A(o){u.setTimeout(()=>{throw o},0)}function _(){var o=po;let c=null;return o.g&&(c=o.g,o.g=o.g.next,o.g||(o.h=null),c.next=null),c}class ce{constructor(){this.h=this.g=null}add(c,h){let m=mr.get();m.set(c,h),this.h?this.h.next=m:this.g=m,this.h=m}}var mr=new G(()=>new cg,o=>o.reset());class cg{constructor(){this.next=this.g=this.h=null}set(c,h){this.h=c,this.g=h,this.next=null}reset(){this.next=this.g=this.h=null}}let gr,pr=!1,po=new ce,Zc=()=>{let o=u.Promise.resolve(void 0);gr=()=>{o.then(lg)}};var lg=()=>{for(var o;o=_();){try{o.h.call(o.g)}catch(h){A(h)}var c=mr;c.j(o),100>c.h&&(c.h++,o.next=c.g,c.g=o)}pr=!1};function Ee(){this.s=this.s,this.C=this.C}Ee.prototype.s=!1,Ee.prototype.ma=function(){this.s||(this.s=!0,this.N())},Ee.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function bt(o,c){this.type=o,this.g=this.target=c,this.defaultPrevented=!1}bt.prototype.h=function(){this.defaultPrevented=!0};var hg=function(){if(!u.addEventListener||!Object.defineProperty)return!1;var o=!1,c=Object.defineProperty({},"passive",{get:function(){o=!0}});try{let h=()=>{};u.addEventListener("test",h,c),u.removeEventListener("test",h,c)}catch{}return o}();function _r(o,c){if(bt.call(this,o?o.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,o){var h=this.type=o.type,m=o.changedTouches&&o.changedTouches.length?o.changedTouches[0]:null;if(this.target=o.target||o.srcElement,this.g=c,c=o.relatedTarget){if(H){t:{try{Q(c.nodeName);var T=!0;break t}catch{}T=!1}T||(c=null)}}else h=="mouseover"?c=o.fromElement:h=="mouseout"&&(c=o.toElement);this.relatedTarget=c,m?(this.clientX=m.clientX!==void 0?m.clientX:m.pageX,this.clientY=m.clientY!==void 0?m.clientY:m.pageY,this.screenX=m.screenX||0,this.screenY=m.screenY||0):(this.clientX=o.clientX!==void 0?o.clientX:o.pageX,this.clientY=o.clientY!==void 0?o.clientY:o.pageY,this.screenX=o.screenX||0,this.screenY=o.screenY||0),this.button=o.button,this.key=o.key||"",this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.shiftKey=o.shiftKey,this.metaKey=o.metaKey,this.pointerId=o.pointerId||0,this.pointerType=typeof o.pointerType=="string"?o.pointerType:dg[o.pointerType]||"",this.state=o.state,this.i=o,o.defaultPrevented&&_r.aa.h.call(this)}}N(_r,bt);var dg={2:"touch",3:"pen",4:"mouse"};_r.prototype.h=function(){_r.aa.h.call(this);var o=this.i;o.preventDefault?o.preventDefault():o.returnValue=!1};var yr="closure_listenable_"+(1e6*Math.random()|0),fg=0;function mg(o,c,h,m,T){this.listener=o,this.proxy=null,this.src=c,this.type=h,this.capture=!!m,this.ha=T,this.key=++fg,this.da=this.fa=!1}function Ai(o){o.da=!0,o.listener=null,o.proxy=null,o.src=null,o.ha=null}function Si(o){this.src=o,this.g={},this.h=0}Si.prototype.add=function(o,c,h,m,T){var R=o.toString();o=this.g[R],o||(o=this.g[R]=[],this.h++);var F=yo(o,c,m,T);return-1<F?(c=o[F],h||(c.fa=!1)):(c=new mg(c,this.src,R,!!m,T),c.fa=h,o.push(c)),c};function _o(o,c){var h=c.type;if(h in o.g){var m=o.g[h],T=Array.prototype.indexOf.call(m,c,void 0),R;(R=0<=T)&&Array.prototype.splice.call(m,T,1),R&&(Ai(c),o.g[h].length==0&&(delete o.g[h],o.h--))}}function yo(o,c,h,m){for(var T=0;T<o.length;++T){var R=o[T];if(!R.da&&R.listener==c&&R.capture==!!h&&R.ha==m)return T}return-1}var wo="closure_lm_"+(1e6*Math.random()|0),vo={};function tl(o,c,h,m,T){if(m&&m.once)return nl(o,c,h,m,T);if(Array.isArray(c)){for(var R=0;R<c.length;R++)tl(o,c[R],h,m,T);return null}return h=Ao(h),o&&o[yr]?o.K(c,h,d(m)?!!m.capture:!!m,T):el(o,c,h,!1,m,T)}function el(o,c,h,m,T,R){if(!c)throw Error("Invalid event type");var F=d(T)?!!T.capture:!!T,et=Eo(o);if(et||(o[wo]=et=new Si(o)),h=et.add(c,h,m,F,R),h.proxy)return h;if(m=gg(),h.proxy=m,m.src=o,m.listener=h,o.addEventListener)hg||(T=F),T===void 0&&(T=!1),o.addEventListener(c.toString(),m,T);else if(o.attachEvent)o.attachEvent(il(c.toString()),m);else if(o.addListener&&o.removeListener)o.addListener(m);else throw Error("addEventListener and attachEvent are unavailable.");return h}function gg(){function o(h){return c.call(o.src,o.listener,h)}let c=pg;return o}function nl(o,c,h,m,T){if(Array.isArray(c)){for(var R=0;R<c.length;R++)nl(o,c[R],h,m,T);return null}return h=Ao(h),o&&o[yr]?o.L(c,h,d(m)?!!m.capture:!!m,T):el(o,c,h,!0,m,T)}function rl(o,c,h,m,T){if(Array.isArray(c))for(var R=0;R<c.length;R++)rl(o,c[R],h,m,T);else m=d(m)?!!m.capture:!!m,h=Ao(h),o&&o[yr]?(o=o.i,c=String(c).toString(),c in o.g&&(R=o.g[c],h=yo(R,h,m,T),-1<h&&(Ai(R[h]),Array.prototype.splice.call(R,h,1),R.length==0&&(delete o.g[c],o.h--)))):o&&(o=Eo(o))&&(c=o.g[c.toString()],o=-1,c&&(o=yo(c,h,m,T)),(h=-1<o?c[o]:null)&&Io(h))}function Io(o){if(typeof o!="number"&&o&&!o.da){var c=o.src;if(c&&c[yr])_o(c.i,o);else{var h=o.type,m=o.proxy;c.removeEventListener?c.removeEventListener(h,m,o.capture):c.detachEvent?c.detachEvent(il(h),m):c.addListener&&c.removeListener&&c.removeListener(m),(h=Eo(c))?(_o(h,o),h.h==0&&(h.src=null,c[wo]=null)):Ai(o)}}}function il(o){return o in vo?vo[o]:vo[o]="on"+o}function pg(o,c){if(o.da)o=!0;else{c=new _r(c,this);var h=o.listener,m=o.ha||o.src;o.fa&&Io(o),o=h.call(m,c)}return o}function Eo(o){return o=o[wo],o instanceof Si?o:null}var To="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ao(o){return typeof o=="function"?o:(o[To]||(o[To]=function(c){return o.handleEvent(c)}),o[To])}function Rt(){Ee.call(this),this.i=new Si(this),this.M=this,this.F=null}N(Rt,Ee),Rt.prototype[yr]=!0,Rt.prototype.removeEventListener=function(o,c,h,m){rl(this,o,c,h,m)};function Dt(o,c){var h,m=o.F;if(m)for(h=[];m;m=m.F)h.push(m);if(o=o.M,m=c.type||c,typeof c=="string")c=new bt(c,o);else if(c instanceof bt)c.target=c.target||o;else{var T=c;c=new bt(m,o),I(c,T)}if(T=!0,h)for(var R=h.length-1;0<=R;R--){var F=c.g=h[R];T=bi(F,m,!0,c)&&T}if(F=c.g=o,T=bi(F,m,!0,c)&&T,T=bi(F,m,!1,c)&&T,h)for(R=0;R<h.length;R++)F=c.g=h[R],T=bi(F,m,!1,c)&&T}Rt.prototype.N=function(){if(Rt.aa.N.call(this),this.i){var o=this.i,c;for(c in o.g){for(var h=o.g[c],m=0;m<h.length;m++)Ai(h[m]);delete o.g[c],o.h--}}this.F=null},Rt.prototype.K=function(o,c,h,m){return this.i.add(String(o),c,!1,h,m)},Rt.prototype.L=function(o,c,h,m){return this.i.add(String(o),c,!0,h,m)};function bi(o,c,h,m){if(c=o.i.g[String(c)],!c)return!0;c=c.concat();for(var T=!0,R=0;R<c.length;++R){var F=c[R];if(F&&!F.da&&F.capture==h){var et=F.listener,At=F.ha||F.src;F.fa&&_o(o.i,F),T=et.call(At,m)!==!1&&T}}return T&&!m.defaultPrevented}function sl(o,c,h){if(typeof o=="function")h&&(o=y(o,h));else if(o&&typeof o.handleEvent=="function")o=y(o.handleEvent,o);else throw Error("Invalid listener argument");return 2147483647<Number(c)?-1:u.setTimeout(o,c||0)}function ol(o){o.g=sl(()=>{o.g=null,o.i&&(o.i=!1,ol(o))},o.l);let c=o.h;o.h=null,o.m.apply(null,c)}class _g extends Ee{constructor(c,h){super(),this.m=c,this.l=h,this.h=null,this.i=!1,this.g=null}j(c){this.h=arguments,this.g?this.i=!0:ol(this)}N(){super.N(),this.g&&(u.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function wr(o){Ee.call(this),this.h=o,this.g={}}N(wr,Ee);var al=[];function ul(o){z(o.g,function(c,h){this.g.hasOwnProperty(h)&&Io(c)},o),o.g={}}wr.prototype.N=function(){wr.aa.N.call(this),ul(this)},wr.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var So=u.JSON.stringify,yg=u.JSON.parse,wg=class{stringify(o){return u.JSON.stringify(o,void 0)}parse(o){return u.JSON.parse(o,void 0)}};function bo(){}bo.prototype.h=null;function cl(o){return o.h||(o.h=o.i())}function ll(){}var vr={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Ro(){bt.call(this,"d")}N(Ro,bt);function Po(){bt.call(this,"c")}N(Po,bt);var $e={},hl=null;function Ri(){return hl=hl||new Rt}$e.La="serverreachability";function dl(o){bt.call(this,$e.La,o)}N(dl,bt);function Ir(o){let c=Ri();Dt(c,new dl(c))}$e.STAT_EVENT="statevent";function fl(o,c){bt.call(this,$e.STAT_EVENT,o),this.stat=c}N(fl,bt);function Nt(o){let c=Ri();Dt(c,new fl(c,o))}$e.Ma="timingevent";function ml(o,c){bt.call(this,$e.Ma,o),this.size=c}N(ml,bt);function Er(o,c){if(typeof o!="function")throw Error("Fn must not be null and must be a function");return u.setTimeout(function(){o()},c)}function Tr(){this.g=!0}Tr.prototype.xa=function(){this.g=!1};function vg(o,c,h,m,T,R){o.info(function(){if(o.g)if(R)for(var F="",et=R.split("&"),At=0;At<et.length;At++){var Z=et[At].split("=");if(1<Z.length){var Pt=Z[0];Z=Z[1];var Ct=Pt.split("_");F=2<=Ct.length&&Ct[1]=="type"?F+(Pt+"="+Z+"&"):F+(Pt+"=redacted&")}}else F=null;else F=R;return"XMLHTTP REQ ("+m+") [attempt "+T+"]: "+c+`
`+h+`
`+F})}function Ig(o,c,h,m,T,R,F){o.info(function(){return"XMLHTTP RESP ("+m+") [ attempt "+T+"]: "+c+`
`+h+`
`+R+" "+F})}function Tn(o,c,h,m){o.info(function(){return"XMLHTTP TEXT ("+c+"): "+Tg(o,h)+(m?" "+m:"")})}function Eg(o,c){o.info(function(){return"TIMEOUT: "+c})}Tr.prototype.info=function(){};function Tg(o,c){if(!o.g)return c;if(!c)return null;try{var h=JSON.parse(c);if(h){for(o=0;o<h.length;o++)if(Array.isArray(h[o])){var m=h[o];if(!(2>m.length)){var T=m[1];if(Array.isArray(T)&&!(1>T.length)){var R=T[0];if(R!="noop"&&R!="stop"&&R!="close")for(var F=1;F<T.length;F++)T[F]=""}}}}return So(h)}catch{return c}}var Pi={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},gl={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},Co;function Ci(){}N(Ci,bo),Ci.prototype.g=function(){return new XMLHttpRequest},Ci.prototype.i=function(){return{}},Co=new Ci;function Te(o,c,h,m){this.j=o,this.i=c,this.l=h,this.R=m||1,this.U=new wr(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new pl}function pl(){this.i=null,this.g="",this.h=!1}var _l={},xo={};function Vo(o,c,h){o.L=1,o.v=Ni(le(c)),o.m=h,o.P=!0,yl(o,null)}function yl(o,c){o.F=Date.now(),xi(o),o.A=le(o.v);var h=o.A,m=o.R;Array.isArray(m)||(m=[String(m)]),Dl(h.i,"t",m),o.C=0,h=o.j.J,o.h=new pl,o.g=Jl(o.j,h?c:null,!o.m),0<o.O&&(o.M=new _g(y(o.Y,o,o.g),o.O)),c=o.U,h=o.g,m=o.ca;var T="readystatechange";Array.isArray(T)||(T&&(al[0]=T.toString()),T=al);for(var R=0;R<T.length;R++){var F=tl(h,T[R],m||c.handleEvent,!1,c.h||c);if(!F)break;c.g[F.key]=F}c=o.H?p(o.H):{},o.m?(o.u||(o.u="POST"),c["Content-Type"]="application/x-www-form-urlencoded",o.g.ea(o.A,o.u,o.m,c)):(o.u="GET",o.g.ea(o.A,o.u,null,c)),Ir(),vg(o.i,o.u,o.A,o.l,o.R,o.m)}Te.prototype.ca=function(o){o=o.target;let c=this.M;c&&he(o)==3?c.j():this.Y(o)},Te.prototype.Y=function(o){try{if(o==this.g)t:{let Ct=he(this.g);var c=this.g.Ba();let bn=this.g.Z();if(!(3>Ct)&&(Ct!=3||this.g&&(this.h.h||this.g.oa()||ql(this.g)))){this.J||Ct!=4||c==7||(c==8||0>=bn?Ir(3):Ir(2)),Do(this);var h=this.g.Z();this.X=h;e:if(wl(this)){var m=ql(this.g);o="";var T=m.length,R=he(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Qe(this),Ar(this);var F="";break e}this.h.i=new u.TextDecoder}for(c=0;c<T;c++)this.h.h=!0,o+=this.h.i.decode(m[c],{stream:!(R&&c==T-1)});m.length=0,this.h.g+=o,this.C=0,F=this.h.g}else F=this.g.oa();if(this.o=h==200,Ig(this.i,this.u,this.A,this.l,this.R,Ct,h),this.o){if(this.T&&!this.K){e:{if(this.g){var et,At=this.g;if((et=At.g?At.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!j(et)){var Z=et;break e}}Z=null}if(h=Z)Tn(this.i,this.l,h,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,No(this,h);else{this.o=!1,this.s=3,Nt(12),Qe(this),Ar(this);break t}}if(this.P){h=!0;let $t;for(;!this.J&&this.C<F.length;)if($t=Ag(this,F),$t==xo){Ct==4&&(this.s=4,Nt(14),h=!1),Tn(this.i,this.l,null,"[Incomplete Response]");break}else if($t==_l){this.s=4,Nt(15),Tn(this.i,this.l,F,"[Invalid Chunk]"),h=!1;break}else Tn(this.i,this.l,$t,null),No(this,$t);if(wl(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Ct!=4||F.length!=0||this.h.h||(this.s=1,Nt(16),h=!1),this.o=this.o&&h,!h)Tn(this.i,this.l,F,"[Invalid Chunked Response]"),Qe(this),Ar(this);else if(0<F.length&&!this.W){this.W=!0;var Pt=this.j;Pt.g==this&&Pt.ba&&!Pt.M&&(Pt.j.info("Great, no buffering proxy detected. Bytes received: "+F.length),qo(Pt),Pt.M=!0,Nt(11))}}else Tn(this.i,this.l,F,null),No(this,F);Ct==4&&Qe(this),this.o&&!this.J&&(Ct==4?$l(this.j,this):(this.o=!1,xi(this)))}else Bg(this.g),h==400&&0<F.indexOf("Unknown SID")?(this.s=3,Nt(12)):(this.s=0,Nt(13)),Qe(this),Ar(this)}}}catch{}finally{}};function wl(o){return o.g?o.u=="GET"&&o.L!=2&&o.j.Ca:!1}function Ag(o,c){var h=o.C,m=c.indexOf(`
`,h);return m==-1?xo:(h=Number(c.substring(h,m)),isNaN(h)?_l:(m+=1,m+h>c.length?xo:(c=c.slice(m,m+h),o.C=m+h,c)))}Te.prototype.cancel=function(){this.J=!0,Qe(this)};function xi(o){o.S=Date.now()+o.I,vl(o,o.I)}function vl(o,c){if(o.B!=null)throw Error("WatchDog timer not null");o.B=Er(y(o.ba,o),c)}function Do(o){o.B&&(u.clearTimeout(o.B),o.B=null)}Te.prototype.ba=function(){this.B=null;let o=Date.now();0<=o-this.S?(Eg(this.i,this.A),this.L!=2&&(Ir(),Nt(17)),Qe(this),this.s=2,Ar(this)):vl(this,this.S-o)};function Ar(o){o.j.G==0||o.J||$l(o.j,o)}function Qe(o){Do(o);var c=o.M;c&&typeof c.ma=="function"&&c.ma(),o.M=null,ul(o.U),o.g&&(c=o.g,o.g=null,c.abort(),c.ma())}function No(o,c){try{var h=o.j;if(h.G!=0&&(h.g==o||ko(h.h,o))){if(!o.K&&ko(h.h,o)&&h.G==3){try{var m=h.Da.g.parse(c)}catch{m=null}if(Array.isArray(m)&&m.length==3){var T=m;if(T[0]==0){t:if(!h.u){if(h.g)if(h.g.F+3e3<o.F)Li(h),Mi(h);else break t;Lo(h),Nt(18)}}else h.za=T[1],0<h.za-h.T&&37500>T[2]&&h.F&&h.v==0&&!h.C&&(h.C=Er(y(h.Za,h),6e3));if(1>=Tl(h.h)&&h.ca){try{h.ca()}catch{}h.ca=void 0}}else He(h,11)}else if((o.K||h.g==o)&&Li(h),!j(c))for(T=h.Da.g.parse(c),c=0;c<T.length;c++){let Z=T[c];if(h.T=Z[0],Z=Z[1],h.G==2)if(Z[0]=="c"){h.K=Z[1],h.ia=Z[2];let Pt=Z[3];Pt!=null&&(h.la=Pt,h.j.info("VER="+h.la));let Ct=Z[4];Ct!=null&&(h.Aa=Ct,h.j.info("SVER="+h.Aa));let bn=Z[5];bn!=null&&typeof bn=="number"&&0<bn&&(m=1.5*bn,h.L=m,h.j.info("backChannelRequestTimeoutMs_="+m)),m=h;let $t=o.g;if($t){let Ui=$t.g?$t.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Ui){var R=m.h;R.g||Ui.indexOf("spdy")==-1&&Ui.indexOf("quic")==-1&&Ui.indexOf("h2")==-1||(R.j=R.l,R.g=new Set,R.h&&(Fo(R,R.h),R.h=null))}if(m.D){let Uo=$t.g?$t.g.getResponseHeader("X-HTTP-Session-Id"):null;Uo&&(m.ya=Uo,it(m.I,m.D,Uo))}}h.G=3,h.l&&h.l.ua(),h.ba&&(h.R=Date.now()-o.F,h.j.info("Handshake RTT: "+h.R+"ms")),m=h;var F=o;if(m.qa=Hl(m,m.J?m.ia:null,m.W),F.K){Al(m.h,F);var et=F,At=m.L;At&&(et.I=At),et.B&&(Do(et),xi(et)),m.g=F}else zl(m);0<h.i.length&&Oi(h)}else Z[0]!="stop"&&Z[0]!="close"||He(h,7);else h.G==3&&(Z[0]=="stop"||Z[0]=="close"?Z[0]=="stop"?He(h,7):Oo(h):Z[0]!="noop"&&h.l&&h.l.ta(Z),h.v=0)}}Ir(4)}catch{}}var Sg=class{constructor(o,c){this.g=o,this.map=c}};function Il(o){this.l=o||10,u.PerformanceNavigationTiming?(o=u.performance.getEntriesByType("navigation"),o=0<o.length&&(o[0].nextHopProtocol=="hq"||o[0].nextHopProtocol=="h2")):o=!!(u.chrome&&u.chrome.loadTimes&&u.chrome.loadTimes()&&u.chrome.loadTimes().wasFetchedViaSpdy),this.j=o?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function El(o){return o.h?!0:o.g?o.g.size>=o.j:!1}function Tl(o){return o.h?1:o.g?o.g.size:0}function ko(o,c){return o.h?o.h==c:o.g?o.g.has(c):!1}function Fo(o,c){o.g?o.g.add(c):o.h=c}function Al(o,c){o.h&&o.h==c?o.h=null:o.g&&o.g.has(c)&&o.g.delete(c)}Il.prototype.cancel=function(){if(this.i=Sl(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let o of this.g.values())o.cancel();this.g.clear()}};function Sl(o){if(o.h!=null)return o.i.concat(o.h.D);if(o.g!=null&&o.g.size!==0){let c=o.i;for(let h of o.g.values())c=c.concat(h.D);return c}return k(o.i)}function bg(o){if(o.V&&typeof o.V=="function")return o.V();if(typeof Map<"u"&&o instanceof Map||typeof Set<"u"&&o instanceof Set)return Array.from(o.values());if(typeof o=="string")return o.split("");if(l(o)){for(var c=[],h=o.length,m=0;m<h;m++)c.push(o[m]);return c}c=[],h=0;for(m in o)c[h++]=o[m];return c}function Rg(o){if(o.na&&typeof o.na=="function")return o.na();if(!o.V||typeof o.V!="function"){if(typeof Map<"u"&&o instanceof Map)return Array.from(o.keys());if(!(typeof Set<"u"&&o instanceof Set)){if(l(o)||typeof o=="string"){var c=[];o=o.length;for(var h=0;h<o;h++)c.push(h);return c}c=[],h=0;for(let m in o)c[h++]=m;return c}}}function bl(o,c){if(o.forEach&&typeof o.forEach=="function")o.forEach(c,void 0);else if(l(o)||typeof o=="string")Array.prototype.forEach.call(o,c,void 0);else for(var h=Rg(o),m=bg(o),T=m.length,R=0;R<T;R++)c.call(void 0,m[R],h&&h[R],o)}var Rl=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Pg(o,c){if(o){o=o.split("&");for(var h=0;h<o.length;h++){var m=o[h].indexOf("="),T=null;if(0<=m){var R=o[h].substring(0,m);T=o[h].substring(m+1)}else R=o[h];c(R,T?decodeURIComponent(T.replace(/\+/g," ")):"")}}}function We(o){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,o instanceof We){this.h=o.h,Vi(this,o.j),this.o=o.o,this.g=o.g,Di(this,o.s),this.l=o.l;var c=o.i,h=new Rr;h.i=c.i,c.g&&(h.g=new Map(c.g),h.h=c.h),Pl(this,h),this.m=o.m}else o&&(c=String(o).match(Rl))?(this.h=!1,Vi(this,c[1]||"",!0),this.o=Sr(c[2]||""),this.g=Sr(c[3]||"",!0),Di(this,c[4]),this.l=Sr(c[5]||"",!0),Pl(this,c[6]||"",!0),this.m=Sr(c[7]||"")):(this.h=!1,this.i=new Rr(null,this.h))}We.prototype.toString=function(){var o=[],c=this.j;c&&o.push(br(c,Cl,!0),":");var h=this.g;return(h||c=="file")&&(o.push("//"),(c=this.o)&&o.push(br(c,Cl,!0),"@"),o.push(encodeURIComponent(String(h)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),h=this.s,h!=null&&o.push(":",String(h))),(h=this.l)&&(this.g&&h.charAt(0)!="/"&&o.push("/"),o.push(br(h,h.charAt(0)=="/"?Vg:xg,!0))),(h=this.i.toString())&&o.push("?",h),(h=this.m)&&o.push("#",br(h,Ng)),o.join("")};function le(o){return new We(o)}function Vi(o,c,h){o.j=h?Sr(c,!0):c,o.j&&(o.j=o.j.replace(/:$/,""))}function Di(o,c){if(c){if(c=Number(c),isNaN(c)||0>c)throw Error("Bad port number "+c);o.s=c}else o.s=null}function Pl(o,c,h){c instanceof Rr?(o.i=c,kg(o.i,o.h)):(h||(c=br(c,Dg)),o.i=new Rr(c,o.h))}function it(o,c,h){o.i.set(c,h)}function Ni(o){return it(o,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),o}function Sr(o,c){return o?c?decodeURI(o.replace(/%25/g,"%2525")):decodeURIComponent(o):""}function br(o,c,h){return typeof o=="string"?(o=encodeURI(o).replace(c,Cg),h&&(o=o.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),o):null}function Cg(o){return o=o.charCodeAt(0),"%"+(o>>4&15).toString(16)+(o&15).toString(16)}var Cl=/[#\/\?@]/g,xg=/[#\?:]/g,Vg=/[#\?]/g,Dg=/[#\?@]/g,Ng=/#/g;function Rr(o,c){this.h=this.g=null,this.i=o||null,this.j=!!c}function Ae(o){o.g||(o.g=new Map,o.h=0,o.i&&Pg(o.i,function(c,h){o.add(decodeURIComponent(c.replace(/\+/g," ")),h)}))}r=Rr.prototype,r.add=function(o,c){Ae(this),this.i=null,o=An(this,o);var h=this.g.get(o);return h||this.g.set(o,h=[]),h.push(c),this.h+=1,this};function xl(o,c){Ae(o),c=An(o,c),o.g.has(c)&&(o.i=null,o.h-=o.g.get(c).length,o.g.delete(c))}function Vl(o,c){return Ae(o),c=An(o,c),o.g.has(c)}r.forEach=function(o,c){Ae(this),this.g.forEach(function(h,m){h.forEach(function(T){o.call(c,T,m,this)},this)},this)},r.na=function(){Ae(this);let o=Array.from(this.g.values()),c=Array.from(this.g.keys()),h=[];for(let m=0;m<c.length;m++){let T=o[m];for(let R=0;R<T.length;R++)h.push(c[m])}return h},r.V=function(o){Ae(this);let c=[];if(typeof o=="string")Vl(this,o)&&(c=c.concat(this.g.get(An(this,o))));else{o=Array.from(this.g.values());for(let h=0;h<o.length;h++)c=c.concat(o[h])}return c},r.set=function(o,c){return Ae(this),this.i=null,o=An(this,o),Vl(this,o)&&(this.h-=this.g.get(o).length),this.g.set(o,[c]),this.h+=1,this},r.get=function(o,c){return o?(o=this.V(o),0<o.length?String(o[0]):c):c};function Dl(o,c,h){xl(o,c),0<h.length&&(o.i=null,o.g.set(An(o,c),k(h)),o.h+=h.length)}r.toString=function(){if(this.i)return this.i;if(!this.g)return"";let o=[],c=Array.from(this.g.keys());for(var h=0;h<c.length;h++){var m=c[h];let R=encodeURIComponent(String(m)),F=this.V(m);for(m=0;m<F.length;m++){var T=R;F[m]!==""&&(T+="="+encodeURIComponent(String(F[m]))),o.push(T)}}return this.i=o.join("&")};function An(o,c){return c=String(c),o.j&&(c=c.toLowerCase()),c}function kg(o,c){c&&!o.j&&(Ae(o),o.i=null,o.g.forEach(function(h,m){var T=m.toLowerCase();m!=T&&(xl(this,m),Dl(this,T,h))},o)),o.j=c}function Fg(o,c){let h=new Tr;if(u.Image){let m=new Image;m.onload=S(Se,h,"TestLoadImage: loaded",!0,c,m),m.onerror=S(Se,h,"TestLoadImage: error",!1,c,m),m.onabort=S(Se,h,"TestLoadImage: abort",!1,c,m),m.ontimeout=S(Se,h,"TestLoadImage: timeout",!1,c,m),u.setTimeout(function(){m.ontimeout&&m.ontimeout()},1e4),m.src=o}else c(!1)}function Mg(o,c){let h=new Tr,m=new AbortController,T=setTimeout(()=>{m.abort(),Se(h,"TestPingServer: timeout",!1,c)},1e4);fetch(o,{signal:m.signal}).then(R=>{clearTimeout(T),R.ok?Se(h,"TestPingServer: ok",!0,c):Se(h,"TestPingServer: server error",!1,c)}).catch(()=>{clearTimeout(T),Se(h,"TestPingServer: error",!1,c)})}function Se(o,c,h,m,T){try{T&&(T.onload=null,T.onerror=null,T.onabort=null,T.ontimeout=null),m(h)}catch{}}function Og(){this.g=new wg}function Lg(o,c,h){let m=h||"";try{bl(o,function(T,R){let F=T;d(T)&&(F=So(T)),c.push(m+R+"="+encodeURIComponent(F))})}catch(T){throw c.push(m+"type="+encodeURIComponent("_badmap")),T}}function Pr(o){this.l=o.Ub||null,this.j=o.eb||!1}N(Pr,bo),Pr.prototype.g=function(){return new ki(this.l,this.j)},Pr.prototype.i=function(o){return function(){return o}}({});function ki(o,c){Rt.call(this),this.D=o,this.o=c,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}N(ki,Rt),r=ki.prototype,r.open=function(o,c){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=o,this.A=c,this.readyState=1,xr(this)},r.send=function(o){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let c={headers:this.u,method:this.B,credentials:this.m,cache:void 0};o&&(c.body=o),(this.D||u).fetch(new Request(this.A,c)).then(this.Sa.bind(this),this.ga.bind(this))},r.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,Cr(this)),this.readyState=0},r.Sa=function(o){if(this.g&&(this.l=o,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=o.headers,this.readyState=2,xr(this)),this.g&&(this.readyState=3,xr(this),this.g)))if(this.responseType==="arraybuffer")o.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof u.ReadableStream<"u"&&"body"in o){if(this.j=o.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Nl(this)}else o.text().then(this.Ra.bind(this),this.ga.bind(this))};function Nl(o){o.j.read().then(o.Pa.bind(o)).catch(o.ga.bind(o))}r.Pa=function(o){if(this.g){if(this.o&&o.value)this.response.push(o.value);else if(!this.o){var c=o.value?o.value:new Uint8Array(0);(c=this.v.decode(c,{stream:!o.done}))&&(this.response=this.responseText+=c)}o.done?Cr(this):xr(this),this.readyState==3&&Nl(this)}},r.Ra=function(o){this.g&&(this.response=this.responseText=o,Cr(this))},r.Qa=function(o){this.g&&(this.response=o,Cr(this))},r.ga=function(){this.g&&Cr(this)};function Cr(o){o.readyState=4,o.l=null,o.j=null,o.v=null,xr(o)}r.setRequestHeader=function(o,c){this.u.append(o,c)},r.getResponseHeader=function(o){return this.h&&this.h.get(o.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";let o=[],c=this.h.entries();for(var h=c.next();!h.done;)h=h.value,o.push(h[0]+": "+h[1]),h=c.next();return o.join(`\r
`)};function xr(o){o.onreadystatechange&&o.onreadystatechange.call(o)}Object.defineProperty(ki.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(o){this.m=o?"include":"same-origin"}});function kl(o){let c="";return z(o,function(h,m){c+=m,c+=":",c+=h,c+=`\r
`}),c}function Mo(o,c,h){t:{for(m in h){var m=!1;break t}m=!0}m||(h=kl(h),typeof o=="string"?h!=null&&encodeURIComponent(String(h)):it(o,c,h))}function ut(o){Rt.call(this),this.headers=new Map,this.o=o||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}N(ut,Rt);var qg=/^https?$/i,Ug=["POST","PUT"];r=ut.prototype,r.Ha=function(o){this.J=o},r.ea=function(o,c,h,m){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+o);c=c?c.toUpperCase():"GET",this.D=o,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Co.g(),this.v=this.o?cl(this.o):cl(Co),this.g.onreadystatechange=y(this.Ea,this);try{this.B=!0,this.g.open(c,String(o),!0),this.B=!1}catch(R){Fl(this,R);return}if(o=h||"",h=new Map(this.headers),m)if(Object.getPrototypeOf(m)===Object.prototype)for(var T in m)h.set(T,m[T]);else if(typeof m.keys=="function"&&typeof m.get=="function")for(let R of m.keys())h.set(R,m.get(R));else throw Error("Unknown input type for opt_headers: "+String(m));m=Array.from(h.keys()).find(R=>R.toLowerCase()=="content-type"),T=u.FormData&&o instanceof u.FormData,!(0<=Array.prototype.indexOf.call(Ug,c,void 0))||m||T||h.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[R,F]of h)this.g.setRequestHeader(R,F);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Ll(this),this.u=!0,this.g.send(o),this.u=!1}catch(R){Fl(this,R)}};function Fl(o,c){o.h=!1,o.g&&(o.j=!0,o.g.abort(),o.j=!1),o.l=c,o.m=5,Ml(o),Fi(o)}function Ml(o){o.A||(o.A=!0,Dt(o,"complete"),Dt(o,"error"))}r.abort=function(o){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=o||7,Dt(this,"complete"),Dt(this,"abort"),Fi(this))},r.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Fi(this,!0)),ut.aa.N.call(this)},r.Ea=function(){this.s||(this.B||this.u||this.j?Ol(this):this.bb())},r.bb=function(){Ol(this)};function Ol(o){if(o.h&&typeof a<"u"&&(!o.v[1]||he(o)!=4||o.Z()!=2)){if(o.u&&he(o)==4)sl(o.Ea,0,o);else if(Dt(o,"readystatechange"),he(o)==4){o.h=!1;try{let F=o.Z();t:switch(F){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var c=!0;break t;default:c=!1}var h;if(!(h=c)){var m;if(m=F===0){var T=String(o.D).match(Rl)[1]||null;!T&&u.self&&u.self.location&&(T=u.self.location.protocol.slice(0,-1)),m=!qg.test(T?T.toLowerCase():"")}h=m}if(h)Dt(o,"complete"),Dt(o,"success");else{o.m=6;try{var R=2<he(o)?o.g.statusText:""}catch{R=""}o.l=R+" ["+o.Z()+"]",Ml(o)}}finally{Fi(o)}}}}function Fi(o,c){if(o.g){Ll(o);let h=o.g,m=o.v[0]?()=>{}:null;o.g=null,o.v=null,c||Dt(o,"ready");try{h.onreadystatechange=m}catch{}}}function Ll(o){o.I&&(u.clearTimeout(o.I),o.I=null)}r.isActive=function(){return!!this.g};function he(o){return o.g?o.g.readyState:0}r.Z=function(){try{return 2<he(this)?this.g.status:-1}catch{return-1}},r.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},r.Oa=function(o){if(this.g){var c=this.g.responseText;return o&&c.indexOf(o)==0&&(c=c.substring(o.length)),yg(c)}};function ql(o){try{if(!o.g)return null;if("response"in o.g)return o.g.response;switch(o.H){case"":case"text":return o.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in o.g)return o.g.mozResponseArrayBuffer}return null}catch{return null}}function Bg(o){let c={};o=(o.g&&2<=he(o)&&o.g.getAllResponseHeaders()||"").split(`\r
`);for(let m=0;m<o.length;m++){if(j(o[m]))continue;var h=E(o[m]);let T=h[0];if(h=h[1],typeof h!="string")continue;h=h.trim();let R=c[T]||[];c[T]=R,R.push(h)}v(c,function(m){return m.join(", ")})}r.Ba=function(){return this.m},r.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function Vr(o,c,h){return h&&h.internalChannelParams&&h.internalChannelParams[o]||c}function Ul(o){this.Aa=0,this.i=[],this.j=new Tr,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Vr("failFast",!1,o),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Vr("baseRetryDelayMs",5e3,o),this.cb=Vr("retryDelaySeedMs",1e4,o),this.Wa=Vr("forwardChannelMaxRetries",2,o),this.wa=Vr("forwardChannelRequestTimeoutMs",2e4,o),this.pa=o&&o.xmlHttpFactory||void 0,this.Xa=o&&o.Tb||void 0,this.Ca=o&&o.useFetchStreams||!1,this.L=void 0,this.J=o&&o.supportsCrossDomainXhr||!1,this.K="",this.h=new Il(o&&o.concurrentRequestLimit),this.Da=new Og,this.P=o&&o.fastHandshake||!1,this.O=o&&o.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=o&&o.Rb||!1,o&&o.xa&&this.j.xa(),o&&o.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&o&&o.detectBufferingProxy||!1,this.ja=void 0,o&&o.longPollingTimeout&&0<o.longPollingTimeout&&(this.ja=o.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}r=Ul.prototype,r.la=8,r.G=1,r.connect=function(o,c,h,m){Nt(0),this.W=o,this.H=c||{},h&&m!==void 0&&(this.H.OSID=h,this.H.OAID=m),this.F=this.X,this.I=Hl(this,null,this.W),Oi(this)};function Oo(o){if(Bl(o),o.G==3){var c=o.U++,h=le(o.I);if(it(h,"SID",o.K),it(h,"RID",c),it(h,"TYPE","terminate"),Dr(o,h),c=new Te(o,o.j,c),c.L=2,c.v=Ni(le(h)),h=!1,u.navigator&&u.navigator.sendBeacon)try{h=u.navigator.sendBeacon(c.v.toString(),"")}catch{}!h&&u.Image&&(new Image().src=c.v,h=!0),h||(c.g=Jl(c.j,null),c.g.ea(c.v)),c.F=Date.now(),xi(c)}Wl(o)}function Mi(o){o.g&&(qo(o),o.g.cancel(),o.g=null)}function Bl(o){Mi(o),o.u&&(u.clearTimeout(o.u),o.u=null),Li(o),o.h.cancel(),o.s&&(typeof o.s=="number"&&u.clearTimeout(o.s),o.s=null)}function Oi(o){if(!El(o.h)&&!o.s){o.s=!0;var c=o.Ga;gr||Zc(),pr||(gr(),pr=!0),po.add(c,o),o.B=0}}function Gg(o,c){return Tl(o.h)>=o.h.j-(o.s?1:0)?!1:o.s?(o.i=c.D.concat(o.i),!0):o.G==1||o.G==2||o.B>=(o.Va?0:o.Wa)?!1:(o.s=Er(y(o.Ga,o,c),Ql(o,o.B)),o.B++,!0)}r.Ga=function(o){if(this.s)if(this.s=null,this.G==1){if(!o){this.U=Math.floor(1e5*Math.random()),o=this.U++;let T=new Te(this,this.j,o),R=this.o;if(this.S&&(R?(R=p(R),I(R,this.S)):R=this.S),this.m!==null||this.O||(T.H=R,R=null),this.P)t:{for(var c=0,h=0;h<this.i.length;h++){e:{var m=this.i[h];if("__data__"in m.map&&(m=m.map.__data__,typeof m=="string")){m=m.length;break e}m=void 0}if(m===void 0)break;if(c+=m,4096<c){c=h;break t}if(c===4096||h===this.i.length-1){c=h+1;break t}}c=1e3}else c=1e3;c=jl(this,T,c),h=le(this.I),it(h,"RID",o),it(h,"CVER",22),this.D&&it(h,"X-HTTP-Session-Id",this.D),Dr(this,h),R&&(this.O?c="headers="+encodeURIComponent(String(kl(R)))+"&"+c:this.m&&Mo(h,this.m,R)),Fo(this.h,T),this.Ua&&it(h,"TYPE","init"),this.P?(it(h,"$req",c),it(h,"SID","null"),T.T=!0,Vo(T,h,null)):Vo(T,h,c),this.G=2}}else this.G==3&&(o?Gl(this,o):this.i.length==0||El(this.h)||Gl(this))};function Gl(o,c){var h;c?h=c.l:h=o.U++;let m=le(o.I);it(m,"SID",o.K),it(m,"RID",h),it(m,"AID",o.T),Dr(o,m),o.m&&o.o&&Mo(m,o.m,o.o),h=new Te(o,o.j,h,o.B+1),o.m===null&&(h.H=o.o),c&&(o.i=c.D.concat(o.i)),c=jl(o,h,1e3),h.I=Math.round(.5*o.wa)+Math.round(.5*o.wa*Math.random()),Fo(o.h,h),Vo(h,m,c)}function Dr(o,c){o.H&&z(o.H,function(h,m){it(c,m,h)}),o.l&&bl({},function(h,m){it(c,m,h)})}function jl(o,c,h){h=Math.min(o.i.length,h);var m=o.l?y(o.l.Na,o.l,o):null;t:{var T=o.i;let R=-1;for(;;){let F=["count="+h];R==-1?0<h?(R=T[0].g,F.push("ofs="+R)):R=0:F.push("ofs="+R);let et=!0;for(let At=0;At<h;At++){let Z=T[At].g,Pt=T[At].map;if(Z-=R,0>Z)R=Math.max(0,T[At].g-100),et=!1;else try{Lg(Pt,F,"req"+Z+"_")}catch{m&&m(Pt)}}if(et){m=F.join("&");break t}}}return o=o.i.splice(0,h),c.D=o,m}function zl(o){if(!o.g&&!o.u){o.Y=1;var c=o.Fa;gr||Zc(),pr||(gr(),pr=!0),po.add(c,o),o.v=0}}function Lo(o){return o.g||o.u||3<=o.v?!1:(o.Y++,o.u=Er(y(o.Fa,o),Ql(o,o.v)),o.v++,!0)}r.Fa=function(){if(this.u=null,Kl(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var o=2*this.R;this.j.info("BP detection timer enabled: "+o),this.A=Er(y(this.ab,this),o)}},r.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Nt(10),Mi(this),Kl(this))};function qo(o){o.A!=null&&(u.clearTimeout(o.A),o.A=null)}function Kl(o){o.g=new Te(o,o.j,"rpc",o.Y),o.m===null&&(o.g.H=o.o),o.g.O=0;var c=le(o.qa);it(c,"RID","rpc"),it(c,"SID",o.K),it(c,"AID",o.T),it(c,"CI",o.F?"0":"1"),!o.F&&o.ja&&it(c,"TO",o.ja),it(c,"TYPE","xmlhttp"),Dr(o,c),o.m&&o.o&&Mo(c,o.m,o.o),o.L&&(o.g.I=o.L);var h=o.g;o=o.ia,h.L=1,h.v=Ni(le(c)),h.m=null,h.P=!0,yl(h,o)}r.Za=function(){this.C!=null&&(this.C=null,Mi(this),Lo(this),Nt(19))};function Li(o){o.C!=null&&(u.clearTimeout(o.C),o.C=null)}function $l(o,c){var h=null;if(o.g==c){Li(o),qo(o),o.g=null;var m=2}else if(ko(o.h,c))h=c.D,Al(o.h,c),m=1;else return;if(o.G!=0){if(c.o)if(m==1){h=c.m?c.m.length:0,c=Date.now()-c.F;var T=o.B;m=Ri(),Dt(m,new ml(m,h)),Oi(o)}else zl(o);else if(T=c.s,T==3||T==0&&0<c.X||!(m==1&&Gg(o,c)||m==2&&Lo(o)))switch(h&&0<h.length&&(c=o.h,c.i=c.i.concat(h)),T){case 1:He(o,5);break;case 4:He(o,10);break;case 3:He(o,6);break;default:He(o,2)}}}function Ql(o,c){let h=o.Ta+Math.floor(Math.random()*o.cb);return o.isActive()||(h*=2),h*c}function He(o,c){if(o.j.info("Error code "+c),c==2){var h=y(o.fb,o),m=o.Xa;let T=!m;m=new We(m||"//www.google.com/images/cleardot.gif"),u.location&&u.location.protocol=="http"||Vi(m,"https"),Ni(m),T?Fg(m.toString(),h):Mg(m.toString(),h)}else Nt(2);o.G=0,o.l&&o.l.sa(c),Wl(o),Bl(o)}r.fb=function(o){o?(this.j.info("Successfully pinged google.com"),Nt(2)):(this.j.info("Failed to ping google.com"),Nt(1))};function Wl(o){if(o.G=0,o.ka=[],o.l){let c=Sl(o.h);(c.length!=0||o.i.length!=0)&&(D(o.ka,c),D(o.ka,o.i),o.h.i.length=0,k(o.i),o.i.length=0),o.l.ra()}}function Hl(o,c,h){var m=h instanceof We?le(h):new We(h);if(m.g!="")c&&(m.g=c+"."+m.g),Di(m,m.s);else{var T=u.location;m=T.protocol,c=c?c+"."+T.hostname:T.hostname,T=+T.port;var R=new We(null);m&&Vi(R,m),c&&(R.g=c),T&&Di(R,T),h&&(R.l=h),m=R}return h=o.D,c=o.ya,h&&c&&it(m,h,c),it(m,"VER",o.la),Dr(o,m),m}function Jl(o,c,h){if(c&&!o.J)throw Error("Can't create secondary domain capable XhrIo object.");return c=o.Ca&&!o.pa?new ut(new Pr({eb:h})):new ut(o.pa),c.Ha(o.J),c}r.isActive=function(){return!!this.l&&this.l.isActive(this)};function Yl(){}r=Yl.prototype,r.ua=function(){},r.ta=function(){},r.sa=function(){},r.ra=function(){},r.isActive=function(){return!0},r.Na=function(){};function qi(){}qi.prototype.g=function(o,c){return new Lt(o,c)};function Lt(o,c){Rt.call(this),this.g=new Ul(c),this.l=o,this.h=c&&c.messageUrlParams||null,o=c&&c.messageHeaders||null,c&&c.clientProtocolHeaderRequired&&(o?o["X-Client-Protocol"]="webchannel":o={"X-Client-Protocol":"webchannel"}),this.g.o=o,o=c&&c.initMessageHeaders||null,c&&c.messageContentType&&(o?o["X-WebChannel-Content-Type"]=c.messageContentType:o={"X-WebChannel-Content-Type":c.messageContentType}),c&&c.va&&(o?o["X-WebChannel-Client-Profile"]=c.va:o={"X-WebChannel-Client-Profile":c.va}),this.g.S=o,(o=c&&c.Sb)&&!j(o)&&(this.g.m=o),this.v=c&&c.supportsCrossDomainXhr||!1,this.u=c&&c.sendRawJson||!1,(c=c&&c.httpSessionIdParam)&&!j(c)&&(this.g.D=c,o=this.h,o!==null&&c in o&&(o=this.h,c in o&&delete o[c])),this.j=new Sn(this)}N(Lt,Rt),Lt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Lt.prototype.close=function(){Oo(this.g)},Lt.prototype.o=function(o){var c=this.g;if(typeof o=="string"){var h={};h.__data__=o,o=h}else this.u&&(h={},h.__data__=So(o),o=h);c.i.push(new Sg(c.Ya++,o)),c.G==3&&Oi(c)},Lt.prototype.N=function(){this.g.l=null,delete this.j,Oo(this.g),delete this.g,Lt.aa.N.call(this)};function Xl(o){Ro.call(this),o.__headers__&&(this.headers=o.__headers__,this.statusCode=o.__status__,delete o.__headers__,delete o.__status__);var c=o.__sm__;if(c){t:{for(let h in c){o=h;break t}o=void 0}(this.i=o)&&(o=this.i,c=c!==null&&o in c?c[o]:void 0),this.data=c}else this.data=o}N(Xl,Ro);function Zl(){Po.call(this),this.status=1}N(Zl,Po);function Sn(o){this.g=o}N(Sn,Yl),Sn.prototype.ua=function(){Dt(this.g,"a")},Sn.prototype.ta=function(o){Dt(this.g,new Xl(o))},Sn.prototype.sa=function(o){Dt(this.g,new Zl)},Sn.prototype.ra=function(){Dt(this.g,"b")},qi.prototype.createWebChannel=qi.prototype.g,Lt.prototype.send=Lt.prototype.o,Lt.prototype.open=Lt.prototype.m,Lt.prototype.close=Lt.prototype.close,ea=de.createWebChannelTransport=function(){return new qi},ta=de.getStatEventTarget=function(){return Ri()},Zo=de.Event=$e,Qi=de.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Pi.NO_ERROR=0,Pi.TIMEOUT=8,Pi.HTTP_ERROR=6,Mr=de.ErrorCode=Pi,gl.COMPLETE="complete",Xo=de.EventType=gl,ll.EventType=vr,vr.OPEN="a",vr.CLOSE="b",vr.ERROR="c",vr.MESSAGE="d",Rt.prototype.listen=Rt.prototype.K,Rn=de.WebChannel=ll,Yo=de.FetchXmlHttpFactory=Pr,ut.prototype.listenOnce=ut.prototype.L,ut.prototype.getLastError=ut.prototype.Ka,ut.prototype.getLastErrorCode=ut.prototype.Ba,ut.prototype.getStatus=ut.prototype.Z,ut.prototype.getResponseJson=ut.prototype.Oa,ut.prototype.getResponseText=ut.prototype.oa,ut.prototype.send=ut.prototype.ea,ut.prototype.setWithCredentials=ut.prototype.Ha,Jo=de.XhrIo=ut}).apply(typeof $i<"u"?$i:typeof self<"u"?self:typeof window<"u"?window:{});var Dh="@firebase/firestore";var _t=class{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}};_t.UNAUTHENTICATED=new _t(null),_t.GOOGLE_CREDENTIALS=new _t("google-credentials-uid"),_t.FIRST_PARTY=new _t("first-party-uid"),_t.MOCK_USER=new _t("mock-user");var ir="10.12.0";var Ne=new hh("@firebase/firestore");function Dn(){return Ne.logLevel}function Dd(r){Ne.setLogLevel(r)}function V(r,...t){if(Ne.logLevel<=Xt.DEBUG){let e=t.map(ic);Ne.debug(`Firestore (${ir}): ${r}`,...e)}}function dt(r,...t){if(Ne.logLevel<=Xt.ERROR){let e=t.map(ic);Ne.error(`Firestore (${ir}): ${r}`,...e)}}function jt(r,...t){if(Ne.logLevel<=Xt.WARN){let e=t.map(ic);Ne.warn(`Firestore (${ir}): ${r}`,...e)}}function ic(r){if(typeof r=="string")return r;try{return function(e){return JSON.stringify(e)}(r)}catch{return r}}function L(r="Unexpected state"){let t=`FIRESTORE (${ir}) INTERNAL ASSERTION FAILED: `+r;throw dt(t),new Error(t)}function q(r,t){r||L()}function Nd(r,t){r||L()}function O(r,t){return r}var P={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},x=class extends lh{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var yt=class{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}};var is=class{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}},oa=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(_t.UNAUTHENTICATED))}shutdown(){}},aa=class{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}},ua=class{constructor(t){this.t=t,this.currentUser=_t.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i,i=l=>this.i!==n?(n=this.i,e(l)):Promise.resolve(),s=new yt;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new yt,t.enqueueRetryable(()=>i(this.currentUser))};let a=()=>{let l=s;t.enqueueRetryable(()=>C(this,null,function*(){yield l.promise,yield i(this.currentUser)}))},u=l=>{V("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=l,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(l=>u(l)),setTimeout(()=>{if(!this.auth){let l=this.t.getImmediate({optional:!0});l?u(l):(V("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new yt)}},0),a()}getToken(){let t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(n=>this.i!==t?(V("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):n?(q(typeof n.accessToken=="string"),new is(n.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){let t=this.auth&&this.auth.getUid();return q(t===null||typeof t=="string"),new _t(t)}},ca=class{constructor(t,e,n){this.l=t,this.h=e,this.P=n,this.type="FirstParty",this.user=_t.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},la=class{constructor(t,e,n){this.l=t,this.h=e,this.P=n}getToken(){return Promise.resolve(new ca(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable(()=>e(_t.FIRST_PARTY))}shutdown(){}invalidateToken(){}},ha=class{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},da=class{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){let n=s=>{s.error!=null&&V("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let a=s.token!==this.R;return this.R=s.token,V("FirebaseAppCheckTokenProvider",`Received ${a?"new":"existing"} token.`),a?e(s.token):Promise.resolve()};this.o=s=>{t.enqueueRetryable(()=>n(s))};let i=s=>{V("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):V("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(q(typeof e.token=="string"),this.R=e.token,new ha(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}};function jg(r){let t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(r);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let n=0;n<r;n++)e[n]=Math.floor(256*Math.random());return e}var ss=class{static newId(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length,n="";for(;n.length<20;){let i=jg(40);for(let s=0;s<i.length;++s)n.length<20&&i[s]<e&&(n+=t.charAt(i[s]%t.length))}return n}};function K(r,t){return r<t?-1:r>t?1:0}function Bn(r,t,e){return r.length===t.length&&r.every((n,i)=>e(n,t[i]))}function kd(r){return r+"\0"}var at=class r{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new x(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new x(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new x(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new x(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return r.fromMillis(Date.now())}static fromDate(t){return r.fromMillis(t.getTime())}static fromMillis(t){let e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new r(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?K(this.nanoseconds,t.nanoseconds):K(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var B=class r{constructor(t){this.timestamp=t}static fromTimestamp(t){return new r(t)}static min(){return new r(new at(0,0))}static max(){return new r(new at(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var os=class r{constructor(t,e,n){e===void 0?e=0:e>t.length&&L(),n===void 0?n=t.length-e:n>t.length-e&&L(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return r.comparator(this,t)===0}child(t){let e=this.segments.slice(this.offset,this.limit());return t instanceof r?t.forEach(n=>{e.push(n)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){let n=Math.min(t.length,e.length);for(let i=0;i<n;i++){let s=t.get(i),a=e.get(i);if(s<a)return-1;if(s>a)return 1}return t.length<e.length?-1:t.length>e.length?1:0}},Y=class r extends os{construct(t,e,n){return new r(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){let e=[];for(let n of t){if(n.indexOf("//")>=0)throw new x(P.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter(i=>i.length>0))}return new r(e)}static emptyPath(){return new r([])}},zg=/^[_a-zA-Z][_a-zA-Z0-9]*$/,ft=class r extends os{construct(t,e,n){return new r(t,e,n)}static isValidIdentifier(t){return zg.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),r.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new r(["__name__"])}static fromServerFormat(t){let e=[],n="",i=0,s=()=>{if(n.length===0)throw new x(P.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""},a=!1;for(;i<t.length;){let u=t[i];if(u==="\\"){if(i+1===t.length)throw new x(P.INVALID_ARGUMENT,"Path has trailing escape character: "+t);let l=t[i+1];if(l!=="\\"&&l!=="."&&l!=="`")throw new x(P.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=l,i+=2}else u==="`"?(a=!a,i++):u!=="."||a?(n+=u,i++):(s(),i++)}if(s(),a)throw new x(P.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new r(e)}static emptyPath(){return new r([])}};var M=class r{constructor(t){this.path=t}static fromPath(t){return new r(Y.fromString(t))}static fromName(t){return new r(Y.fromString(t).popFirst(5))}static empty(){return new r(Y.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&Y.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return Y.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new r(new Y(t.slice()))}};var Gn=class{constructor(t,e,n,i){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=i}};function fa(r){return r.fields.find(t=>t.kind===2)}function Ye(r){return r.fields.filter(t=>t.kind!==2)}Gn.UNKNOWN_ID=-1;var Ln=class{constructor(t,e){this.fieldPath=t,this.kind=e}};var Wr=class r{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new r(0,zt.min())}};function Fd(r,t){let e=r.toTimestamp().seconds,n=r.toTimestamp().nanoseconds+1,i=B.fromTimestamp(n===1e9?new at(e+1,0):new at(e,n));return new zt(i,M.empty(),t)}function Md(r){return new zt(r.readTime,r.key,-1)}var zt=class r{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new r(B.min(),M.empty(),-1)}static max(){return new r(B.max(),M.empty(),-1)}};function sc(r,t){let e=r.readTime.compareTo(t.readTime);return e!==0?e:(e=M.comparator(r.documentKey,t.documentKey),e!==0?e:K(r.largestBatchId,t.largestBatchId))}var Od="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",as=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}};function je(r){return C(this,null,function*(){if(r.code!==P.FAILED_PRECONDITION||r.message!==Od)throw r;V("LocalStore","Unexpectedly lost primary lease")})}var b=class r{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&L(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new r((n,i)=>{this.nextCallback=s=>{this.wrapSuccess(t,s).next(n,i)},this.catchCallback=s=>{this.wrapFailure(e,s).next(n,i)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{let e=t();return e instanceof r?e:r.resolve(e)}catch(e){return r.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):r.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):r.reject(e)}static resolve(t){return new r((e,n)=>{e(t)})}static reject(t){return new r((e,n)=>{n(t)})}static waitFor(t){return new r((e,n)=>{let i=0,s=0,a=!1;t.forEach(u=>{++i,u.next(()=>{++s,a&&s===i&&e()},l=>n(l))}),a=!0,s===i&&e()})}static or(t){let e=r.resolve(!1);for(let n of t)e=e.next(i=>i?r.resolve(i):n());return e}static forEach(t,e){let n=[];return t.forEach((i,s)=>{n.push(e.call(this,i,s))}),this.waitFor(n)}static mapArray(t,e){return new r((n,i)=>{let s=t.length,a=new Array(s),u=0;for(let l=0;l<s;l++){let d=l;e(t[d]).next(f=>{a[d]=f,++u,u===s&&n(a)},f=>i(f))}})}static doWhile(t,e){return new r((n,i)=>{let s=()=>{t()===!0?e().next(()=>{s()},i):n()};s()})}};var us=class r{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new yt,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new rn(t,e.error)):this.V.resolve()},this.transaction.onerror=n=>{let i=oc(n.target.error);this.V.reject(new rn(t,i))}}static open(t,e,n,i){try{return new r(e,t.transaction(i,n))}catch(s){throw new rn(e,s)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(V("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let t=this.transaction;this.aborted||typeof t.commit!="function"||t.commit()}store(t){let e=this.transaction.objectStore(t);return new ga(e)}},ke=class r{constructor(t,e,n){this.name=t,this.version=e,this.p=n,r.S(Fr())===12.2&&dt("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return V("SimpleDb","Removing database:",t),Xe(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!ch())return!1;if(r.C())return!0;let t=Fr(),e=r.S(t),n=0<e&&e<10,i=Ld(t),s=0<i&&i<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static C(){var t;return typeof process<"u"&&((t=process.__PRIVATE_env)===null||t===void 0?void 0:t.v)==="YES"}static F(t,e){return t.store(e)}static S(t){let e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}M(t){return C(this,null,function*(){return this.db||(V("SimpleDb","Opening database:",this.name),this.db=yield new Promise((e,n)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let a=s.target.result;e(a)},i.onblocked=()=>{n(new rn(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let a=s.target.error;a.name==="VersionError"?n(new x(P.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):a.name==="InvalidStateError"?n(new x(P.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+a)):n(new rn(t,a))},i.onupgradeneeded=s=>{V("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let a=s.target.result;this.p.O(a,i.transaction,s.oldVersion,this.version).next(()=>{V("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db})}L(t){this.N=t,this.db&&(this.db.onversionchange=e=>t(e))}runTransaction(t,e,n,i){return C(this,null,function*(){let s=e==="readonly",a=0;for(;;){++a;try{this.db=yield this.M(t);let u=us.open(this.db,t,s?"readonly":"readwrite",n),l=i(u).next(d=>(u.g(),d)).catch(d=>(u.abort(d),b.reject(d))).toPromise();return l.catch(()=>{}),yield u.m,l}catch(u){let l=u,d=l.name!=="FirebaseError"&&a<3;if(V("SimpleDb","Transaction failed with error:",l.message,"Retrying:",d),this.close(),!d)return Promise.reject(l)}}})}close(){this.db&&this.db.close(),this.db=void 0}};function Ld(r){let t=r.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}var ma=class{constructor(t){this.B=t,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(t){this.B=t}done(){this.k=!0}$(t){this.q=t}delete(){return Xe(this.B.delete())}},rn=class extends x{constructor(t,e){super(P.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}};function ze(r){return r.name==="IndexedDbTransactionError"}var ga=class{constructor(t){this.store=t}put(t,e){let n;return e!==void 0?(V("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(V("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Xe(n)}add(t){return V("SimpleDb","ADD",this.store.name,t,t),Xe(this.store.add(t))}get(t){return Xe(this.store.get(t)).next(e=>(e===void 0&&(e=null),V("SimpleDb","GET",this.store.name,t,e),e))}delete(t){return V("SimpleDb","DELETE",this.store.name,t),Xe(this.store.delete(t))}count(){return V("SimpleDb","COUNT",this.store.name),Xe(this.store.count())}U(t,e){let n=this.options(t,e),i=n.index?this.store.index(n.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(n.range);return new b((a,u)=>{s.onerror=l=>{u(l.target.error)},s.onsuccess=l=>{a(l.target.result)}})}{let s=this.cursor(n),a=[];return this.W(s,(u,l)=>{a.push(l)}).next(()=>a)}}G(t,e){let n=this.store.getAll(t,e===null?void 0:e);return new b((i,s)=>{n.onerror=a=>{s(a.target.error)},n.onsuccess=a=>{i(a.target.result)}})}j(t,e){V("SimpleDb","DELETE ALL",this.store.name);let n=this.options(t,e);n.H=!1;let i=this.cursor(n);return this.W(i,(s,a,u)=>u.delete())}J(t,e){let n;e?n=t:(n={},e=t);let i=this.cursor(n);return this.W(i,e)}Y(t){let e=this.cursor({});return new b((n,i)=>{e.onerror=s=>{let a=oc(s.target.error);i(a)},e.onsuccess=s=>{let a=s.target.result;a?t(a.primaryKey,a.value).next(u=>{u?a.continue():n()}):n()}})}W(t,e){let n=[];return new b((i,s)=>{t.onerror=a=>{s(a.target.error)},t.onsuccess=a=>{let u=a.target.result;if(!u)return void i();let l=new ma(u),d=e(u.primaryKey,u.value,l);if(d instanceof b){let f=d.catch(g=>(l.done(),b.reject(g)));n.push(f)}l.isDone?i():l.K===null?u.continue():u.continue(l.K)}}).next(()=>b.waitFor(n))}options(t,e){let n;return t!==void 0&&(typeof t=="string"?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){let n=this.store.index(t.index);return t.H?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}};function Xe(r){return new b((t,e)=>{r.onsuccess=n=>{let i=n.target.result;t(i)},r.onerror=n=>{let i=oc(n.target.error);e(i)}})}var Nh=!1;function oc(r){let t=ke.S(Fr());if(t>=12.2&&t<13){let e="An internal error was encountered in the Indexed Database server";if(r.message.indexOf(e)>=0){let n=new x("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Nh||(Nh=!0,setTimeout(()=>{throw n},0)),n}}return r}var pa=class{constructor(t,e){this.asyncQueue=t,this.Z=e,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}X(t){V("IndexBackfiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,()=>C(this,null,function*(){this.task=null;try{V("IndexBackfiller",`Documents written: ${yield this.Z.ee()}`)}catch(e){ze(e)?V("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):yield je(e)}yield this.X(6e4)}))}},_a=class{constructor(t,e){this.localStore=t,this.persistence=e}ee(t=50){return C(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.te(e,t))})}te(t,e){let n=new Set,i=e,s=!0;return b.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next(a=>{if(a!==null&&!n.has(a))return V("IndexBackfiller",`Processing collection: ${a}`),this.ne(t,a,i).next(u=>{i-=u,n.add(a)});s=!1})).next(()=>e-i)}ne(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next(i=>this.localStore.localDocuments.getNextDocuments(t,e,i,n).next(s=>{let a=s.changes;return this.localStore.indexManager.updateIndexEntries(t,a).next(()=>this.re(i,s)).next(u=>(V("IndexBackfiller",`Updating offset: ${u}`),this.localStore.indexManager.updateCollectionGroup(t,e,u))).next(()=>a.size)}))}re(t,e){let n=t;return e.changes.forEach((i,s)=>{let a=Md(s);sc(a,n)>0&&(n=a)}),new zt(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}};var qt=(()=>{class r{constructor(e,n){this.previousValue=e,n&&(n.sequenceNumberHandler=i=>this.ie(i),this.se=i=>n.writeSequenceNumber(i))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.se&&this.se(e),e}}return r.oe=-1,r})();function pi(r){return r==null}function Hr(r){return r===0&&1/r==-1/0}function qd(r){return typeof r=="number"&&Number.isInteger(r)&&!Hr(r)&&r<=Number.MAX_SAFE_INTEGER&&r>=Number.MIN_SAFE_INTEGER}function kt(r){let t="";for(let e=0;e<r.length;e++)t.length>0&&(t=kh(t)),t=Kg(r.get(e),t);return kh(t)}function Kg(r,t){let e=t,n=r.length;for(let i=0;i<n;i++){let s=r.charAt(i);switch(s){case"\0":e+="";break;case"":e+="";break;default:e+=s}}return e}function kh(r){return r+""}function Zt(r){let t=r.length;if(q(t>=2),t===2)return q(r.charAt(0)===""&&r.charAt(1)===""),Y.emptyPath();let e=t-2,n=[],i="";for(let s=0;s<t;){let a=r.indexOf("",s);switch((a<0||a>e)&&L(),r.charAt(a+1)){case"":let u=r.substring(s,a),l;i.length===0?l=u:(i+=u,l=i,i=""),n.push(l);break;case"":i+=r.substring(s,a),i+="\0";break;case"":i+=r.substring(s,a+1);break;default:L()}s=a+2}return new Y(n)}var Fh=["userId","batchId"];function Xi(r,t){return[r,kt(t)]}function Ud(r,t,e){return[r,kt(t),e]}var $g={},Qg=["prefixPath","collectionGroup","readTime","documentId"],Wg=["prefixPath","collectionGroup","documentId"],Hg=["collectionGroup","readTime","prefixPath","documentId"],Jg=["canonicalId","targetId"],Yg=["targetId","path"],Xg=["path","targetId"],Zg=["collectionId","parent"],tp=["indexId","uid"],ep=["uid","sequenceNumber"],np=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],rp=["indexId","uid","orderedDocumentKey"],ip=["userId","collectionPath","documentId"],sp=["userId","collectionPath","largestBatchId"],op=["userId","collectionGroup","largestBatchId"],Bd=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],ap=[...Bd,"documentOverlays"],Gd=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],jd=Gd,zd=[...jd,"indexConfiguration","indexState","indexEntries"],up=zd;var Jr=class extends as{constructor(t,e){super(),this._e=t,this.currentSequenceNumber=e}};function Tt(r,t){let e=O(r);return ke.F(e._e,t)}function Mh(r){let t=0;for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&t++;return t}function pn(r,t){for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&t(e,r[e])}function Kd(r){for(let t in r)if(Object.prototype.hasOwnProperty.call(r,t))return!1;return!0}var st=class r{constructor(t,e){this.comparator=t,this.root=e||ee.EMPTY}insert(t,e){return new r(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,ee.BLACK,null,null))}remove(t){return new r(this.comparator,this.root.remove(t,this.comparator).copy(null,null,ee.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){let n=this.comparator(t,e.key);if(n===0)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){let i=this.comparator(t,n.key);if(i===0)return e+n.left.size;i<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,n)=>(t(e,n),!1))}toString(){let t=[];return this.inorderTraversal((e,n)=>(t.push(`${e}:${n}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new On(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new On(this.root,t,this.comparator,!1)}getReverseIterator(){return new On(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new On(this.root,t,this.comparator,!0)}},On=class{constructor(t,e,n,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,e&&i&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(s===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}},ee=class r{constructor(t,e,n,i,s){this.key=t,this.value=e,this.color=n??r.RED,this.left=i??r.EMPTY,this.right=s??r.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,i,s){return new r(t??this.key,e??this.value,n??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let i=this,s=n(t,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(t,e,n),null):s===0?i.copy(null,e,null,null,null):i.copy(null,null,null,null,i.right.insert(t,e,n)),i.fixUp()}removeMin(){if(this.left.isEmpty())return r.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,i=this;if(e(t,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(t,e),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),e(t,i.key)===0){if(i.right.isEmpty())return r.EMPTY;n=i.right.min(),i=i.copy(n.key,n.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(t,e))}return i.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){let t=this.copy(null,null,r.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){let t=this.copy(null,null,r.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){let t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){let t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw L();let t=this.left.check();if(t!==this.right.check())throw L();return t+(this.isRed()?0:1)}};ee.EMPTY=null,ee.RED=!0,ee.BLACK=!1;ee.EMPTY=new class{constructor(){this.size=0}get key(){throw L()}get value(){throw L()}get color(){throw L()}get left(){throw L()}get right(){throw L()}copy(t,e,n,i,s){return this}insert(t,e,n){return new ee(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var nt=class r{constructor(t){this.comparator=t,this.data=new st(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,n)=>(t(e),!1))}forEachInRange(t,e){let n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){let i=n.getNext();if(this.comparator(i.key,t[1])>=0)return;e(i.key)}}forEachWhile(t,e){let n;for(n=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){let e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new cs(this.data.getIterator())}getIteratorFrom(t){return new cs(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(n=>{e=e.add(n)}),e}isEqual(t){if(!(t instanceof r)||this.size!==t.size)return!1;let e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=n.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let t=[];return this.forEach(e=>{t.push(e)}),t}toString(){let t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){let e=new r(this.comparator);return e.data=t,e}},cs=class{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function Pn(r){return r.hasNext()?r.getNext():void 0}var Ut=class r{constructor(t){this.fields=t,t.sort(ft.comparator)}static empty(){return new r([])}unionWith(t){let e=new nt(ft.comparator);for(let n of this.fields)e=e.add(n);for(let n of t)e=e.add(n);return new r(e.toArray())}covers(t){for(let e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Bn(this.fields,t.fields,(e,n)=>e.isEqual(n))}};var ls=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function $d(){return typeof atob<"u"}var Et=class r{constructor(t){this.binaryString=t}static fromBase64String(t){let e=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new ls("Invalid base64 string: "+s):s}}(t);return new r(e)}static fromUint8Array(t){let e=function(i){let s="";for(let a=0;a<i.length;++a)s+=String.fromCharCode(i[a]);return s}(t);return new r(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){let n=new Uint8Array(e.length);for(let i=0;i<e.length;i++)n[i]=e.charCodeAt(i);return n}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return K(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}};Et.EMPTY_BYTE_STRING=new Et("");var cp=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ge(r){if(q(!!r),typeof r=="string"){let t=0,e=cp.exec(r);if(q(!!e),e[1]){let i=e[1];i=(i+"000000000").substr(0,9),t=Number(i)}let n=new Date(r);return{seconds:Math.floor(n.getTime()/1e3),nanos:t}}return{seconds:lt(r.seconds),nanos:lt(r.nanos)}}function lt(r){return typeof r=="number"?r:typeof r=="string"?Number(r):0}function Fe(r){return typeof r=="string"?Et.fromBase64String(r):Et.fromUint8Array(r)}function to(r){var t,e;return((e=(((t=r?.mapValue)===null||t===void 0?void 0:t.fields)||{}).__type__)===null||e===void 0?void 0:e.stringValue)==="server_timestamp"}function ac(r){let t=r.mapValue.fields.__previous_value__;return to(t)?ac(t):t}function Yr(r){let t=ge(r.mapValue.fields.__local_write_time__.timestampValue);return new at(t.seconds,t.nanos)}var ya=class{constructor(t,e,n,i,s,a,u,l,d){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=i,this.ssl=s,this.forceLongPolling=a,this.autoDetectLongPolling=u,this.longPollingOptions=l,this.useFetchStreams=d}},Me=class r{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new r("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(t){return t instanceof r&&t.projectId===this.projectId&&t.database===this.database}};var Ve={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Zi={nullValue:"NULL_VALUE"};function sn(r){return"nullValue"in r?0:"booleanValue"in r?1:"integerValue"in r||"doubleValue"in r?2:"timestampValue"in r?3:"stringValue"in r?5:"bytesValue"in r?6:"referenceValue"in r?7:"geoPointValue"in r?8:"arrayValue"in r?9:"mapValue"in r?to(r)?4:Qd(r)?9007199254740991:10:L()}function ie(r,t){if(r===t)return!0;let e=sn(r);if(e!==sn(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===t.booleanValue;case 4:return Yr(r).isEqual(Yr(t));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let a=ge(i.timestampValue),u=ge(s.timestampValue);return a.seconds===u.seconds&&a.nanos===u.nanos}(r,t);case 5:return r.stringValue===t.stringValue;case 6:return function(i,s){return Fe(i.bytesValue).isEqual(Fe(s.bytesValue))}(r,t);case 7:return r.referenceValue===t.referenceValue;case 8:return function(i,s){return lt(i.geoPointValue.latitude)===lt(s.geoPointValue.latitude)&&lt(i.geoPointValue.longitude)===lt(s.geoPointValue.longitude)}(r,t);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return lt(i.integerValue)===lt(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let a=lt(i.doubleValue),u=lt(s.doubleValue);return a===u?Hr(a)===Hr(u):isNaN(a)&&isNaN(u)}return!1}(r,t);case 9:return Bn(r.arrayValue.values||[],t.arrayValue.values||[],ie);case 10:return function(i,s){let a=i.mapValue.fields||{},u=s.mapValue.fields||{};if(Mh(a)!==Mh(u))return!1;for(let l in a)if(a.hasOwnProperty(l)&&(u[l]===void 0||!ie(a[l],u[l])))return!1;return!0}(r,t);default:return L()}}function Xr(r,t){return(r.values||[]).find(e=>ie(e,t))!==void 0}function Oe(r,t){if(r===t)return 0;let e=sn(r),n=sn(t);if(e!==n)return K(e,n);switch(e){case 0:case 9007199254740991:return 0;case 1:return K(r.booleanValue,t.booleanValue);case 2:return function(s,a){let u=lt(s.integerValue||s.doubleValue),l=lt(a.integerValue||a.doubleValue);return u<l?-1:u>l?1:u===l?0:isNaN(u)?isNaN(l)?0:-1:1}(r,t);case 3:return Oh(r.timestampValue,t.timestampValue);case 4:return Oh(Yr(r),Yr(t));case 5:return K(r.stringValue,t.stringValue);case 6:return function(s,a){let u=Fe(s),l=Fe(a);return u.compareTo(l)}(r.bytesValue,t.bytesValue);case 7:return function(s,a){let u=s.split("/"),l=a.split("/");for(let d=0;d<u.length&&d<l.length;d++){let f=K(u[d],l[d]);if(f!==0)return f}return K(u.length,l.length)}(r.referenceValue,t.referenceValue);case 8:return function(s,a){let u=K(lt(s.latitude),lt(a.latitude));return u!==0?u:K(lt(s.longitude),lt(a.longitude))}(r.geoPointValue,t.geoPointValue);case 9:return function(s,a){let u=s.values||[],l=a.values||[];for(let d=0;d<u.length&&d<l.length;++d){let f=Oe(u[d],l[d]);if(f)return f}return K(u.length,l.length)}(r.arrayValue,t.arrayValue);case 10:return function(s,a){if(s===Ve.mapValue&&a===Ve.mapValue)return 0;if(s===Ve.mapValue)return 1;if(a===Ve.mapValue)return-1;let u=s.fields||{},l=Object.keys(u),d=a.fields||{},f=Object.keys(d);l.sort(),f.sort();for(let g=0;g<l.length&&g<f.length;++g){let y=K(l[g],f[g]);if(y!==0)return y;let S=Oe(u[l[g]],d[f[g]]);if(S!==0)return S}return K(l.length,f.length)}(r.mapValue,t.mapValue);default:throw L()}}function Oh(r,t){if(typeof r=="string"&&typeof t=="string"&&r.length===t.length)return K(r,t);let e=ge(r),n=ge(t),i=K(e.seconds,n.seconds);return i!==0?i:K(e.nanos,n.nanos)}function jn(r){return wa(r)}function wa(r){return"nullValue"in r?"null":"booleanValue"in r?""+r.booleanValue:"integerValue"in r?""+r.integerValue:"doubleValue"in r?""+r.doubleValue:"timestampValue"in r?function(e){let n=ge(e);return`time(${n.seconds},${n.nanos})`}(r.timestampValue):"stringValue"in r?r.stringValue:"bytesValue"in r?function(e){return Fe(e).toBase64()}(r.bytesValue):"referenceValue"in r?function(e){return M.fromName(e).toString()}(r.referenceValue):"geoPointValue"in r?function(e){return`geo(${e.latitude},${e.longitude})`}(r.geoPointValue):"arrayValue"in r?function(e){let n="[",i=!0;for(let s of e.values||[])i?i=!1:n+=",",n+=wa(s);return n+"]"}(r.arrayValue):"mapValue"in r?function(e){let n=Object.keys(e.fields||{}).sort(),i="{",s=!0;for(let a of n)s?s=!1:i+=",",i+=`${a}:${wa(e.fields[a])}`;return i+"}"}(r.mapValue):L()}function on(r,t){return{referenceValue:`projects/${r.projectId}/databases/${r.database}/documents/${t.path.canonicalString()}`}}function va(r){return!!r&&"integerValue"in r}function Zr(r){return!!r&&"arrayValue"in r}function Lh(r){return!!r&&"nullValue"in r}function qh(r){return!!r&&"doubleValue"in r&&isNaN(Number(r.doubleValue))}function ts(r){return!!r&&"mapValue"in r}function jr(r){if(r.geoPointValue)return{geoPointValue:Object.assign({},r.geoPointValue)};if(r.timestampValue&&typeof r.timestampValue=="object")return{timestampValue:Object.assign({},r.timestampValue)};if(r.mapValue){let t={mapValue:{fields:{}}};return pn(r.mapValue.fields,(e,n)=>t.mapValue.fields[e]=jr(n)),t}if(r.arrayValue){let t={arrayValue:{values:[]}};for(let e=0;e<(r.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=jr(r.arrayValue.values[e]);return t}return Object.assign({},r)}function Qd(r){return(((r.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}function lp(r){return"nullValue"in r?Zi:"booleanValue"in r?{booleanValue:!1}:"integerValue"in r||"doubleValue"in r?{doubleValue:NaN}:"timestampValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in r?{stringValue:""}:"bytesValue"in r?{bytesValue:""}:"referenceValue"in r?on(Me.empty(),M.empty()):"geoPointValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in r?{arrayValue:{}}:"mapValue"in r?{mapValue:{}}:L()}function hp(r){return"nullValue"in r?{booleanValue:!1}:"booleanValue"in r?{doubleValue:NaN}:"integerValue"in r||"doubleValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in r?{stringValue:""}:"stringValue"in r?{bytesValue:""}:"bytesValue"in r?on(Me.empty(),M.empty()):"referenceValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in r?{arrayValue:{}}:"arrayValue"in r?{mapValue:{}}:"mapValue"in r?Ve:L()}function Uh(r,t){let e=Oe(r.value,t.value);return e!==0?e:r.inclusive&&!t.inclusive?-1:!r.inclusive&&t.inclusive?1:0}function Bh(r,t){let e=Oe(r.value,t.value);return e!==0?e:r.inclusive&&!t.inclusive?1:!r.inclusive&&t.inclusive?-1:0}var Vt=class r{constructor(t){this.value=t}static empty(){return new r({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!ts(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=jr(e)}setAll(t){let e=ft.emptyPath(),n={},i=[];t.forEach((a,u)=>{if(!e.isImmediateParentOf(u)){let l=this.getFieldsMap(e);this.applyChanges(l,n,i),n={},i=[],e=u.popLast()}a?n[u.lastSegment()]=jr(a):i.push(u.lastSegment())});let s=this.getFieldsMap(e);this.applyChanges(s,n,i)}delete(t){let e=this.field(t.popLast());ts(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return ie(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let i=e.mapValue.fields[t.get(n)];ts(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=i),e=i}return e.mapValue.fields}applyChanges(t,e,n){pn(e,(i,s)=>t[i]=s);for(let i of n)delete t[i]}clone(){return new r(jr(this.value))}};function Wd(r){let t=[];return pn(r.fields,(e,n)=>{let i=new ft([e]);if(ts(n)){let s=Wd(n.mapValue).fields;if(s.length===0)t.push(i);else for(let a of s)t.push(i.child(a))}else t.push(i)}),new Ut(t)}var wt=class r{constructor(t,e,n,i,s,a,u){this.key=t,this.documentType=e,this.version=n,this.readTime=i,this.createTime=s,this.data=a,this.documentState=u}static newInvalidDocument(t){return new r(t,0,B.min(),B.min(),B.min(),Vt.empty(),0)}static newFoundDocument(t,e,n,i){return new r(t,1,e,B.min(),n,i,0)}static newNoDocument(t,e){return new r(t,2,e,B.min(),B.min(),Vt.empty(),0)}static newUnknownDocument(t,e){return new r(t,3,e,B.min(),B.min(),Vt.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(B.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Vt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Vt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=B.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof r&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new r(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var se=class{constructor(t,e){this.position=t,this.inclusive=e}};function Gh(r,t,e){let n=0;for(let i=0;i<r.position.length;i++){let s=t[i],a=r.position[i];if(s.field.isKeyField()?n=M.comparator(M.fromName(a.referenceValue),e.key):n=Oe(a,e.data.field(s.field)),s.dir==="desc"&&(n*=-1),n!==0)break}return n}function jh(r,t){if(r===null)return t===null;if(t===null||r.inclusive!==t.inclusive||r.position.length!==t.position.length)return!1;for(let e=0;e<r.position.length;e++)if(!ie(r.position[e],t.position[e]))return!1;return!0}var an=class{constructor(t,e="asc"){this.field=t,this.dir=e}};function dp(r,t){return r.dir===t.dir&&r.field.isEqual(t.field)}var hs=class{},W=class r extends hs{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,n):new Ta(t,e,n):e==="array-contains"?new ba(t,n):e==="in"?new ds(t,n):e==="not-in"?new Ra(t,n):e==="array-contains-any"?new Pa(t,n):new r(t,e,n)}static createKeyFieldInFilter(t,e,n){return e==="in"?new Aa(t,n):new Sa(t,n)}matches(t){let e=t.data.field(this.field);return this.op==="!="?e!==null&&this.matchesComparison(Oe(e,this.value)):e!==null&&sn(this.value)===sn(e)&&this.matchesComparison(Oe(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return L()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},tt=class r extends hs{constructor(t,e){super(),this.filters=t,this.op=e,this.ae=null}static create(t,e){return new r(t,e)}matches(t){return zn(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}};function zn(r){return r.op==="and"}function Ia(r){return r.op==="or"}function uc(r){return Hd(r)&&zn(r)}function Hd(r){for(let t of r.filters)if(t instanceof tt)return!1;return!0}function Ea(r){if(r instanceof W)return r.field.canonicalString()+r.op.toString()+jn(r.value);if(uc(r))return r.filters.map(t=>Ea(t)).join(",");{let t=r.filters.map(e=>Ea(e)).join(",");return`${r.op}(${t})`}}function Jd(r,t){return r instanceof W?function(n,i){return i instanceof W&&n.op===i.op&&n.field.isEqual(i.field)&&ie(n.value,i.value)}(r,t):r instanceof tt?function(n,i){return i instanceof tt&&n.op===i.op&&n.filters.length===i.filters.length?n.filters.reduce((s,a,u)=>s&&Jd(a,i.filters[u]),!0):!1}(r,t):void L()}function Yd(r,t){let e=r.filters.concat(t);return tt.create(e,r.op)}function Xd(r){return r instanceof W?function(e){return`${e.field.canonicalString()} ${e.op} ${jn(e.value)}`}(r):r instanceof tt?function(e){return e.op.toString()+" {"+e.getFilters().map(Xd).join(" ,")+"}"}(r):"Filter"}var Ta=class extends W{constructor(t,e,n){super(t,e,n),this.key=M.fromName(n.referenceValue)}matches(t){let e=M.comparator(t.key,this.key);return this.matchesComparison(e)}},Aa=class extends W{constructor(t,e){super(t,"in",e),this.keys=Zd("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}},Sa=class extends W{constructor(t,e){super(t,"not-in",e),this.keys=Zd("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}};function Zd(r,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(n=>M.fromName(n.referenceValue))}var ba=class extends W{constructor(t,e){super(t,"array-contains",e)}matches(t){let e=t.data.field(this.field);return Zr(e)&&Xr(e.arrayValue,this.value)}},ds=class extends W{constructor(t,e){super(t,"in",e)}matches(t){let e=t.data.field(this.field);return e!==null&&Xr(this.value.arrayValue,e)}},Ra=class extends W{constructor(t,e){super(t,"not-in",e)}matches(t){if(Xr(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let e=t.data.field(this.field);return e!==null&&!Xr(this.value.arrayValue,e)}},Pa=class extends W{constructor(t,e){super(t,"array-contains-any",e)}matches(t){let e=t.data.field(this.field);return!(!Zr(e)||!e.arrayValue.values)&&e.arrayValue.values.some(n=>Xr(this.value.arrayValue,n))}};var Ca=class{constructor(t,e=null,n=[],i=[],s=null,a=null,u=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=i,this.limit=s,this.startAt=a,this.endAt=u,this.ue=null}};function xa(r,t=null,e=[],n=[],i=null,s=null,a=null){return new Ca(r,t,e,n,i,s,a)}function un(r){let t=O(r);if(t.ue===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(n=>Ea(n)).join(","),e+="|ob:",e+=t.orderBy.map(n=>function(s){return s.field.canonicalString()+s.dir}(n)).join(","),pi(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(n=>jn(n)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(n=>jn(n)).join(",")),t.ue=e}return t.ue}function _i(r,t){if(r.limit!==t.limit||r.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<r.orderBy.length;e++)if(!dp(r.orderBy[e],t.orderBy[e]))return!1;if(r.filters.length!==t.filters.length)return!1;for(let e=0;e<r.filters.length;e++)if(!Jd(r.filters[e],t.filters[e]))return!1;return r.collectionGroup===t.collectionGroup&&!!r.path.isEqual(t.path)&&!!jh(r.startAt,t.startAt)&&jh(r.endAt,t.endAt)}function fs(r){return M.isDocumentKey(r.path)&&r.collectionGroup===null&&r.filters.length===0}function ms(r,t){return r.filters.filter(e=>e instanceof W&&e.field.isEqual(t))}function zh(r,t,e){let n=Zi,i=!0;for(let s of ms(r,t)){let a=Zi,u=!0;switch(s.op){case"<":case"<=":a=lp(s.value);break;case"==":case"in":case">=":a=s.value;break;case">":a=s.value,u=!1;break;case"!=":case"not-in":a=Zi}Uh({value:n,inclusive:i},{value:a,inclusive:u})<0&&(n=a,i=u)}if(e!==null){for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(t)){let a=e.position[s];Uh({value:n,inclusive:i},{value:a,inclusive:e.inclusive})<0&&(n=a,i=e.inclusive);break}}return{value:n,inclusive:i}}function Kh(r,t,e){let n=Ve,i=!0;for(let s of ms(r,t)){let a=Ve,u=!0;switch(s.op){case">=":case">":a=hp(s.value),u=!1;break;case"==":case"in":case"<=":a=s.value;break;case"<":a=s.value,u=!1;break;case"!=":case"not-in":a=Ve}Bh({value:n,inclusive:i},{value:a,inclusive:u})>0&&(n=a,i=u)}if(e!==null){for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(t)){let a=e.position[s];Bh({value:n,inclusive:i},{value:a,inclusive:e.inclusive})>0&&(n=a,i=e.inclusive);break}}return{value:n,inclusive:i}}var Wt=class{constructor(t,e=null,n=[],i=[],s=null,a="F",u=null,l=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=i,this.limit=s,this.limitType=a,this.startAt=u,this.endAt=l,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}};function tf(r,t,e,n,i,s,a,u){return new Wt(r,t,e,n,i,s,a,u)}function sr(r){return new Wt(r)}function $h(r){return r.filters.length===0&&r.limit===null&&r.startAt==null&&r.endAt==null&&(r.explicitOrderBy.length===0||r.explicitOrderBy.length===1&&r.explicitOrderBy[0].field.isKeyField())}function cc(r){return r.collectionGroup!==null}function qn(r){let t=O(r);if(t.ce===null){t.ce=[];let e=new Set;for(let s of t.explicitOrderBy)t.ce.push(s),e.add(s.field.canonicalString());let n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(a){let u=new nt(ft.comparator);return a.filters.forEach(l=>{l.getFlattenedFilters().forEach(d=>{d.isInequality()&&(u=u.add(d.field))})}),u})(t).forEach(s=>{e.has(s.canonicalString())||s.isKeyField()||t.ce.push(new an(s,n))}),e.has(ft.keyField().canonicalString())||t.ce.push(new an(ft.keyField(),n))}return t.ce}function Ft(r){let t=O(r);return t.le||(t.le=fp(t,qn(r))),t.le}function fp(r,t){if(r.limitType==="F")return xa(r.path,r.collectionGroup,t,r.filters,r.limit,r.startAt,r.endAt);{t=t.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new an(i.field,s)});let e=r.endAt?new se(r.endAt.position,r.endAt.inclusive):null,n=r.startAt?new se(r.startAt.position,r.startAt.inclusive):null;return xa(r.path,r.collectionGroup,t,r.filters,r.limit,e,n)}}function Va(r,t){let e=r.filters.concat([t]);return new Wt(r.path,r.collectionGroup,r.explicitOrderBy.slice(),e,r.limit,r.limitType,r.startAt,r.endAt)}function gs(r,t,e){return new Wt(r.path,r.collectionGroup,r.explicitOrderBy.slice(),r.filters.slice(),t,e,r.startAt,r.endAt)}function yi(r,t){return _i(Ft(r),Ft(t))&&r.limitType===t.limitType}function ef(r){return`${un(Ft(r))}|lt:${r.limitType}`}function Nn(r){return`Query(target=${function(e){let n=e.path.canonicalString();return e.collectionGroup!==null&&(n+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(n+=`, filters: [${e.filters.map(i=>Xd(i)).join(", ")}]`),pi(e.limit)||(n+=", limit: "+e.limit),e.orderBy.length>0&&(n+=`, orderBy: [${e.orderBy.map(i=>function(a){return`${a.field.canonicalString()} (${a.dir})`}(i)).join(", ")}]`),e.startAt&&(n+=", startAt: ",n+=e.startAt.inclusive?"b:":"a:",n+=e.startAt.position.map(i=>jn(i)).join(",")),e.endAt&&(n+=", endAt: ",n+=e.endAt.inclusive?"a:":"b:",n+=e.endAt.position.map(i=>jn(i)).join(",")),`Target(${n})`}(Ft(r))}; limitType=${r.limitType})`}function wi(r,t){return t.isFoundDocument()&&function(n,i){let s=i.key.path;return n.collectionGroup!==null?i.key.hasCollectionId(n.collectionGroup)&&n.path.isPrefixOf(s):M.isDocumentKey(n.path)?n.path.isEqual(s):n.path.isImmediateParentOf(s)}(r,t)&&function(n,i){for(let s of qn(n))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(r,t)&&function(n,i){for(let s of n.filters)if(!s.matches(i))return!1;return!0}(r,t)&&function(n,i){return!(n.startAt&&!function(a,u,l){let d=Gh(a,u,l);return a.inclusive?d<=0:d<0}(n.startAt,qn(n),i)||n.endAt&&!function(a,u,l){let d=Gh(a,u,l);return a.inclusive?d>=0:d>0}(n.endAt,qn(n),i))}(r,t)}function nf(r){return r.collectionGroup||(r.path.length%2==1?r.path.lastSegment():r.path.get(r.path.length-2))}function rf(r){return(t,e)=>{let n=!1;for(let i of qn(r)){let s=mp(i,t,e);if(s!==0)return s;n=n||i.field.isKeyField()}return 0}}function mp(r,t,e){let n=r.field.isKeyField()?M.comparator(t.key,e.key):function(s,a,u){let l=a.data.field(s),d=u.data.field(s);return l!==null&&d!==null?Oe(l,d):L()}(r.field,t,e);switch(r.dir){case"asc":return n;case"desc":return-1*n;default:return L()}}var oe=class{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){let e=this.mapKeyFn(t),n=this.inner[e];if(n!==void 0){for(let[i,s]of n)if(this.equalsFn(i,t))return s}}has(t){return this.get(t)!==void 0}set(t,e){let n=this.mapKeyFn(t),i=this.inner[n];if(i===void 0)return this.inner[n]=[[t,e]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],t))return void(i[s]=[t,e]);i.push([t,e]),this.innerSize++}delete(t){let e=this.mapKeyFn(t),n=this.inner[e];if(n===void 0)return!1;for(let i=0;i<n.length;i++)if(this.equalsFn(n[i][0],t))return n.length===1?delete this.inner[e]:n.splice(i,1),this.innerSize--,!0;return!1}forEach(t){pn(this.inner,(e,n)=>{for(let[i,s]of n)t(i,s)})}isEmpty(){return Kd(this.inner)}size(){return this.innerSize}};var gp=new st(M.comparator);function Ot(){return gp}var sf=new st(M.comparator);function Br(...r){let t=sf;for(let e of r)t=t.insert(e.key,e);return t}function of(r){let t=sf;return r.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function te(){return zr()}function af(){return zr()}function zr(){return new oe(r=>r.toString(),(r,t)=>r.isEqual(t))}var pp=new st(M.comparator),_p=new nt(M.comparator);function $(...r){let t=_p;for(let e of r)t=t.add(e);return t}var yp=new nt(K);function lc(){return yp}function uf(r,t){if(r.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Hr(t)?"-0":t}}function cf(r){return{integerValue:""+r}}function lf(r,t){return qd(t)?cf(t):uf(r,t)}var Kn=class{constructor(){this._=void 0}};function wp(r,t,e){return r instanceof Le?function(i,s){let a={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&to(s)&&(s=ac(s)),s&&(a.fields.__previous_value__=s),{mapValue:a}}(e,t):r instanceof pe?df(r,t):r instanceof _e?ff(r,t):function(i,s){let a=hf(i,s),u=Qh(a)+Qh(i.Pe);return va(a)&&va(i.Pe)?cf(u):uf(i.serializer,u)}(r,t)}function vp(r,t,e){return r instanceof pe?df(r,t):r instanceof _e?ff(r,t):e}function hf(r,t){return r instanceof qe?function(n){return va(n)||function(s){return!!s&&"doubleValue"in s}(n)}(t)?t:{integerValue:0}:null}var Le=class extends Kn{},pe=class extends Kn{constructor(t){super(),this.elements=t}};function df(r,t){let e=mf(t);for(let n of r.elements)e.some(i=>ie(i,n))||e.push(n);return{arrayValue:{values:e}}}var _e=class extends Kn{constructor(t){super(),this.elements=t}};function ff(r,t){let e=mf(t);for(let n of r.elements)e=e.filter(i=>!ie(i,n));return{arrayValue:{values:e}}}var qe=class extends Kn{constructor(t,e){super(),this.serializer=t,this.Pe=e}};function Qh(r){return lt(r.integerValue||r.doubleValue)}function mf(r){return Zr(r)&&r.arrayValue.values?r.arrayValue.values.slice():[]}var cn=class{constructor(t,e){this.field=t,this.transform=e}};function Ip(r,t){return r.field.isEqual(t.field)&&function(n,i){return n instanceof pe&&i instanceof pe||n instanceof _e&&i instanceof _e?Bn(n.elements,i.elements,ie):n instanceof qe&&i instanceof qe?ie(n.Pe,i.Pe):n instanceof Le&&i instanceof Le}(r.transform,t.transform)}var Da=class{constructor(t,e){this.version=t,this.transformResults=e}},ht=class r{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new r}static exists(t){return new r(void 0,t)}static updateTime(t){return new r(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}};function es(r,t){return r.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(r.updateTime):r.exists===void 0||r.exists===t.isFoundDocument()}var $n=class{};function gf(r,t){if(!r.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return r.isNoDocument()?new Be(r.key,ht.none()):new Ue(r.key,r.data,ht.none());{let e=r.data,n=Vt.empty(),i=new nt(ft.comparator);for(let s of t.fields)if(!i.has(s)){let a=e.field(s);a===null&&s.length>1&&(s=s.popLast(),a=e.field(s)),a===null?n.delete(s):n.set(s,a),i=i.add(s)}return new Ht(r.key,n,new Ut(i.toArray()),ht.none())}}function Ep(r,t,e){r instanceof Ue?function(i,s,a){let u=i.value.clone(),l=Hh(i.fieldTransforms,s,a.transformResults);u.setAll(l),s.convertToFoundDocument(a.version,u).setHasCommittedMutations()}(r,t,e):r instanceof Ht?function(i,s,a){if(!es(i.precondition,s))return void s.convertToUnknownDocument(a.version);let u=Hh(i.fieldTransforms,s,a.transformResults),l=s.data;l.setAll(pf(i)),l.setAll(u),s.convertToFoundDocument(a.version,l).setHasCommittedMutations()}(r,t,e):function(i,s,a){s.convertToNoDocument(a.version).setHasCommittedMutations()}(0,t,e)}function Kr(r,t,e,n){return r instanceof Ue?function(s,a,u,l){if(!es(s.precondition,a))return u;let d=s.value.clone(),f=Jh(s.fieldTransforms,l,a);return d.setAll(f),a.convertToFoundDocument(a.version,d).setHasLocalMutations(),null}(r,t,e,n):r instanceof Ht?function(s,a,u,l){if(!es(s.precondition,a))return u;let d=Jh(s.fieldTransforms,l,a),f=a.data;return f.setAll(pf(s)),f.setAll(d),a.convertToFoundDocument(a.version,f).setHasLocalMutations(),u===null?null:u.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(g=>g.field))}(r,t,e,n):function(s,a,u){return es(s.precondition,a)?(a.convertToNoDocument(a.version).setHasLocalMutations(),null):u}(r,t,e)}function Tp(r,t){let e=null;for(let n of r.fieldTransforms){let i=t.data.field(n.field),s=hf(n.transform,i||null);s!=null&&(e===null&&(e=Vt.empty()),e.set(n.field,s))}return e||null}function Wh(r,t){return r.type===t.type&&!!r.key.isEqual(t.key)&&!!r.precondition.isEqual(t.precondition)&&!!function(n,i){return n===void 0&&i===void 0||!(!n||!i)&&Bn(n,i,(s,a)=>Ip(s,a))}(r.fieldTransforms,t.fieldTransforms)&&(r.type===0?r.value.isEqual(t.value):r.type!==1||r.data.isEqual(t.data)&&r.fieldMask.isEqual(t.fieldMask))}var Ue=class extends $n{constructor(t,e,n,i=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},Ht=class extends $n{constructor(t,e,n,i,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function pf(r){let t=new Map;return r.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){let n=r.data.field(e);t.set(e,n)}}),t}function Hh(r,t,e){let n=new Map;q(r.length===e.length);for(let i=0;i<e.length;i++){let s=r[i],a=s.transform,u=t.data.field(s.field);n.set(s.field,vp(a,u,e[i]))}return n}function Jh(r,t,e){let n=new Map;for(let i of r){let s=i.transform,a=e.data.field(i.field);n.set(i.field,wp(s,a,t))}return n}var Be=class extends $n{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},ti=class extends $n{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var ei=class{constructor(t,e,n,i){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=i}applyToRemoteDocument(t,e){let n=e.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(t.key)&&Ep(s,t,n[i])}}applyToLocalView(t,e){for(let n of this.baseMutations)n.key.isEqual(t.key)&&(e=Kr(n,t,e,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(t.key)&&(e=Kr(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){let n=af();return this.mutations.forEach(i=>{let s=t.get(i.key),a=s.overlayedDocument,u=this.applyToLocalView(a,s.mutatedFields);u=e.has(i.key)?null:u;let l=gf(a,u);l!==null&&n.set(i.key,l),a.isValidDocument()||a.convertToNoDocument(B.min())}),n}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),$())}isEqual(t){return this.batchId===t.batchId&&Bn(this.mutations,t.mutations,(e,n)=>Wh(e,n))&&Bn(this.baseMutations,t.baseMutations,(e,n)=>Wh(e,n))}},Na=class r{constructor(t,e,n,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=i}static from(t,e,n){q(t.mutations.length===n.length);let i=function(){return pp}(),s=t.mutations;for(let a=0;a<s.length;a++)i=i.insert(s[a].key,n[a].version);return new r(t,e,n,i)}};var ni=class{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var ka=class{constructor(t,e){this.count=t,this.unchangedNames=e}};var gt,J;function _f(r){switch(r){default:return L();case P.CANCELLED:case P.UNKNOWN:case P.DEADLINE_EXCEEDED:case P.RESOURCE_EXHAUSTED:case P.INTERNAL:case P.UNAVAILABLE:case P.UNAUTHENTICATED:return!1;case P.INVALID_ARGUMENT:case P.NOT_FOUND:case P.ALREADY_EXISTS:case P.PERMISSION_DENIED:case P.FAILED_PRECONDITION:case P.ABORTED:case P.OUT_OF_RANGE:case P.UNIMPLEMENTED:case P.DATA_LOSS:return!0}}function yf(r){if(r===void 0)return dt("GRPC error has no .code"),P.UNKNOWN;switch(r){case gt.OK:return P.OK;case gt.CANCELLED:return P.CANCELLED;case gt.UNKNOWN:return P.UNKNOWN;case gt.DEADLINE_EXCEEDED:return P.DEADLINE_EXCEEDED;case gt.RESOURCE_EXHAUSTED:return P.RESOURCE_EXHAUSTED;case gt.INTERNAL:return P.INTERNAL;case gt.UNAVAILABLE:return P.UNAVAILABLE;case gt.UNAUTHENTICATED:return P.UNAUTHENTICATED;case gt.INVALID_ARGUMENT:return P.INVALID_ARGUMENT;case gt.NOT_FOUND:return P.NOT_FOUND;case gt.ALREADY_EXISTS:return P.ALREADY_EXISTS;case gt.PERMISSION_DENIED:return P.PERMISSION_DENIED;case gt.FAILED_PRECONDITION:return P.FAILED_PRECONDITION;case gt.ABORTED:return P.ABORTED;case gt.OUT_OF_RANGE:return P.OUT_OF_RANGE;case gt.UNIMPLEMENTED:return P.UNIMPLEMENTED;case gt.DATA_LOSS:return P.DATA_LOSS;default:return L()}}(J=gt||(gt={}))[J.OK=0]="OK",J[J.CANCELLED=1]="CANCELLED",J[J.UNKNOWN=2]="UNKNOWN",J[J.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",J[J.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",J[J.NOT_FOUND=5]="NOT_FOUND",J[J.ALREADY_EXISTS=6]="ALREADY_EXISTS",J[J.PERMISSION_DENIED=7]="PERMISSION_DENIED",J[J.UNAUTHENTICATED=16]="UNAUTHENTICATED",J[J.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",J[J.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",J[J.ABORTED=10]="ABORTED",J[J.OUT_OF_RANGE=11]="OUT_OF_RANGE",J[J.UNIMPLEMENTED=12]="UNIMPLEMENTED",J[J.INTERNAL=13]="INTERNAL",J[J.UNAVAILABLE=14]="UNAVAILABLE",J[J.DATA_LOSS=15]="DATA_LOSS";var Yh=null;function wf(){return new TextEncoder}var Ap=new be([4294967295,4294967295],0);function Xh(r){let t=wf().encode(r),e=new Ho;return e.update(t),new Uint8Array(e.digest())}function Zh(r){let t=new DataView(r.buffer),e=t.getUint32(0,!0),n=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new be([e,n],0),new be([i,s],0)]}var Fa=class r{constructor(t,e,n){if(this.bitmap=t,this.padding=e,this.hashCount=n,e<0||e>=8)throw new nn(`Invalid padding: ${e}`);if(n<0)throw new nn(`Invalid hash count: ${n}`);if(t.length>0&&this.hashCount===0)throw new nn(`Invalid hash count: ${n}`);if(t.length===0&&e!==0)throw new nn(`Invalid padding when bitmap length is 0: ${e}`);this.Ie=8*t.length-e,this.Te=be.fromNumber(this.Ie)}Ee(t,e,n){let i=t.add(e.multiply(be.fromNumber(n)));return i.compare(Ap)===1&&(i=new be([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(t){return(this.bitmap[Math.floor(t/8)]&1<<t%8)!=0}mightContain(t){if(this.Ie===0)return!1;let e=Xh(t),[n,i]=Zh(e);for(let s=0;s<this.hashCount;s++){let a=this.Ee(n,i,s);if(!this.de(a))return!1}return!0}static create(t,e,n){let i=t%8==0?0:8-t%8,s=new Uint8Array(Math.ceil(t/8)),a=new r(s,i,e);return n.forEach(u=>a.insert(u)),a}insert(t){if(this.Ie===0)return;let e=Xh(t),[n,i]=Zh(e);for(let s=0;s<this.hashCount;s++){let a=this.Ee(n,i,s);this.Ae(a)}}Ae(t){let e=Math.floor(t/8),n=t%8;this.bitmap[e]|=1<<n}},nn=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var ri=class r{constructor(t,e,n,i,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,n){let i=new Map;return i.set(t,ii.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new r(B.min(),i,new st(K),Ot(),$())}},ii=class r{constructor(t,e,n,i,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new r(n,e,$(),$(),$())}};var Un=class{constructor(t,e,n,i){this.Re=t,this.removedTargetIds=e,this.key=n,this.Ve=i}},ps=class{constructor(t,e){this.targetId=t,this.me=e}},_s=class{constructor(t,e,n=Et.EMPTY_BYTE_STRING,i=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=i}},ys=class{constructor(){this.fe=0,this.ge=ed(),this.pe=Et.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(t){t.approximateByteSize()>0&&(this.we=!0,this.pe=t)}Ce(){let t=$(),e=$(),n=$();return this.ge.forEach((i,s)=>{switch(s){case 0:t=t.add(i);break;case 2:e=e.add(i);break;case 1:n=n.add(i);break;default:L()}}),new ii(this.pe,this.ye,t,e,n)}ve(){this.we=!1,this.ge=ed()}Fe(t,e){this.we=!0,this.ge=this.ge.insert(t,e)}Me(t){this.we=!0,this.ge=this.ge.remove(t)}xe(){this.fe+=1}Oe(){this.fe-=1,q(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}},Ma=class{constructor(t){this.Le=t,this.Be=new Map,this.ke=Ot(),this.qe=td(),this.Qe=new st(K)}Ke(t){for(let e of t.Re)t.Ve&&t.Ve.isFoundDocument()?this.$e(e,t.Ve):this.Ue(e,t.key,t.Ve);for(let e of t.removedTargetIds)this.Ue(e,t.key,t.Ve)}We(t){this.forEachTarget(t,e=>{let n=this.Ge(e);switch(t.state){case 0:this.ze(e)&&n.De(t.resumeToken);break;case 1:n.Oe(),n.Se||n.ve(),n.De(t.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(e);break;case 3:this.ze(e)&&(n.Ne(),n.De(t.resumeToken));break;case 4:this.ze(e)&&(this.je(e),n.De(t.resumeToken));break;default:L()}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Be.forEach((n,i)=>{this.ze(i)&&e(i)})}He(t){let e=t.targetId,n=t.me.count,i=this.Je(e);if(i){let s=i.target;if(fs(s))if(n===0){let a=new M(s.path);this.Ue(e,a,wt.newNoDocument(a,B.min()))}else q(n===1);else{let a=this.Ye(e);if(a!==n){let u=this.Ze(t),l=u?this.Xe(u,t,a):1;if(l!==0){this.je(e);let d=l===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(e,d)}Yh?.et(function(f,g,y,S,N){var k,D,G,j,U,Q;let H={localCacheCount:f,existenceFilterCount:g.count,databaseId:y.database,projectId:y.projectId},z=g.unchangedNames;return z&&(H.bloomFilter={applied:N===0,hashCount:(k=z?.hashCount)!==null&&k!==void 0?k:0,bitmapLength:(j=(G=(D=z?.bits)===null||D===void 0?void 0:D.bitmap)===null||G===void 0?void 0:G.length)!==null&&j!==void 0?j:0,padding:(Q=(U=z?.bits)===null||U===void 0?void 0:U.padding)!==null&&Q!==void 0?Q:0,mightContain:v=>{var p;return(p=S?.mightContain(v))!==null&&p!==void 0&&p}}),H}(a,t.me,this.Le.tt(),u,l))}}}}Ze(t){let e=t.me.unchangedNames;if(!e||!e.bits)return null;let{bits:{bitmap:n="",padding:i=0},hashCount:s=0}=e,a,u;try{a=Fe(n).toUint8Array()}catch(l){if(l instanceof ls)return jt("Decoding the base64 bloom filter in existence filter failed ("+l.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw l}try{u=new Fa(a,i,s)}catch(l){return jt(l instanceof nn?"BloomFilter error: ":"Applying bloom filter failed: ",l),null}return u.Ie===0?null:u}Xe(t,e,n){return e.me.count===n-this.nt(t,e.targetId)?0:2}nt(t,e){let n=this.Le.getRemoteKeysForTarget(e),i=0;return n.forEach(s=>{let a=this.Le.tt(),u=`projects/${a.projectId}/databases/${a.database}/documents/${s.path.canonicalString()}`;t.mightContain(u)||(this.Ue(e,s,null),i++)}),i}rt(t){let e=new Map;this.Be.forEach((s,a)=>{let u=this.Je(a);if(u){if(s.current&&fs(u.target)){let l=new M(u.target.path);this.ke.get(l)!==null||this.it(a,l)||this.Ue(a,l,wt.newNoDocument(l,t))}s.be&&(e.set(a,s.Ce()),s.ve())}});let n=$();this.qe.forEach((s,a)=>{let u=!0;a.forEachWhile(l=>{let d=this.Je(l);return!d||d.purpose==="TargetPurposeLimboResolution"||(u=!1,!1)}),u&&(n=n.add(s))}),this.ke.forEach((s,a)=>a.setReadTime(t));let i=new ri(t,e,this.Qe,this.ke,n);return this.ke=Ot(),this.qe=td(),this.Qe=new st(K),i}$e(t,e){if(!this.ze(t))return;let n=this.it(t,e.key)?2:0;this.Ge(t).Fe(e.key,n),this.ke=this.ke.insert(e.key,e),this.qe=this.qe.insert(e.key,this.st(e.key).add(t))}Ue(t,e,n){if(!this.ze(t))return;let i=this.Ge(t);this.it(t,e)?i.Fe(e,1):i.Me(e),this.qe=this.qe.insert(e,this.st(e).delete(t)),n&&(this.ke=this.ke.insert(e,n))}removeTarget(t){this.Be.delete(t)}Ye(t){let e=this.Ge(t).Ce();return this.Le.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}xe(t){this.Ge(t).xe()}Ge(t){let e=this.Be.get(t);return e||(e=new ys,this.Be.set(t,e)),e}st(t){let e=this.qe.get(t);return e||(e=new nt(K),this.qe=this.qe.insert(t,e)),e}ze(t){let e=this.Je(t)!==null;return e||V("WatchChangeAggregator","Detected inactive target",t),e}Je(t){let e=this.Be.get(t);return e&&e.Se?null:this.Le.ot(t)}je(t){this.Be.set(t,new ys),this.Le.getRemoteKeysForTarget(t).forEach(e=>{this.Ue(t,e,null)})}it(t,e){return this.Le.getRemoteKeysForTarget(t).has(e)}};function td(){return new st(M.comparator)}function ed(){return new st(M.comparator)}var Sp={asc:"ASCENDING",desc:"DESCENDING"},bp={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Rp={and:"AND",or:"OR"},Oa=class{constructor(t,e){this.databaseId=t,this.useProto3Json=e}};function La(r,t){return r.useProto3Json||pi(t)?t:{value:t}}function Qn(r,t){return r.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function vf(r,t){return r.useProto3Json?t.toBase64():t.toUint8Array()}function Pp(r,t){return Qn(r,t.toTimestamp())}function mt(r){return q(!!r),B.fromTimestamp(function(e){let n=ge(e);return new at(n.seconds,n.nanos)}(r))}function hc(r,t){return qa(r,t).canonicalString()}function qa(r,t){let e=function(i){return new Y(["projects",i.projectId,"databases",i.database])}(r).child("documents");return t===void 0?e:e.child(t)}function If(r){let t=Y.fromString(r);return q(Vf(t)),t}function si(r,t){return hc(r.databaseId,t.path)}function ne(r,t){let e=If(t);if(e.get(1)!==r.databaseId.projectId)throw new x(P.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+r.databaseId.projectId);if(e.get(3)!==r.databaseId.database)throw new x(P.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+r.databaseId.database);return new M(Af(e))}function Ef(r,t){return hc(r.databaseId,t)}function Tf(r){let t=If(r);return t.length===4?Y.emptyPath():Af(t)}function Ua(r){return new Y(["projects",r.databaseId.projectId,"databases",r.databaseId.database]).canonicalString()}function Af(r){return q(r.length>4&&r.get(4)==="documents"),r.popFirst(5)}function nd(r,t,e){return{name:si(r,t),fields:e.value.mapValue.fields}}function Sf(r,t,e){let n=ne(r,t.name),i=mt(t.updateTime),s=t.createTime?mt(t.createTime):B.min(),a=new Vt({mapValue:{fields:t.fields}}),u=wt.newFoundDocument(n,i,s,a);return e&&u.setHasCommittedMutations(),e?u.setHasCommittedMutations():u}function Cp(r,t){return"found"in t?function(n,i){q(!!i.found),i.found.name,i.found.updateTime;let s=ne(n,i.found.name),a=mt(i.found.updateTime),u=i.found.createTime?mt(i.found.createTime):B.min(),l=new Vt({mapValue:{fields:i.found.fields}});return wt.newFoundDocument(s,a,u,l)}(r,t):"missing"in t?function(n,i){q(!!i.missing),q(!!i.readTime);let s=ne(n,i.missing),a=mt(i.readTime);return wt.newNoDocument(s,a)}(r,t):L()}function xp(r,t){let e;if("targetChange"in t){t.targetChange;let n=function(d){return d==="NO_CHANGE"?0:d==="ADD"?1:d==="REMOVE"?2:d==="CURRENT"?3:d==="RESET"?4:L()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=function(d,f){return d.useProto3Json?(q(f===void 0||typeof f=="string"),Et.fromBase64String(f||"")):(q(f===void 0||f instanceof Buffer||f instanceof Uint8Array),Et.fromUint8Array(f||new Uint8Array))}(r,t.targetChange.resumeToken),a=t.targetChange.cause,u=a&&function(d){let f=d.code===void 0?P.UNKNOWN:yf(d.code);return new x(f,d.message||"")}(a);e=new _s(n,i,s,u||null)}else if("documentChange"in t){t.documentChange;let n=t.documentChange;n.document,n.document.name,n.document.updateTime;let i=ne(r,n.document.name),s=mt(n.document.updateTime),a=n.document.createTime?mt(n.document.createTime):B.min(),u=new Vt({mapValue:{fields:n.document.fields}}),l=wt.newFoundDocument(i,s,a,u),d=n.targetIds||[],f=n.removedTargetIds||[];e=new Un(d,f,l.key,l)}else if("documentDelete"in t){t.documentDelete;let n=t.documentDelete;n.document;let i=ne(r,n.document),s=n.readTime?mt(n.readTime):B.min(),a=wt.newNoDocument(i,s),u=n.removedTargetIds||[];e=new Un([],u,a.key,a)}else if("documentRemove"in t){t.documentRemove;let n=t.documentRemove;n.document;let i=ne(r,n.document),s=n.removedTargetIds||[];e=new Un([],s,i,null)}else{if(!("filter"in t))return L();{t.filter;let n=t.filter;n.targetId;let{count:i=0,unchangedNames:s}=n,a=new ka(i,s),u=n.targetId;e=new ps(u,a)}}return e}function oi(r,t){let e;if(t instanceof Ue)e={update:nd(r,t.key,t.value)};else if(t instanceof Be)e={delete:si(r,t.key)};else if(t instanceof Ht)e={update:nd(r,t.key,t.data),updateMask:Mp(t.fieldMask)};else{if(!(t instanceof ti))return L();e={verify:si(r,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(n=>function(s,a){let u=a.transform;if(u instanceof Le)return{fieldPath:a.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(u instanceof pe)return{fieldPath:a.field.canonicalString(),appendMissingElements:{values:u.elements}};if(u instanceof _e)return{fieldPath:a.field.canonicalString(),removeAllFromArray:{values:u.elements}};if(u instanceof qe)return{fieldPath:a.field.canonicalString(),increment:u.Pe};throw L()}(0,n))),t.precondition.isNone||(e.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:Pp(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:L()}(r,t.precondition)),e}function Ba(r,t){let e=t.currentDocument?function(s){return s.updateTime!==void 0?ht.updateTime(mt(s.updateTime)):s.exists!==void 0?ht.exists(s.exists):ht.none()}(t.currentDocument):ht.none(),n=t.updateTransforms?t.updateTransforms.map(i=>function(a,u){let l=null;if("setToServerValue"in u)q(u.setToServerValue==="REQUEST_TIME"),l=new Le;else if("appendMissingElements"in u){let f=u.appendMissingElements.values||[];l=new pe(f)}else if("removeAllFromArray"in u){let f=u.removeAllFromArray.values||[];l=new _e(f)}else"increment"in u?l=new qe(a,u.increment):L();let d=ft.fromServerFormat(u.fieldPath);return new cn(d,l)}(r,i)):[];if(t.update){t.update.name;let i=ne(r,t.update.name),s=new Vt({mapValue:{fields:t.update.fields}});if(t.updateMask){let a=function(l){let d=l.fieldPaths||[];return new Ut(d.map(f=>ft.fromServerFormat(f)))}(t.updateMask);return new Ht(i,s,a,e,n)}return new Ue(i,s,e,n)}if(t.delete){let i=ne(r,t.delete);return new Be(i,e)}if(t.verify){let i=ne(r,t.verify);return new ti(i,e)}return L()}function Vp(r,t){return r&&r.length>0?(q(t!==void 0),r.map(e=>function(i,s){let a=i.updateTime?mt(i.updateTime):mt(s);return a.isEqual(B.min())&&(a=mt(s)),new Da(a,i.transformResults||[])}(e,t))):[]}function bf(r,t){return{documents:[Ef(r,t.path)]}}function Rf(r,t){let e={structuredQuery:{}},n=t.path,i;t.collectionGroup!==null?(i=n,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=n.popLast(),e.structuredQuery.from=[{collectionId:n.lastSegment()}]),e.parent=Ef(r,i);let s=function(d){if(d.length!==0)return xf(tt.create(d,"and"))}(t.filters);s&&(e.structuredQuery.where=s);let a=function(d){if(d.length!==0)return d.map(f=>function(y){return{field:kn(y.field),direction:Np(y.dir)}}(f))}(t.orderBy);a&&(e.structuredQuery.orderBy=a);let u=La(r,t.limit);return u!==null&&(e.structuredQuery.limit=u),t.startAt&&(e.structuredQuery.startAt=function(d){return{before:d.inclusive,values:d.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(d){return{before:!d.inclusive,values:d.position}}(t.endAt)),{_t:e,parent:i}}function Pf(r){let t=Tf(r.parent),e=r.structuredQuery,n=e.from?e.from.length:0,i=null;if(n>0){q(n===1);let f=e.from[0];f.allDescendants?i=f.collectionId:t=t.child(f.collectionId)}let s=[];e.where&&(s=function(g){let y=Cf(g);return y instanceof tt&&uc(y)?y.getFilters():[y]}(e.where));let a=[];e.orderBy&&(a=function(g){return g.map(y=>function(N){return new an(Fn(N.field),function(D){switch(D){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(N.direction))}(y))}(e.orderBy));let u=null;e.limit&&(u=function(g){let y;return y=typeof g=="object"?g.value:g,pi(y)?null:y}(e.limit));let l=null;e.startAt&&(l=function(g){let y=!!g.before,S=g.values||[];return new se(S,y)}(e.startAt));let d=null;return e.endAt&&(d=function(g){let y=!g.before,S=g.values||[];return new se(S,y)}(e.endAt)),tf(t,i,a,s,u,"F",l,d)}function Dp(r,t){let e=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return L()}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function Cf(r){return r.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":let n=Fn(e.unaryFilter.field);return W.create(n,"==",{doubleValue:NaN});case"IS_NULL":let i=Fn(e.unaryFilter.field);return W.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=Fn(e.unaryFilter.field);return W.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let a=Fn(e.unaryFilter.field);return W.create(a,"!=",{nullValue:"NULL_VALUE"});default:return L()}}(r):r.fieldFilter!==void 0?function(e){return W.create(Fn(e.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return L()}}(e.fieldFilter.op),e.fieldFilter.value)}(r):r.compositeFilter!==void 0?function(e){return tt.create(e.compositeFilter.filters.map(n=>Cf(n)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return L()}}(e.compositeFilter.op))}(r):L()}function Np(r){return Sp[r]}function kp(r){return bp[r]}function Fp(r){return Rp[r]}function kn(r){return{fieldPath:r.canonicalString()}}function Fn(r){return ft.fromServerFormat(r.fieldPath)}function xf(r){return r instanceof W?function(e){if(e.op==="=="){if(qh(e.value))return{unaryFilter:{field:kn(e.field),op:"IS_NAN"}};if(Lh(e.value))return{unaryFilter:{field:kn(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(qh(e.value))return{unaryFilter:{field:kn(e.field),op:"IS_NOT_NAN"}};if(Lh(e.value))return{unaryFilter:{field:kn(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:kn(e.field),op:kp(e.op),value:e.value}}}(r):r instanceof tt?function(e){let n=e.getFilters().map(i=>xf(i));return n.length===1?n[0]:{compositeFilter:{op:Fp(e.op),filters:n}}}(r):L()}function Mp(r){let t=[];return r.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function Vf(r){return r.length>=4&&r.get(0)==="projects"&&r.get(2)==="databases"}var Wn=class r{constructor(t,e,n,i,s=B.min(),a=B.min(),u=Et.EMPTY_BYTE_STRING,l=null){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=a,this.resumeToken=u,this.expectedCount=l}withSequenceNumber(t){return new r(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new r(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new r(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new r(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}};var ws=class{constructor(t){this.ct=t}};function Op(r,t){let e;if(t.document)e=Sf(r.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let n=M.fromSegments(t.noDocument.path),i=hn(t.noDocument.readTime);e=wt.newNoDocument(n,i),t.hasCommittedMutations&&e.setHasCommittedMutations()}else{if(!t.unknownDocument)return L();{let n=M.fromSegments(t.unknownDocument.path),i=hn(t.unknownDocument.version);e=wt.newUnknownDocument(n,i)}}return t.readTime&&e.setReadTime(function(i){let s=new at(i[0],i[1]);return B.fromTimestamp(s)}(t.readTime)),e}function rd(r,t){let e=t.key,n={prefixPath:e.getCollectionPath().popLast().toArray(),collectionGroup:e.collectionGroup,documentId:e.path.lastSegment(),readTime:vs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())n.document=function(s,a){return{name:si(s,a.key),fields:a.data.value.mapValue.fields,updateTime:Qn(s,a.version.toTimestamp()),createTime:Qn(s,a.createTime.toTimestamp())}}(r.ct,t);else if(t.isNoDocument())n.noDocument={path:e.path.toArray(),readTime:ln(t.version)};else{if(!t.isUnknownDocument())return L();n.unknownDocument={path:e.path.toArray(),version:ln(t.version)}}return n}function vs(r){let t=r.toTimestamp();return[t.seconds,t.nanoseconds]}function ln(r){let t=r.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function hn(r){let t=new at(r.seconds,r.nanoseconds);return B.fromTimestamp(t)}function Ze(r,t){let e=(t.baseMutations||[]).map(s=>Ba(r.ct,s));for(let s=0;s<t.mutations.length-1;++s){let a=t.mutations[s];if(s+1<t.mutations.length&&t.mutations[s+1].transform!==void 0){let u=t.mutations[s+1];a.updateTransforms=u.transform.fieldTransforms,t.mutations.splice(s+1,1),++s}}let n=t.mutations.map(s=>Ba(r.ct,s)),i=at.fromMillis(t.localWriteTimeMs);return new ei(t.batchId,i,e,n)}function Gr(r){let t=hn(r.readTime),e=r.lastLimboFreeSnapshotVersion!==void 0?hn(r.lastLimboFreeSnapshotVersion):B.min(),n;return n=function(s){return s.documents!==void 0}(r.query)?function(s){return q(s.documents.length===1),Ft(sr(Tf(s.documents[0])))}(r.query):function(s){return Ft(Pf(s))}(r.query),new Wn(n,r.targetId,"TargetPurposeListen",r.lastListenSequenceNumber,t,e,Et.fromBase64String(r.resumeToken))}function Df(r,t){let e=ln(t.snapshotVersion),n=ln(t.lastLimboFreeSnapshotVersion),i;i=fs(t.target)?bf(r.ct,t.target):Rf(r.ct,t.target)._t;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:un(t.target),readTime:e,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:n,query:i}}function dc(r){let t=Pf({parent:r.parent,structuredQuery:r.structuredQuery});return r.limitType==="LAST"?gs(t,t.limit,"L"):t}function na(r,t){return new ni(t.largestBatchId,Ba(r.ct,t.overlayMutation))}function id(r,t){let e=t.path.lastSegment();return[r,kt(t.path.popLast()),e]}function sd(r,t,e,n){return{indexId:r,uid:t,sequenceNumber:e,readTime:ln(n.readTime),documentKey:kt(n.documentKey.path),largestBatchId:n.largestBatchId}}var Ga=class{getBundleMetadata(t,e){return od(t).get(e).next(n=>{if(n)return function(s){return{id:s.bundleId,createTime:hn(s.createTime),version:s.version}}(n)})}saveBundleMetadata(t,e){return od(t).put(function(i){return{bundleId:i.id,createTime:ln(mt(i.createTime)),version:i.version}}(e))}getNamedQuery(t,e){return ad(t).get(e).next(n=>{if(n)return function(s){return{name:s.name,query:dc(s.bundledQuery),readTime:hn(s.readTime)}}(n)})}saveNamedQuery(t,e){return ad(t).put(function(i){return{name:i.name,readTime:ln(mt(i.readTime)),bundledQuery:i.bundledQuery}}(e))}};function od(r){return Tt(r,"bundles")}function ad(r){return Tt(r,"namedQueries")}var Is=class r{constructor(t,e){this.serializer=t,this.userId=e}static lt(t,e){let n=e.uid||"";return new r(t,n)}getOverlay(t,e){return Or(t).get(id(this.userId,e)).next(n=>n?na(this.serializer,n):null)}getOverlays(t,e){let n=te();return b.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&n.set(i,s)})).next(()=>n)}saveOverlays(t,e,n){let i=[];return n.forEach((s,a)=>{let u=new ni(e,a);i.push(this.ht(t,u))}),b.waitFor(i)}removeOverlaysForBatchId(t,e,n){let i=new Set;e.forEach(a=>i.add(kt(a.getCollectionPath())));let s=[];return i.forEach(a=>{let u=IDBKeyRange.bound([this.userId,a,n],[this.userId,a,n+1],!1,!0);s.push(Or(t).j("collectionPathOverlayIndex",u))}),b.waitFor(s)}getOverlaysForCollection(t,e,n){let i=te(),s=kt(e),a=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Or(t).U("collectionPathOverlayIndex",a).next(u=>{for(let l of u){let d=na(this.serializer,l);i.set(d.getKey(),d)}return i})}getOverlaysForCollectionGroup(t,e,n,i){let s=te(),a,u=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Or(t).J({index:"collectionGroupOverlayIndex",range:u},(l,d,f)=>{let g=na(this.serializer,d);s.size()<i||g.largestBatchId===a?(s.set(g.getKey(),g),a=g.largestBatchId):f.done()}).next(()=>s)}ht(t,e){return Or(t).put(function(i,s,a){let[u,l,d]=id(s,a.mutation.key);return{userId:s,collectionPath:l,documentId:d,collectionGroup:a.mutation.key.getCollectionGroup(),largestBatchId:a.largestBatchId,overlayMutation:oi(i.ct,a.mutation)}}(this.serializer,this.userId,e))}};function Or(r){return Tt(r,"documentOverlays")}var fe=class{constructor(){}Pt(t,e){this.It(t,e),e.Tt()}It(t,e){if("nullValue"in t)this.Et(e,5);else if("booleanValue"in t)this.Et(e,10),e.dt(t.booleanValue?1:0);else if("integerValue"in t)this.Et(e,15),e.dt(lt(t.integerValue));else if("doubleValue"in t){let n=lt(t.doubleValue);isNaN(n)?this.Et(e,13):(this.Et(e,15),Hr(n)?e.dt(0):e.dt(n))}else if("timestampValue"in t){let n=t.timestampValue;this.Et(e,20),typeof n=="string"&&(n=ge(n)),e.At(`${n.seconds||""}`),e.dt(n.nanos||0)}else if("stringValue"in t)this.Rt(t.stringValue,e),this.Vt(e);else if("bytesValue"in t)this.Et(e,30),e.ft(Fe(t.bytesValue)),this.Vt(e);else if("referenceValue"in t)this.gt(t.referenceValue,e);else if("geoPointValue"in t){let n=t.geoPointValue;this.Et(e,45),e.dt(n.latitude||0),e.dt(n.longitude||0)}else"mapValue"in t?Qd(t)?this.Et(e,Number.MAX_SAFE_INTEGER):(this.yt(t.mapValue,e),this.Vt(e)):"arrayValue"in t?(this.wt(t.arrayValue,e),this.Vt(e)):L()}Rt(t,e){this.Et(e,25),this.St(t,e)}St(t,e){e.At(t)}yt(t,e){let n=t.fields||{};this.Et(e,55);for(let i of Object.keys(n))this.Rt(i,e),this.It(n[i],e)}wt(t,e){let n=t.values||[];this.Et(e,50);for(let i of n)this.It(i,e)}gt(t,e){this.Et(e,37),M.fromName(t).path.forEach(n=>{this.Et(e,60),this.St(n,e)})}Et(t,e){t.dt(e)}Vt(t){t.dt(2)}};fe.bt=new fe;function Lp(r){if(r===0)return 8;let t=0;return!(r>>4)&&(t+=4,r<<=4),!(r>>6)&&(t+=2,r<<=2),!(r>>7)&&(t+=1),t}function ud(r){let t=64-function(n){let i=0;for(let s=0;s<8;++s){let a=Lp(255&n[s]);if(i+=a,a!==8)break}return i}(r);return Math.ceil(t/8)}var ja=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(t){let e=t[Symbol.iterator](),n=e.next();for(;!n.done;)this.Ct(n.value),n=e.next();this.vt()}Ft(t){let e=t[Symbol.iterator](),n=e.next();for(;!n.done;)this.Mt(n.value),n=e.next();this.xt()}Ot(t){for(let e of t){let n=e.charCodeAt(0);if(n<128)this.Ct(n);else if(n<2048)this.Ct(960|n>>>6),this.Ct(128|63&n);else if(e<"\uD800"||"\uDBFF"<e)this.Ct(480|n>>>12),this.Ct(128|63&n>>>6),this.Ct(128|63&n);else{let i=e.codePointAt(0);this.Ct(240|i>>>18),this.Ct(128|63&i>>>12),this.Ct(128|63&i>>>6),this.Ct(128|63&i)}}this.vt()}Nt(t){for(let e of t){let n=e.charCodeAt(0);if(n<128)this.Mt(n);else if(n<2048)this.Mt(960|n>>>6),this.Mt(128|63&n);else if(e<"\uD800"||"\uDBFF"<e)this.Mt(480|n>>>12),this.Mt(128|63&n>>>6),this.Mt(128|63&n);else{let i=e.codePointAt(0);this.Mt(240|i>>>18),this.Mt(128|63&i>>>12),this.Mt(128|63&i>>>6),this.Mt(128|63&i)}}this.xt()}Lt(t){let e=this.Bt(t),n=ud(e);this.kt(1+n),this.buffer[this.position++]=255&n;for(let i=e.length-n;i<e.length;++i)this.buffer[this.position++]=255&e[i]}qt(t){let e=this.Bt(t),n=ud(e);this.kt(1+n),this.buffer[this.position++]=~(255&n);for(let i=e.length-n;i<e.length;++i)this.buffer[this.position++]=~(255&e[i])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(t){this.kt(t.length),this.buffer.set(t,this.position),this.position+=t.length}Wt(){return this.buffer.slice(0,this.position)}Bt(t){let e=function(s){let a=new DataView(new ArrayBuffer(8));return a.setFloat64(0,s,!1),new Uint8Array(a.buffer)}(t),n=(128&e[0])!=0;e[0]^=n?255:128;for(let i=1;i<e.length;++i)e[i]^=n?255:0;return e}Ct(t){let e=255&t;e===0?(this.Kt(0),this.Kt(255)):e===255?(this.Kt(255),this.Kt(0)):this.Kt(e)}Mt(t){let e=255&t;e===0?(this.Ut(0),this.Ut(255)):e===255?(this.Ut(255),this.Ut(0)):this.Ut(t)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(t){this.kt(1),this.buffer[this.position++]=t}Ut(t){this.kt(1),this.buffer[this.position++]=~t}kt(t){let e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);let i=new Uint8Array(n);i.set(this.buffer),this.buffer=i}},za=class{constructor(t){this.Gt=t}ft(t){this.Gt.Dt(t)}At(t){this.Gt.Ot(t)}dt(t){this.Gt.Lt(t)}Tt(){this.Gt.Qt()}},Ka=class{constructor(t){this.Gt=t}ft(t){this.Gt.Ft(t)}At(t){this.Gt.Nt(t)}dt(t){this.Gt.qt(t)}Tt(){this.Gt.$t()}},tn=class{constructor(){this.Gt=new ja,this.zt=new za(this.Gt),this.jt=new Ka(this.Gt)}seed(t){this.Gt.seed(t)}Ht(t){return t===0?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}};var en=class r{constructor(t,e,n,i){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=i}Jt(){let t=this.directionalValue.length,e=t===0||this.directionalValue[t-1]===255?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new r(this.indexId,this.documentKey,this.arrayValue,n)}};function Re(r,t){let e=r.indexId-t.indexId;return e!==0?e:(e=cd(r.arrayValue,t.arrayValue),e!==0?e:(e=cd(r.directionalValue,t.directionalValue),e!==0?e:M.comparator(r.documentKey,t.documentKey)))}function cd(r,t){for(let e=0;e<r.length&&e<t.length;++e){let n=r[e]-t[e];if(n!==0)return n}return r.length-t.length}var Es=class{constructor(t){this.Yt=new nt((e,n)=>ft.comparator(e.field,n.field)),this.collectionId=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment(),this.Zt=t.orderBy,this.Xt=[];for(let e of t.filters){let n=e;n.isInequality()?this.Yt=this.Yt.add(n):this.Xt.push(n)}}get en(){return this.Yt.size>1}tn(t){if(q(t.collectionGroup===this.collectionId),this.en)return!1;let e=fa(t);if(e!==void 0&&!this.nn(e))return!1;let n=Ye(t),i=new Set,s=0,a=0;for(;s<n.length&&this.nn(n[s]);++s)i=i.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Yt.size>0){let u=this.Yt.getIterator().getNext();if(!i.has(u.field.canonicalString())){let l=n[s];if(!this.rn(u,l)||!this.sn(this.Zt[a++],l))return!1}++s}for(;s<n.length;++s){let u=n[s];if(a>=this.Zt.length||!this.sn(this.Zt[a++],u))return!1}return!0}on(){if(this.en)return null;let t=new nt(ft.comparator),e=[];for(let n of this.Xt)if(!n.field.isKeyField())if(n.op==="array-contains"||n.op==="array-contains-any")e.push(new Ln(n.field,2));else{if(t.has(n.field))continue;t=t.add(n.field),e.push(new Ln(n.field,0))}for(let n of this.Zt)n.field.isKeyField()||t.has(n.field)||(t=t.add(n.field),e.push(new Ln(n.field,n.dir==="asc"?0:1)));return new Gn(Gn.UNKNOWN_ID,this.collectionId,e,Wr.empty())}nn(t){for(let e of this.Xt)if(this.rn(e,t))return!0;return!1}rn(t,e){if(t===void 0||!t.field.isEqual(e.fieldPath))return!1;let n=t.op==="array-contains"||t.op==="array-contains-any";return e.kind===2===n}sn(t,e){return!!t.field.isEqual(e.fieldPath)&&(e.kind===0&&t.dir==="asc"||e.kind===1&&t.dir==="desc")}};function Nf(r){var t,e;if(q(r instanceof W||r instanceof tt),r instanceof W){if(r instanceof ds){let i=((e=(t=r.value.arrayValue)===null||t===void 0?void 0:t.values)===null||e===void 0?void 0:e.map(s=>W.create(r.field,"==",s)))||[];return tt.create(i,"or")}return r}let n=r.filters.map(i=>Nf(i));return tt.create(n,r.op)}function qp(r){if(r.getFilters().length===0)return[];let t=Wa(Nf(r));return q(kf(t)),$a(t)||Qa(t)?[t]:t.getFilters()}function $a(r){return r instanceof W}function Qa(r){return r instanceof tt&&uc(r)}function kf(r){return $a(r)||Qa(r)||function(e){if(e instanceof tt&&Ia(e)){for(let n of e.getFilters())if(!$a(n)&&!Qa(n))return!1;return!0}return!1}(r)}function Wa(r){if(q(r instanceof W||r instanceof tt),r instanceof W)return r;if(r.filters.length===1)return Wa(r.filters[0]);let t=r.filters.map(n=>Wa(n)),e=tt.create(t,r.op);return e=Ts(e),kf(e)?e:(q(e instanceof tt),q(zn(e)),q(e.filters.length>1),e.filters.reduce((n,i)=>fc(n,i)))}function fc(r,t){let e;return q(r instanceof W||r instanceof tt),q(t instanceof W||t instanceof tt),e=r instanceof W?t instanceof W?function(i,s){return tt.create([i,s],"and")}(r,t):ld(r,t):t instanceof W?ld(t,r):function(i,s){if(q(i.filters.length>0&&s.filters.length>0),zn(i)&&zn(s))return Yd(i,s.getFilters());let a=Ia(i)?i:s,u=Ia(i)?s:i,l=a.filters.map(d=>fc(d,u));return tt.create(l,"or")}(r,t),Ts(e)}function ld(r,t){if(zn(t))return Yd(t,r.getFilters());{let e=t.filters.map(n=>fc(r,n));return tt.create(e,"or")}}function Ts(r){if(q(r instanceof W||r instanceof tt),r instanceof W)return r;let t=r.getFilters();if(t.length===1)return Ts(t[0]);if(Hd(r))return r;let e=t.map(i=>Ts(i)),n=[];return e.forEach(i=>{i instanceof W?n.push(i):i instanceof tt&&(i.op===r.op?n.push(...i.filters):n.push(i))}),n.length===1?n[0]:tt.create(n,r.op)}var Ha=class{constructor(){this._n=new ai}addToCollectionParentIndex(t,e){return this._n.add(e),b.resolve()}getCollectionParents(t,e){return b.resolve(this._n.getEntries(e))}addFieldIndex(t,e){return b.resolve()}deleteFieldIndex(t,e){return b.resolve()}deleteAllFieldIndexes(t){return b.resolve()}createTargetIndexes(t,e){return b.resolve()}getDocumentsMatchingTarget(t,e){return b.resolve(null)}getIndexType(t,e){return b.resolve(0)}getFieldIndexes(t,e){return b.resolve([])}getNextCollectionGroupToUpdate(t){return b.resolve(null)}getMinOffset(t,e){return b.resolve(zt.min())}getMinOffsetFromCollectionGroup(t,e){return b.resolve(zt.min())}updateCollectionGroup(t,e,n){return b.resolve()}updateIndexEntries(t,e){return b.resolve()}},ai=class{constructor(){this.index={}}add(t){let e=t.lastSegment(),n=t.popLast(),i=this.index[e]||new nt(Y.comparator),s=!i.has(n);return this.index[e]=i.add(n),s}has(t){let e=t.lastSegment(),n=t.popLast(),i=this.index[e];return i&&i.has(n)}getEntries(t){return(this.index[t]||new nt(Y.comparator)).toArray()}};var Wi=new Uint8Array(0),Ja=class{constructor(t,e){this.databaseId=e,this.an=new ai,this.un=new oe(n=>un(n),(n,i)=>_i(n,i)),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.an.has(e)){let n=e.lastSegment(),i=e.popLast();t.addOnCommittedListener(()=>{this.an.add(e)});let s={collectionId:n,parent:kt(i)};return hd(t).put(s)}return b.resolve()}getCollectionParents(t,e){let n=[],i=IDBKeyRange.bound([e,""],[kd(e),""],!1,!0);return hd(t).U(i).next(s=>{for(let a of s){if(a.collectionId!==e)break;n.push(Zt(a.parent))}return n})}addFieldIndex(t,e){let n=Lr(t),i=function(u){return{indexId:u.indexId,collectionGroup:u.collectionGroup,fields:u.fields.map(l=>[l.fieldPath.canonicalString(),l.kind])}}(e);delete i.indexId;let s=n.add(i);if(e.indexState){let a=xn(t);return s.next(u=>{a.put(sd(u,this.uid,e.indexState.sequenceNumber,e.indexState.offset))})}return s.next()}deleteFieldIndex(t,e){let n=Lr(t),i=xn(t),s=Cn(t);return n.delete(e.indexId).next(()=>i.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))}deleteAllFieldIndexes(t){let e=Lr(t),n=Cn(t),i=xn(t);return e.j().next(()=>n.j()).next(()=>i.j())}createTargetIndexes(t,e){return b.forEach(this.cn(e),n=>this.getIndexType(t,n).next(i=>{if(i===0||i===1){let s=new Es(n).on();if(s!=null)return this.addFieldIndex(t,s)}}))}getDocumentsMatchingTarget(t,e){let n=Cn(t),i=!0,s=new Map;return b.forEach(this.cn(e),a=>this.ln(t,a).next(u=>{i&&(i=!!u),s.set(a,u)})).next(()=>{if(i){let a=$(),u=[];return b.forEach(s,(l,d)=>{V("IndexedDbIndexManager",`Using index ${function(U){return`id=${U.indexId}|cg=${U.collectionGroup}|f=${U.fields.map(Q=>`${Q.fieldPath}:${Q.kind}`).join(",")}`}(l)} to execute ${un(e)}`);let f=function(U,Q){let H=fa(Q);if(H===void 0)return null;for(let z of ms(U,H.fieldPath))switch(z.op){case"array-contains-any":return z.value.arrayValue.values||[];case"array-contains":return[z.value]}return null}(d,l),g=function(U,Q){let H=new Map;for(let z of Ye(Q))for(let v of ms(U,z.fieldPath))switch(v.op){case"==":case"in":H.set(z.fieldPath.canonicalString(),v.value);break;case"not-in":case"!=":return H.set(z.fieldPath.canonicalString(),v.value),Array.from(H.values())}return null}(d,l),y=function(U,Q){let H=[],z=!0;for(let v of Ye(Q)){let p=v.kind===0?zh(U,v.fieldPath,U.startAt):Kh(U,v.fieldPath,U.startAt);H.push(p.value),z&&(z=p.inclusive)}return new se(H,z)}(d,l),S=function(U,Q){let H=[],z=!0;for(let v of Ye(Q)){let p=v.kind===0?Kh(U,v.fieldPath,U.endAt):zh(U,v.fieldPath,U.endAt);H.push(p.value),z&&(z=p.inclusive)}return new se(H,z)}(d,l),N=this.hn(l,d,y),k=this.hn(l,d,S),D=this.Pn(l,d,g),G=this.In(l.indexId,f,N,y.inclusive,k,S.inclusive,D);return b.forEach(G,j=>n.G(j,e.limit).next(U=>{U.forEach(Q=>{let H=M.fromSegments(Q.documentKey);a.has(H)||(a=a.add(H),u.push(H))})}))}).next(()=>u)}return b.resolve(null)})}cn(t){let e=this.un.get(t);return e||(t.filters.length===0?e=[t]:e=qp(tt.create(t.filters,"and")).map(n=>xa(t.path,t.collectionGroup,t.orderBy,n.getFilters(),t.limit,t.startAt,t.endAt)),this.un.set(t,e),e)}In(t,e,n,i,s,a,u){let l=(e!=null?e.length:1)*Math.max(n.length,s.length),d=l/(e!=null?e.length:1),f=[];for(let g=0;g<l;++g){let y=e?this.Tn(e[g/d]):Wi,S=this.En(t,y,n[g%d],i),N=this.dn(t,y,s[g%d],a),k=u.map(D=>this.En(t,y,D,!0));f.push(...this.createRange(S,N,k))}return f}En(t,e,n,i){let s=new en(t,M.empty(),e,n);return i?s:s.Jt()}dn(t,e,n,i){let s=new en(t,M.empty(),e,n);return i?s.Jt():s}ln(t,e){let n=new Es(e),i=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,i).next(s=>{let a=null;for(let u of s)n.tn(u)&&(!a||u.fields.length>a.fields.length)&&(a=u);return a})}getIndexType(t,e){let n=2,i=this.cn(e);return b.forEach(i,s=>this.ln(t,s).next(a=>{a?n!==0&&a.fields.length<function(l){let d=new nt(ft.comparator),f=!1;for(let g of l.filters)for(let y of g.getFlattenedFilters())y.field.isKeyField()||(y.op==="array-contains"||y.op==="array-contains-any"?f=!0:d=d.add(y.field));for(let g of l.orderBy)g.field.isKeyField()||(d=d.add(g.field));return d.size+(f?1:0)}(s)&&(n=1):n=0})).next(()=>function(a){return a.limit!==null}(e)&&i.length>1&&n===2?1:n)}An(t,e){let n=new tn;for(let i of Ye(t)){let s=e.data.field(i.fieldPath);if(s==null)return null;let a=n.Ht(i.kind);fe.bt.Pt(s,a)}return n.Wt()}Tn(t){let e=new tn;return fe.bt.Pt(t,e.Ht(0)),e.Wt()}Rn(t,e){let n=new tn;return fe.bt.Pt(on(this.databaseId,e),n.Ht(function(s){let a=Ye(s);return a.length===0?0:a[a.length-1].kind}(t))),n.Wt()}Pn(t,e,n){if(n===null)return[];let i=[];i.push(new tn);let s=0;for(let a of Ye(t)){let u=n[s++];for(let l of i)if(this.Vn(e,a.fieldPath)&&Zr(u))i=this.mn(i,a,u);else{let d=l.Ht(a.kind);fe.bt.Pt(u,d)}}return this.fn(i)}hn(t,e,n){return this.Pn(t,e,n.position)}fn(t){let e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Wt();return e}mn(t,e,n){let i=[...t],s=[];for(let a of n.arrayValue.values||[])for(let u of i){let l=new tn;l.seed(u.Wt()),fe.bt.Pt(a,l.Ht(e.kind)),s.push(l)}return s}Vn(t,e){return!!t.filters.find(n=>n instanceof W&&n.field.isEqual(e)&&(n.op==="in"||n.op==="not-in"))}getFieldIndexes(t,e){let n=Lr(t),i=xn(t);return(e?n.U("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.U()).next(s=>{let a=[];return b.forEach(s,u=>i.get([u.indexId,this.uid]).next(l=>{a.push(function(f,g){let y=g?new Wr(g.sequenceNumber,new zt(hn(g.readTime),new M(Zt(g.documentKey)),g.largestBatchId)):Wr.empty(),S=f.fields.map(([N,k])=>new Ln(ft.fromServerFormat(N),k));return new Gn(f.indexId,f.collectionGroup,S,y)}(u,l))})).next(()=>a)})}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next(e=>e.length===0?null:(e.sort((n,i)=>{let s=n.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:K(n.collectionGroup,i.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(t,e,n){let i=Lr(t),s=xn(t);return this.gn(t).next(a=>i.U("collectionGroupIndex",IDBKeyRange.bound(e,e)).next(u=>b.forEach(u,l=>s.put(sd(l.indexId,this.uid,a,n)))))}updateIndexEntries(t,e){let n=new Map;return b.forEach(e,(i,s)=>{let a=n.get(i.collectionGroup);return(a?b.resolve(a):this.getFieldIndexes(t,i.collectionGroup)).next(u=>(n.set(i.collectionGroup,u),b.forEach(u,l=>this.pn(t,i,l).next(d=>{let f=this.yn(s,l);return d.isEqual(f)?b.resolve():this.wn(t,s,l,d,f)}))))})}Sn(t,e,n,i){return Cn(t).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.Rn(n,e.key),documentKey:e.key.path.toArray()})}bn(t,e,n,i){return Cn(t).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.Rn(n,e.key),e.key.path.toArray()])}pn(t,e,n){let i=Cn(t),s=new nt(Re);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.Rn(n,e)])},(a,u)=>{s=s.add(new en(n.indexId,e,u.arrayValue,u.directionalValue))}).next(()=>s)}yn(t,e){let n=new nt(Re),i=this.An(e,t);if(i==null)return n;let s=fa(e);if(s!=null){let a=t.data.field(s.fieldPath);if(Zr(a))for(let u of a.arrayValue.values||[])n=n.add(new en(e.indexId,t.key,this.Tn(u),i))}else n=n.add(new en(e.indexId,t.key,Wi,i));return n}wn(t,e,n,i,s){V("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);let a=[];return function(l,d,f,g,y){let S=l.getIterator(),N=d.getIterator(),k=Pn(S),D=Pn(N);for(;k||D;){let G=!1,j=!1;if(k&&D){let U=f(k,D);U<0?j=!0:U>0&&(G=!0)}else k!=null?j=!0:G=!0;G?(g(D),D=Pn(N)):j?(y(k),k=Pn(S)):(k=Pn(S),D=Pn(N))}}(i,s,Re,u=>{a.push(this.Sn(t,e,n,u))},u=>{a.push(this.bn(t,e,n,u))}),b.waitFor(a)}gn(t){let e=1;return xn(t).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(n,i,s)=>{s.done(),e=i.sequenceNumber+1}).next(()=>e)}createRange(t,e,n){n=n.sort((a,u)=>Re(a,u)).filter((a,u,l)=>!u||Re(a,l[u-1])!==0);let i=[];i.push(t);for(let a of n){let u=Re(a,t),l=Re(a,e);if(u===0)i[0]=t.Jt();else if(u>0&&l<0)i.push(a),i.push(a.Jt());else if(l>0)break}i.push(e);let s=[];for(let a=0;a<i.length;a+=2){if(this.Dn(i[a],i[a+1]))return[];let u=[i[a].indexId,this.uid,i[a].arrayValue,i[a].directionalValue,Wi,[]],l=[i[a+1].indexId,this.uid,i[a+1].arrayValue,i[a+1].directionalValue,Wi,[]];s.push(IDBKeyRange.bound(u,l))}return s}Dn(t,e){return Re(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(dd)}getMinOffset(t,e){return b.mapArray(this.cn(e),n=>this.ln(t,n).next(i=>i||L())).next(dd)}};function hd(r){return Tt(r,"collectionParents")}function Cn(r){return Tt(r,"indexEntries")}function Lr(r){return Tt(r,"indexConfiguration")}function xn(r){return Tt(r,"indexState")}function dd(r){q(r.length!==0);let t=r[0].indexState.offset,e=t.largestBatchId;for(let n=1;n<r.length;n++){let i=r[n].indexState.offset;sc(i,t)<0&&(t=i),e<i.largestBatchId&&(e=i.largestBatchId)}return new zt(t.readTime,t.documentKey,e)}var fd={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Gt=class r{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new r(t,r.DEFAULT_COLLECTION_PERCENTILE,r.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function Ff(r,t,e){let n=r.store("mutations"),i=r.store("documentMutations"),s=[],a=IDBKeyRange.only(e.batchId),u=0,l=n.J({range:a},(f,g,y)=>(u++,y.delete()));s.push(l.next(()=>{q(u===1)}));let d=[];for(let f of e.mutations){let g=Ud(t,f.key.path,e.batchId);s.push(i.delete(g)),d.push(f.key)}return b.waitFor(s).next(()=>d)}function As(r){if(!r)return 0;let t;if(r.document)t=r.document;else if(r.unknownDocument)t=r.unknownDocument;else{if(!r.noDocument)throw L();t=r.noDocument}return JSON.stringify(t).length}Gt.DEFAULT_COLLECTION_PERCENTILE=10,Gt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Gt.DEFAULT=new Gt(41943040,Gt.DEFAULT_COLLECTION_PERCENTILE,Gt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Gt.DISABLED=new Gt(-1,0,0);var Ss=class r{constructor(t,e,n,i){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=i,this.Cn={}}static lt(t,e,n,i){q(t.uid!=="");let s=t.isAuthenticated()?t.uid:"";return new r(s,e,n,i)}checkEmpty(t){let e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Pe(t).J({index:"userMutationsIndex",range:n},(i,s,a)=>{e=!1,a.done()}).next(()=>e)}addMutationBatch(t,e,n,i){let s=Mn(t),a=Pe(t);return a.add({}).next(u=>{q(typeof u=="number");let l=new ei(u,e,n,i),d=function(S,N,k){let D=k.baseMutations.map(j=>oi(S.ct,j)),G=k.mutations.map(j=>oi(S.ct,j));return{userId:N,batchId:k.batchId,localWriteTimeMs:k.localWriteTime.toMillis(),baseMutations:D,mutations:G}}(this.serializer,this.userId,l),f=[],g=new nt((y,S)=>K(y.canonicalString(),S.canonicalString()));for(let y of i){let S=Ud(this.userId,y.key.path,u);g=g.add(y.key.path.popLast()),f.push(a.put(d)),f.push(s.put(S,$g))}return g.forEach(y=>{f.push(this.indexManager.addToCollectionParentIndex(t,y))}),t.addOnCommittedListener(()=>{this.Cn[u]=l.keys()}),b.waitFor(f).next(()=>l)})}lookupMutationBatch(t,e){return Pe(t).get(e).next(n=>n?(q(n.userId===this.userId),Ze(this.serializer,n)):null)}vn(t,e){return this.Cn[e]?b.resolve(this.Cn[e]):this.lookupMutationBatch(t,e).next(n=>{if(n){let i=n.keys();return this.Cn[e]=i,i}return null})}getNextMutationBatchAfterBatchId(t,e){let n=e+1,i=IDBKeyRange.lowerBound([this.userId,n]),s=null;return Pe(t).J({index:"userMutationsIndex",range:i},(a,u,l)=>{u.userId===this.userId&&(q(u.batchId>=n),s=Ze(this.serializer,u)),l.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){let e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return Pe(t).J({index:"userMutationsIndex",range:e,reverse:!0},(i,s,a)=>{n=s.batchId,a.done()}).next(()=>n)}getAllMutationBatches(t){let e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Pe(t).U("userMutationsIndex",e).next(n=>n.map(i=>Ze(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(t,e){let n=Xi(this.userId,e.path),i=IDBKeyRange.lowerBound(n),s=[];return Mn(t).J({range:i},(a,u,l)=>{let[d,f,g]=a,y=Zt(f);if(d===this.userId&&e.path.isEqual(y))return Pe(t).get(g).next(S=>{if(!S)throw L();q(S.userId===this.userId),s.push(Ze(this.serializer,S))});l.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new nt(K),i=[];return e.forEach(s=>{let a=Xi(this.userId,s.path),u=IDBKeyRange.lowerBound(a),l=Mn(t).J({range:u},(d,f,g)=>{let[y,S,N]=d,k=Zt(S);y===this.userId&&s.path.isEqual(k)?n=n.add(N):g.done()});i.push(l)}),b.waitFor(i).next(()=>this.Fn(t,n))}getAllMutationBatchesAffectingQuery(t,e){let n=e.path,i=n.length+1,s=Xi(this.userId,n),a=IDBKeyRange.lowerBound(s),u=new nt(K);return Mn(t).J({range:a},(l,d,f)=>{let[g,y,S]=l,N=Zt(y);g===this.userId&&n.isPrefixOf(N)?N.length===i&&(u=u.add(S)):f.done()}).next(()=>this.Fn(t,u))}Fn(t,e){let n=[],i=[];return e.forEach(s=>{i.push(Pe(t).get(s).next(a=>{if(a===null)throw L();q(a.userId===this.userId),n.push(Ze(this.serializer,a))}))}),b.waitFor(i).next(()=>n)}removeMutationBatch(t,e){return Ff(t._e,this.userId,e).next(n=>(t.addOnCommittedListener(()=>{this.Mn(e.batchId)}),b.forEach(n,i=>this.referenceDelegate.markPotentiallyOrphaned(t,i))))}Mn(t){delete this.Cn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next(e=>{if(!e)return b.resolve();let n=IDBKeyRange.lowerBound(function(a){return[a]}(this.userId)),i=[];return Mn(t).J({range:n},(s,a,u)=>{if(s[0]===this.userId){let l=Zt(s[1]);i.push(l)}else u.done()}).next(()=>{q(i.length===0)})})}containsKey(t,e){return Mf(t,this.userId,e)}xn(t){return Of(t).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function Mf(r,t,e){let n=Xi(t,e.path),i=n[1],s=IDBKeyRange.lowerBound(n),a=!1;return Mn(r).J({range:s,H:!0},(u,l,d)=>{let[f,g,y]=u;f===t&&g===i&&(a=!0),d.done()}).next(()=>a)}function Pe(r){return Tt(r,"mutations")}function Mn(r){return Tt(r,"documentMutations")}function Of(r){return Tt(r,"mutationQueues")}var Hn=class r{constructor(t){this.On=t}next(){return this.On+=2,this.On}static Nn(){return new r(0)}static Ln(){return new r(-1)}};var Ya=class{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.Bn(t).next(e=>{let n=new Hn(e.highestTargetId);return e.highestTargetId=n.next(),this.kn(t,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.Bn(t).next(e=>B.fromTimestamp(new at(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.Bn(t).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,e,n){return this.Bn(t).next(i=>(i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),this.kn(t,i)))}addTargetData(t,e){return this.qn(t,e).next(()=>this.Bn(t).next(n=>(n.targetCount+=1,this.Qn(e,n),this.kn(t,n))))}updateTargetData(t,e){return this.qn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Vn(t).delete(e.targetId)).next(()=>this.Bn(t)).next(n=>(q(n.targetCount>0),n.targetCount-=1,this.kn(t,n)))}removeTargets(t,e,n){let i=0,s=[];return Vn(t).J((a,u)=>{let l=Gr(u);l.sequenceNumber<=e&&n.get(l.targetId)===null&&(i++,s.push(this.removeTargetData(t,l)))}).next(()=>b.waitFor(s)).next(()=>i)}forEachTarget(t,e){return Vn(t).J((n,i)=>{let s=Gr(i);e(s)})}Bn(t){return md(t).get("targetGlobalKey").next(e=>(q(e!==null),e))}kn(t,e){return md(t).put("targetGlobalKey",e)}qn(t,e){return Vn(t).put(Df(this.serializer,e))}Qn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Bn(t).next(e=>e.targetCount)}getTargetData(t,e){let n=un(e),i=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),s=null;return Vn(t).J({range:i,index:"queryTargetsIndex"},(a,u,l)=>{let d=Gr(u);_i(e,d.target)&&(s=d,l.done())}).next(()=>s)}addMatchingKeys(t,e,n){let i=[],s=Ce(t);return e.forEach(a=>{let u=kt(a.path);i.push(s.put({targetId:n,path:u})),i.push(this.referenceDelegate.addReference(t,n,a))}),b.waitFor(i)}removeMatchingKeys(t,e,n){let i=Ce(t);return b.forEach(e,s=>{let a=kt(s.path);return b.waitFor([i.delete([n,a]),this.referenceDelegate.removeReference(t,n,s)])})}removeMatchingKeysForTargetId(t,e){let n=Ce(t),i=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(i)}getMatchingKeysForTargetId(t,e){let n=IDBKeyRange.bound([e],[e+1],!1,!0),i=Ce(t),s=$();return i.J({range:n,H:!0},(a,u,l)=>{let d=Zt(a[1]),f=new M(d);s=s.add(f)}).next(()=>s)}containsKey(t,e){let n=kt(e.path),i=IDBKeyRange.bound([n],[kd(n)],!1,!0),s=0;return Ce(t).J({index:"documentTargetsIndex",H:!0,range:i},([a,u],l,d)=>{a!==0&&(s++,d.done())}).next(()=>s>0)}ot(t,e){return Vn(t).get(e).next(n=>n?Gr(n):null)}};function Vn(r){return Tt(r,"targets")}function md(r){return Tt(r,"targetGlobal")}function Ce(r){return Tt(r,"targetDocuments")}function gd([r,t],[e,n]){let i=K(r,e);return i===0?K(t,n):i}var Xa=class{constructor(t){this.Kn=t,this.buffer=new nt(gd),this.$n=0}Un(){return++this.$n}Wn(t){let e=[t,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(e);else{let n=this.buffer.last();gd(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}}get maxValue(){return this.buffer.last()[0]}},Za=class{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Gn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return this.Gn!==null}zn(t){V("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,()=>C(this,null,function*(){this.Gn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(e){ze(e)?V("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):yield je(e)}yield this.zn(3e5)}))}},tu=class{constructor(t,e){this.jn=t,this.params=e}calculateTargetCount(t,e){return this.jn.Hn(t).next(n=>Math.floor(e/100*n))}nthSequenceNumber(t,e){if(e===0)return b.resolve(qt.oe);let n=new Xa(e);return this.jn.forEachTarget(t,i=>n.Wn(i.sequenceNumber)).next(()=>this.jn.Jn(t,i=>n.Wn(i))).next(()=>n.maxValue)}removeTargets(t,e,n){return this.jn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.jn.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(V("LruGarbageCollector","Garbage collection skipped; disabled"),b.resolve(fd)):this.getCacheSize(t).next(n=>n<this.params.cacheSizeCollectionThreshold?(V("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),fd):this.Yn(t,e))}getCacheSize(t){return this.jn.getCacheSize(t)}Yn(t,e){let n,i,s,a,u,l,d,f=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(g=>(g>this.params.maximumSequenceNumbersToCollect?(V("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${g}`),i=this.params.maximumSequenceNumbersToCollect):i=g,a=Date.now(),this.nthSequenceNumber(t,i))).next(g=>(n=g,u=Date.now(),this.removeTargets(t,n,e))).next(g=>(s=g,l=Date.now(),this.removeOrphanedDocuments(t,n))).next(g=>(d=Date.now(),Dn()<=Xt.DEBUG&&V("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-f}ms
	Determined least recently used ${i} in `+(u-a)+`ms
	Removed ${s} targets in `+(l-u)+`ms
	Removed ${g} documents in `+(d-l)+`ms
Total Duration: ${d-f}ms`),b.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:g})))}};function Up(r,t){return new tu(r,t)}var eu=class{constructor(t,e){this.db=t,this.garbageCollector=Up(this,e)}Hn(t){let e=this.Zn(t);return this.db.getTargetCache().getTargetCount(t).next(n=>e.next(i=>n+i))}Zn(t){let e=0;return this.Jn(t,n=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Jn(t,e){return this.Xn(t,(n,i)=>e(i))}addReference(t,e,n){return Hi(t,n)}removeReference(t,e,n){return Hi(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Hi(t,e)}er(t,e){return function(i,s){let a=!1;return Of(i).Y(u=>Mf(i,u,s).next(l=>(l&&(a=!0),b.resolve(!l)))).next(()=>a)}(t,e)}removeOrphanedDocuments(t,e){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.Xn(t,(a,u)=>{if(u<=e){let l=this.er(t,a).next(d=>{if(!d)return s++,n.getEntry(t,a).next(()=>(n.removeEntry(a,B.min()),Ce(t).delete(function(g){return[0,kt(g.path)]}(a))))});i.push(l)}}).next(()=>b.waitFor(i)).next(()=>n.apply(t)).next(()=>s)}removeTarget(t,e){let n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Hi(t,e)}Xn(t,e){let n=Ce(t),i,s=qt.oe;return n.J({index:"documentTargetsIndex"},([a,u],{path:l,sequenceNumber:d})=>{a===0?(s!==qt.oe&&e(new M(Zt(i)),s),s=d,i=l):s=qt.oe}).next(()=>{s!==qt.oe&&e(new M(Zt(i)),s)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}};function Hi(r,t){return Ce(r).put(function(n,i){return{targetId:0,path:kt(n.path),sequenceNumber:i}}(t,r.currentSequenceNumber))}var bs=class{constructor(){this.changes=new oe(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,wt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();let n=this.changes.get(e);return n!==void 0?b.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}};var nu=class{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Je(t).put(n)}removeEntry(t,e,n){return Je(t).delete(function(s,a){let u=s.path.toArray();return[u.slice(0,u.length-2),u[u.length-2],vs(a),u[u.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next(n=>(n.byteSize+=e,this.tr(t,n)))}getEntry(t,e){let n=wt.newInvalidDocument(e);return Je(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(qr(e))},(i,s)=>{n=this.nr(e,s)}).next(()=>n)}rr(t,e){let n={size:0,document:wt.newInvalidDocument(e)};return Je(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(qr(e))},(i,s)=>{n={document:this.nr(e,s),size:As(s)}}).next(()=>n)}getEntries(t,e){let n=Ot();return this.ir(t,e,(i,s)=>{let a=this.nr(i,s);n=n.insert(i,a)}).next(()=>n)}sr(t,e){let n=Ot(),i=new st(M.comparator);return this.ir(t,e,(s,a)=>{let u=this.nr(s,a);n=n.insert(s,u),i=i.insert(s,As(a))}).next(()=>({documents:n,_r:i}))}ir(t,e,n){if(e.isEmpty())return b.resolve();let i=new nt(yd);e.forEach(l=>i=i.add(l));let s=IDBKeyRange.bound(qr(i.first()),qr(i.last())),a=i.getIterator(),u=a.getNext();return Je(t).J({index:"documentKeyIndex",range:s},(l,d,f)=>{let g=M.fromSegments([...d.prefixPath,d.collectionGroup,d.documentId]);for(;u&&yd(u,g)<0;)n(u,null),u=a.getNext();u&&u.isEqual(g)&&(n(u,d),u=a.hasNext()?a.getNext():null),u?f.$(qr(u)):f.done()}).next(()=>{for(;u;)n(u,null),u=a.hasNext()?a.getNext():null})}getDocumentsMatchingQuery(t,e,n,i,s){let a=e.path,u=[a.popLast().toArray(),a.lastSegment(),vs(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],l=[a.popLast().toArray(),a.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Je(t).U(IDBKeyRange.bound(u,l,!0)).next(d=>{s?.incrementDocumentReadCount(d.length);let f=Ot();for(let g of d){let y=this.nr(M.fromSegments(g.prefixPath.concat(g.collectionGroup,g.documentId)),g);y.isFoundDocument()&&(wi(e,y)||i.has(y.key))&&(f=f.insert(y.key,y))}return f})}getAllFromCollectionGroup(t,e,n,i){let s=Ot(),a=_d(e,n),u=_d(e,zt.max());return Je(t).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(a,u,!0)},(l,d,f)=>{let g=this.nr(M.fromSegments(d.prefixPath.concat(d.collectionGroup,d.documentId)),d);s=s.insert(g.key,g),s.size===i&&f.done()}).next(()=>s)}newChangeBuffer(t){return new ru(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(e=>e.byteSize)}getMetadata(t){return pd(t).get("remoteDocumentGlobalKey").next(e=>(q(!!e),e))}tr(t,e){return pd(t).put("remoteDocumentGlobalKey",e)}nr(t,e){if(e){let n=Op(this.serializer,e);if(!(n.isNoDocument()&&n.version.isEqual(B.min())))return n}return wt.newInvalidDocument(t)}};function Lf(r){return new nu(r)}var ru=class extends bs{constructor(t,e){super(),this.ar=t,this.trackRemovals=e,this.ur=new oe(n=>n.toString(),(n,i)=>n.isEqual(i))}applyChanges(t){let e=[],n=0,i=new nt((s,a)=>K(s.canonicalString(),a.canonicalString()));return this.changes.forEach((s,a)=>{let u=this.ur.get(s);if(e.push(this.ar.removeEntry(t,s,u.readTime)),a.isValidDocument()){let l=rd(this.ar.serializer,a);i=i.add(s.path.popLast());let d=As(l);n+=d-u.size,e.push(this.ar.addEntry(t,s,l))}else if(n-=u.size,this.trackRemovals){let l=rd(this.ar.serializer,a.convertToNoDocument(B.min()));e.push(this.ar.addEntry(t,s,l))}}),i.forEach(s=>{e.push(this.ar.indexManager.addToCollectionParentIndex(t,s))}),e.push(this.ar.updateMetadata(t,n)),b.waitFor(e)}getFromCache(t,e){return this.ar.rr(t,e).next(n=>(this.ur.set(e,{size:n.size,readTime:n.document.readTime}),n.document))}getAllFromCache(t,e){return this.ar.sr(t,e).next(({documents:n,_r:i})=>(i.forEach((s,a)=>{this.ur.set(s,{size:a,readTime:n.get(s).readTime})}),n))}};function pd(r){return Tt(r,"remoteDocumentGlobal")}function Je(r){return Tt(r,"remoteDocumentsV14")}function qr(r){let t=r.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function _d(r,t){let e=t.documentKey.path.toArray();return[r,vs(t.readTime),e.slice(0,e.length-2),e.length>0?e[e.length-1]:""]}function yd(r,t){let e=r.path.toArray(),n=t.path.toArray(),i=0;for(let s=0;s<e.length-2&&s<n.length-2;++s)if(i=K(e[s],n[s]),i)return i;return i=K(e.length,n.length),i||(i=K(e[e.length-2],n[n.length-2]),i||K(e[e.length-1],n[n.length-1]))}var iu=class{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}};var Rs=class{constructor(t,e,n,i){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=i}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next(i=>(n=i,this.remoteDocumentCache.getEntry(t,e))).next(i=>(n!==null&&Kr(n.mutation,i,Ut.empty(),at.now()),i))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(n=>this.getLocalViewOfDocuments(t,n,$()).next(()=>n))}getLocalViewOfDocuments(t,e,n=$()){let i=te();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,n).next(s=>{let a=Br();return s.forEach((u,l)=>{a=a.insert(u,l.overlayedDocument)}),a}))}getOverlayedDocuments(t,e){let n=te();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,$()))}populateOverlays(t,e,n){let i=[];return n.forEach(s=>{e.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(t,i).next(s=>{s.forEach((a,u)=>{e.set(a,u)})})}computeViews(t,e,n,i){let s=Ot(),a=zr(),u=function(){return zr()}();return e.forEach((l,d)=>{let f=n.get(d.key);i.has(d.key)&&(f===void 0||f.mutation instanceof Ht)?s=s.insert(d.key,d):f!==void 0?(a.set(d.key,f.mutation.getFieldMask()),Kr(f.mutation,d,f.mutation.getFieldMask(),at.now())):a.set(d.key,Ut.empty())}),this.recalculateAndSaveOverlays(t,s).next(l=>(l.forEach((d,f)=>a.set(d,f)),e.forEach((d,f)=>{var g;return u.set(d,new iu(f,(g=a.get(d))!==null&&g!==void 0?g:null))}),u))}recalculateAndSaveOverlays(t,e){let n=zr(),i=new st((a,u)=>a-u),s=$();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(a=>{for(let u of a)u.keys().forEach(l=>{let d=e.get(l);if(d===null)return;let f=n.get(l)||Ut.empty();f=u.applyToLocalView(d,f),n.set(l,f);let g=(i.get(u.batchId)||$()).add(l);i=i.insert(u.batchId,g)})}).next(()=>{let a=[],u=i.getReverseIterator();for(;u.hasNext();){let l=u.getNext(),d=l.key,f=l.value,g=af();f.forEach(y=>{if(!s.has(y)){let S=gf(e.get(y),n.get(y));S!==null&&g.set(y,S),s=s.add(y)}}),a.push(this.documentOverlayCache.saveOverlays(t,d,g))}return b.waitFor(a)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(n=>this.recalculateAndSaveOverlays(t,n))}getDocumentsMatchingQuery(t,e,n,i){return function(a){return M.isDocumentKey(a.path)&&a.collectionGroup===null&&a.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):cc(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n,i):this.getDocumentsMatchingCollectionQuery(t,e,n,i)}getNextDocuments(t,e,n,i){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,i).next(s=>{let a=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,i-s.size):b.resolve(te()),u=-1,l=s;return a.next(d=>b.forEach(d,(f,g)=>(u<g.largestBatchId&&(u=g.largestBatchId),s.get(f)?b.resolve():this.remoteDocumentCache.getEntry(t,f).next(y=>{l=l.insert(f,y)}))).next(()=>this.populateOverlays(t,d,s)).next(()=>this.computeViews(t,l,d,$())).next(f=>({batchId:u,changes:of(f)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new M(e)).next(n=>{let i=Br();return n.isFoundDocument()&&(i=i.insert(n.key,n)),i})}getDocumentsMatchingCollectionGroupQuery(t,e,n,i){let s=e.collectionGroup,a=Br();return this.indexManager.getCollectionParents(t,s).next(u=>b.forEach(u,l=>{let d=function(g,y){return new Wt(y,null,g.explicitOrderBy.slice(),g.filters.slice(),g.limit,g.limitType,g.startAt,g.endAt)}(e,l.child(s));return this.getDocumentsMatchingCollectionQuery(t,d,n,i).next(f=>{f.forEach((g,y)=>{a=a.insert(g,y)})})}).next(()=>a))}getDocumentsMatchingCollectionQuery(t,e,n,i){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next(a=>(s=a,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,s,i))).next(a=>{s.forEach((l,d)=>{let f=d.getKey();a.get(f)===null&&(a=a.insert(f,wt.newInvalidDocument(f)))});let u=Br();return a.forEach((l,d)=>{let f=s.get(l);f!==void 0&&Kr(f.mutation,d,Ut.empty(),at.now()),wi(e,d)&&(u=u.insert(l,d))}),u})}};var su=class{constructor(t){this.serializer=t,this.cr=new Map,this.lr=new Map}getBundleMetadata(t,e){return b.resolve(this.cr.get(e))}saveBundleMetadata(t,e){return this.cr.set(e.id,function(i){return{id:i.id,version:i.version,createTime:mt(i.createTime)}}(e)),b.resolve()}getNamedQuery(t,e){return b.resolve(this.lr.get(e))}saveNamedQuery(t,e){return this.lr.set(e.name,function(i){return{name:i.name,query:dc(i.bundledQuery),readTime:mt(i.readTime)}}(e)),b.resolve()}};var ou=class{constructor(){this.overlays=new st(M.comparator),this.hr=new Map}getOverlay(t,e){return b.resolve(this.overlays.get(e))}getOverlays(t,e){let n=te();return b.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&n.set(i,s)})).next(()=>n)}saveOverlays(t,e,n){return n.forEach((i,s)=>{this.ht(t,e,s)}),b.resolve()}removeOverlaysForBatchId(t,e,n){let i=this.hr.get(n);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.hr.delete(n)),b.resolve()}getOverlaysForCollection(t,e,n){let i=te(),s=e.length+1,a=new M(e.child("")),u=this.overlays.getIteratorFrom(a);for(;u.hasNext();){let l=u.getNext().value,d=l.getKey();if(!e.isPrefixOf(d.path))break;d.path.length===s&&l.largestBatchId>n&&i.set(l.getKey(),l)}return b.resolve(i)}getOverlaysForCollectionGroup(t,e,n,i){let s=new st((d,f)=>d-f),a=this.overlays.getIterator();for(;a.hasNext();){let d=a.getNext().value;if(d.getKey().getCollectionGroup()===e&&d.largestBatchId>n){let f=s.get(d.largestBatchId);f===null&&(f=te(),s=s.insert(d.largestBatchId,f)),f.set(d.getKey(),d)}}let u=te(),l=s.getIterator();for(;l.hasNext()&&(l.getNext().value.forEach((d,f)=>u.set(d,f)),!(u.size()>=i)););return b.resolve(u)}ht(t,e,n){let i=this.overlays.get(n.key);if(i!==null){let a=this.hr.get(i.largestBatchId).delete(n.key);this.hr.set(i.largestBatchId,a)}this.overlays=this.overlays.insert(n.key,new ni(e,n));let s=this.hr.get(e);s===void 0&&(s=$(),this.hr.set(e,s)),this.hr.set(e,s.add(n.key))}};var ui=class{constructor(){this.Pr=new nt(pt.Ir),this.Tr=new nt(pt.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(t,e){let n=new pt(t,e);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(t,e){t.forEach(n=>this.addReference(n,e))}removeReference(t,e){this.Ar(new pt(t,e))}Rr(t,e){t.forEach(n=>this.removeReference(n,e))}Vr(t){let e=new M(new Y([])),n=new pt(e,t),i=new pt(e,t+1),s=[];return this.Tr.forEachInRange([n,i],a=>{this.Ar(a),s.push(a.key)}),s}mr(){this.Pr.forEach(t=>this.Ar(t))}Ar(t){this.Pr=this.Pr.delete(t),this.Tr=this.Tr.delete(t)}gr(t){let e=new M(new Y([])),n=new pt(e,t),i=new pt(e,t+1),s=$();return this.Tr.forEachInRange([n,i],a=>{s=s.add(a.key)}),s}containsKey(t){let e=new pt(t,0),n=this.Pr.firstAfterOrEqual(e);return n!==null&&t.isEqual(n.key)}},pt=class{constructor(t,e){this.key=t,this.pr=e}static Ir(t,e){return M.comparator(t.key,e.key)||K(t.pr,e.pr)}static Er(t,e){return K(t.pr,e.pr)||M.comparator(t.key,e.key)}};var au=class{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.yr=1,this.wr=new nt(pt.Ir)}checkEmpty(t){return b.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,n,i){let s=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let a=new ei(s,e,n,i);this.mutationQueue.push(a);for(let u of i)this.wr=this.wr.add(new pt(u.key,s)),this.indexManager.addToCollectionParentIndex(t,u.key.path.popLast());return b.resolve(a)}lookupMutationBatch(t,e){return b.resolve(this.Sr(e))}getNextMutationBatchAfterBatchId(t,e){let n=e+1,i=this.br(n),s=i<0?0:i;return b.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return b.resolve(this.mutationQueue.length===0?-1:this.yr-1)}getAllMutationBatches(t){return b.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){let n=new pt(e,0),i=new pt(e,Number.POSITIVE_INFINITY),s=[];return this.wr.forEachInRange([n,i],a=>{let u=this.Sr(a.pr);s.push(u)}),b.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new nt(K);return e.forEach(i=>{let s=new pt(i,0),a=new pt(i,Number.POSITIVE_INFINITY);this.wr.forEachInRange([s,a],u=>{n=n.add(u.pr)})}),b.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(t,e){let n=e.path,i=n.length+1,s=n;M.isDocumentKey(s)||(s=s.child(""));let a=new pt(new M(s),0),u=new nt(K);return this.wr.forEachWhile(l=>{let d=l.key.path;return!!n.isPrefixOf(d)&&(d.length===i&&(u=u.add(l.pr)),!0)},a),b.resolve(this.Dr(u))}Dr(t){let e=[];return t.forEach(n=>{let i=this.Sr(n);i!==null&&e.push(i)}),e}removeMutationBatch(t,e){q(this.Cr(e.batchId,"removed")===0),this.mutationQueue.shift();let n=this.wr;return b.forEach(e.mutations,i=>{let s=new pt(i.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,i.key)}).next(()=>{this.wr=n})}Mn(t){}containsKey(t,e){let n=new pt(e,0),i=this.wr.firstAfterOrEqual(n);return b.resolve(e.isEqual(i&&i.key))}performConsistencyCheck(t){return this.mutationQueue.length,b.resolve()}Cr(t,e){return this.br(t)}br(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Sr(t){let e=this.br(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}};var uu=class{constructor(t){this.vr=t,this.docs=function(){return new st(M.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){let n=e.key,i=this.docs.get(n),s=i?i.size:0,a=this.vr(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:a}),this.size+=a-s,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){let e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){let n=this.docs.get(e);return b.resolve(n?n.document.mutableCopy():wt.newInvalidDocument(e))}getEntries(t,e){let n=Ot();return e.forEach(i=>{let s=this.docs.get(i);n=n.insert(i,s?s.document.mutableCopy():wt.newInvalidDocument(i))}),b.resolve(n)}getDocumentsMatchingQuery(t,e,n,i){let s=Ot(),a=e.path,u=new M(a.child("")),l=this.docs.getIteratorFrom(u);for(;l.hasNext();){let{key:d,value:{document:f}}=l.getNext();if(!a.isPrefixOf(d.path))break;d.path.length>a.length+1||sc(Md(f),n)<=0||(i.has(f.key)||wi(e,f))&&(s=s.insert(f.key,f.mutableCopy()))}return b.resolve(s)}getAllFromCollectionGroup(t,e,n,i){L()}Fr(t,e){return b.forEach(this.docs,n=>e(n))}newChangeBuffer(t){return new cu(this)}getSize(t){return b.resolve(this.size)}},cu=class extends bs{constructor(t){super(),this.ar=t}applyChanges(t){let e=[];return this.changes.forEach((n,i)=>{i.isValidDocument()?e.push(this.ar.addEntry(t,i)):this.ar.removeEntry(n)}),b.waitFor(e)}getFromCache(t,e){return this.ar.getEntry(t,e)}getAllFromCache(t,e){return this.ar.getEntries(t,e)}};var lu=class{constructor(t){this.persistence=t,this.Mr=new oe(e=>un(e),_i),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.Or=0,this.Nr=new ui,this.targetCount=0,this.Lr=Hn.Nn()}forEachTarget(t,e){return this.Mr.forEach((n,i)=>e(i)),b.resolve()}getLastRemoteSnapshotVersion(t){return b.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return b.resolve(this.Or)}allocateTargetId(t){return this.highestTargetId=this.Lr.next(),b.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Or&&(this.Or=e),b.resolve()}qn(t){this.Mr.set(t.target,t);let e=t.targetId;e>this.highestTargetId&&(this.Lr=new Hn(e),this.highestTargetId=e),t.sequenceNumber>this.Or&&(this.Or=t.sequenceNumber)}addTargetData(t,e){return this.qn(e),this.targetCount+=1,b.resolve()}updateTargetData(t,e){return this.qn(e),b.resolve()}removeTargetData(t,e){return this.Mr.delete(e.target),this.Nr.Vr(e.targetId),this.targetCount-=1,b.resolve()}removeTargets(t,e,n){let i=0,s=[];return this.Mr.forEach((a,u)=>{u.sequenceNumber<=e&&n.get(u.targetId)===null&&(this.Mr.delete(a),s.push(this.removeMatchingKeysForTargetId(t,u.targetId)),i++)}),b.waitFor(s).next(()=>i)}getTargetCount(t){return b.resolve(this.targetCount)}getTargetData(t,e){let n=this.Mr.get(e)||null;return b.resolve(n)}addMatchingKeys(t,e,n){return this.Nr.dr(e,n),b.resolve()}removeMatchingKeys(t,e,n){this.Nr.Rr(e,n);let i=this.persistence.referenceDelegate,s=[];return i&&e.forEach(a=>{s.push(i.markPotentiallyOrphaned(t,a))}),b.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Nr.Vr(e),b.resolve()}getMatchingKeysForTargetId(t,e){let n=this.Nr.gr(e);return b.resolve(n)}containsKey(t,e){return b.resolve(this.Nr.containsKey(e))}};var Ps=class{constructor(t,e){this.Br={},this.overlays={},this.kr=new qt(0),this.qr=!1,this.qr=!0,this.referenceDelegate=t(this),this.Qr=new lu(this),this.indexManager=new Ha,this.remoteDocumentCache=function(i){return new uu(i)}(n=>this.referenceDelegate.Kr(n)),this.serializer=new ws(e),this.$r=new su(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new ou,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Br[t.toKey()];return n||(n=new au(e,this.referenceDelegate),this.Br[t.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(t,e,n){V("MemoryPersistence","Starting transaction:",t);let i=new hu(this.kr.next());return this.referenceDelegate.Ur(),n(i).next(s=>this.referenceDelegate.Wr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Gr(t,e){return b.or(Object.values(this.Br).map(n=>()=>n.containsKey(t,e)))}},hu=class extends as{constructor(t){super(),this.currentSequenceNumber=t}},Cs=class r{constructor(t){this.persistence=t,this.zr=new ui,this.jr=null}static Hr(t){return new r(t)}get Jr(){if(this.jr)return this.jr;throw L()}addReference(t,e,n){return this.zr.addReference(n,e),this.Jr.delete(n.toString()),b.resolve()}removeReference(t,e,n){return this.zr.removeReference(n,e),this.Jr.add(n.toString()),b.resolve()}markPotentiallyOrphaned(t,e){return this.Jr.add(e.toString()),b.resolve()}removeTarget(t,e){this.zr.Vr(e.targetId).forEach(i=>this.Jr.add(i.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next(i=>{i.forEach(s=>this.Jr.add(s.toString()))}).next(()=>n.removeTargetData(t,e))}Ur(){this.jr=new Set}Wr(t){let e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return b.forEach(this.Jr,n=>{let i=M.fromPath(n);return this.Yr(t,i).next(s=>{s||e.removeEntry(i,B.min())})}).next(()=>(this.jr=null,e.apply(t)))}updateLimboDocument(t,e){return this.Yr(t,e).next(n=>{n?this.Jr.delete(e.toString()):this.Jr.add(e.toString())})}Kr(t){return 0}Yr(t,e){return b.or([()=>b.resolve(this.zr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Gr(t,e)])}};var du=class{constructor(t){this.serializer=t}O(t,e,n,i){let s=new us("createOrUpgrade",e);n<1&&i>=1&&(function(l){l.createObjectStore("owner")}(t),function(l){l.createObjectStore("mutationQueues",{keyPath:"userId"}),l.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Fh,{unique:!0}),l.createObjectStore("documentMutations")}(t),wd(t),function(l){l.createObjectStore("remoteDocuments")}(t));let a=b.resolve();return n<3&&i>=3&&(n!==0&&(function(l){l.deleteObjectStore("targetDocuments"),l.deleteObjectStore("targets"),l.deleteObjectStore("targetGlobal")}(t),wd(t)),a=a.next(()=>function(l){let d=l.store("targetGlobal"),f={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:B.min().toTimestamp(),targetCount:0};return d.put("targetGlobalKey",f)}(s))),n<4&&i>=4&&(n!==0&&(a=a.next(()=>function(l,d){return d.store("mutations").U().next(f=>{l.deleteObjectStore("mutations"),l.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Fh,{unique:!0});let g=d.store("mutations"),y=f.map(S=>g.put(S));return b.waitFor(y)})}(t,s))),a=a.next(()=>{(function(l){l.createObjectStore("clientMetadata",{keyPath:"clientId"})})(t)})),n<5&&i>=5&&(a=a.next(()=>this.Xr(s))),n<6&&i>=6&&(a=a.next(()=>(function(l){l.createObjectStore("remoteDocumentGlobal")}(t),this.ei(s)))),n<7&&i>=7&&(a=a.next(()=>this.ti(s))),n<8&&i>=8&&(a=a.next(()=>this.ni(t,s))),n<9&&i>=9&&(a=a.next(()=>{(function(l){l.objectStoreNames.contains("remoteDocumentChanges")&&l.deleteObjectStore("remoteDocumentChanges")})(t)})),n<10&&i>=10&&(a=a.next(()=>this.ri(s))),n<11&&i>=11&&(a=a.next(()=>{(function(l){l.createObjectStore("bundles",{keyPath:"bundleId"})})(t),function(l){l.createObjectStore("namedQueries",{keyPath:"name"})}(t)})),n<12&&i>=12&&(a=a.next(()=>{(function(l){let d=l.createObjectStore("documentOverlays",{keyPath:ip});d.createIndex("collectionPathOverlayIndex",sp,{unique:!1}),d.createIndex("collectionGroupOverlayIndex",op,{unique:!1})})(t)})),n<13&&i>=13&&(a=a.next(()=>function(l){let d=l.createObjectStore("remoteDocumentsV14",{keyPath:Qg});d.createIndex("documentKeyIndex",Wg),d.createIndex("collectionGroupIndex",Hg)}(t)).next(()=>this.ii(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&i>=14&&(a=a.next(()=>this.si(t,s))),n<15&&i>=15&&(a=a.next(()=>function(l){l.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),l.createObjectStore("indexState",{keyPath:tp}).createIndex("sequenceNumberIndex",ep,{unique:!1}),l.createObjectStore("indexEntries",{keyPath:np}).createIndex("documentKeyIndex",rp,{unique:!1})}(t))),n<16&&i>=16&&(a=a.next(()=>{e.objectStore("indexState").clear()}).next(()=>{e.objectStore("indexEntries").clear()})),a}ei(t){let e=0;return t.store("remoteDocuments").J((n,i)=>{e+=As(i)}).next(()=>{let n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)})}Xr(t){let e=t.store("mutationQueues"),n=t.store("mutations");return e.U().next(i=>b.forEach(i,s=>{let a=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",a).next(u=>b.forEach(u,l=>{q(l.userId===s.userId);let d=Ze(this.serializer,l);return Ff(t,s.userId,d).next(()=>{})}))}))}ti(t){let e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return n.J((a,u)=>{let l=new Y(a),d=function(g){return[0,kt(g)]}(l);s.push(e.get(d).next(f=>f?b.resolve():(g=>e.put({targetId:0,path:kt(g),sequenceNumber:i.highestListenSequenceNumber}))(l)))}).next(()=>b.waitFor(s))})}ni(t,e){t.createObjectStore("collectionParents",{keyPath:Zg});let n=e.store("collectionParents"),i=new ai,s=a=>{if(i.add(a)){let u=a.lastSegment(),l=a.popLast();return n.put({collectionId:u,parent:kt(l)})}};return e.store("remoteDocuments").J({H:!0},(a,u)=>{let l=new Y(a);return s(l.popLast())}).next(()=>e.store("documentMutations").J({H:!0},([a,u,l],d)=>{let f=Zt(u);return s(f.popLast())}))}ri(t){let e=t.store("targets");return e.J((n,i)=>{let s=Gr(i),a=Df(this.serializer,s);return e.put(a)})}ii(t,e){let n=e.store("remoteDocuments"),i=[];return n.J((s,a)=>{let u=e.store("remoteDocumentsV14"),l=function(g){return g.document?new M(Y.fromString(g.document.name).popFirst(5)):g.noDocument?M.fromSegments(g.noDocument.path):g.unknownDocument?M.fromSegments(g.unknownDocument.path):L()}(a).path.toArray(),d={prefixPath:l.slice(0,l.length-2),collectionGroup:l[l.length-2],documentId:l[l.length-1],readTime:a.readTime||[0,0],unknownDocument:a.unknownDocument,noDocument:a.noDocument,document:a.document,hasCommittedMutations:!!a.hasCommittedMutations};i.push(u.put(d))}).next(()=>b.waitFor(i))}si(t,e){let n=e.store("mutations"),i=Lf(this.serializer),s=new Ps(Cs.Hr,this.serializer.ct);return n.U().next(a=>{let u=new Map;return a.forEach(l=>{var d;let f=(d=u.get(l.userId))!==null&&d!==void 0?d:$();Ze(this.serializer,l).keys().forEach(g=>f=f.add(g)),u.set(l.userId,f)}),b.forEach(u,(l,d)=>{let f=new _t(d),g=Is.lt(this.serializer,f),y=s.getIndexManager(f),S=Ss.lt(f,this.serializer,y,s.referenceDelegate);return new Rs(i,S,g,y).recalculateAndSaveOverlaysForDocumentKeys(new Jr(e,qt.oe),l).next()})})}};function wd(r){r.createObjectStore("targetDocuments",{keyPath:Yg}).createIndex("documentTargetsIndex",Xg,{unique:!0}),r.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Jg,{unique:!0}),r.createObjectStore("targetGlobal")}var ra="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",fu=class r{constructor(t,e,n,i,s,a,u,l,d,f,g=16){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.oi=s,this.window=a,this.document=u,this._i=d,this.ai=f,this.ui=g,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=y=>Promise.resolve(),!r.D())throw new x(P.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new eu(this,i),this.Ti=e+"main",this.serializer=new ws(l),this.Ei=new ke(this.Ti,this.ui,new du(this.serializer)),this.Qr=new Ya(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Lf(this.serializer),this.$r=new Ga,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,f===!1&&dt("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new x(P.FAILED_PRECONDITION,ra);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.Qr.getHighestSequenceNumber(t))}).then(t=>{this.kr=new qt(t,this._i)}).then(()=>{this.qr=!0}).catch(t=>(this.Ei&&this.Ei.close(),Promise.reject(t)))}fi(t){return this.Ii=e=>C(this,null,function*(){if(this.started)return t(e)}),t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ei.L(e=>C(this,null,function*(){e.newVersion===null&&(yield t())}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.oi.enqueueAndForget(()=>C(this,null,function*(){this.started&&(yield this.Ai())})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>Ji(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.gi(t).next(e=>{e||(this.isPrimary=!1,this.oi.enqueueRetryable(()=>this.Ii(!1)))})}).next(()=>this.pi(t)).next(e=>this.isPrimary&&!e?this.yi(t).next(()=>!1):!!e&&this.wi(t).next(()=>!0))).catch(t=>{if(ze(t))return V("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return V("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.oi.enqueueRetryable(()=>this.Ii(t)),this.isPrimary=t})}gi(t){return Ur(t).get("owner").next(e=>b.resolve(this.Si(e)))}bi(t){return Ji(t).delete(this.clientId)}Di(){return C(this,null,function*(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();let t=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let n=Tt(e,"clientMetadata");return n.U().next(i=>{let s=this.vi(i,18e5),a=i.filter(u=>s.indexOf(u)===-1);return b.forEach(a,u=>n.delete(u.clientId)).next(()=>a)})}).catch(()=>[]);if(this.di)for(let e of t)this.di.removeItem(this.Fi(e.clientId))}})}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Ai().then(()=>this.Di()).then(()=>this.mi()))}Si(t){return!!t&&t.ownerId===this.clientId}pi(t){return this.ai?b.resolve(!0):Ur(t).get("owner").next(e=>{if(e!==null&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)){if(this.Si(e)&&this.networkEnabled)return!0;if(!this.Si(e)){if(!e.allowTabSynchronization)throw new x(P.FAILED_PRECONDITION,ra);return!1}}return!(!this.networkEnabled||!this.inForeground)||Ji(t).U().next(n=>this.vi(n,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,a=!this.inForeground&&i.inForeground,u=this.networkEnabled===i.networkEnabled;if(s||a&&u)return!0}return!1})===void 0)}).next(e=>(this.isPrimary!==e&&V("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}shutdown(){return C(this,null,function*(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),yield this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],t=>{let e=new Jr(t,qt.oe);return this.yi(e).next(()=>this.bi(e))}),this.Ei.close(),this.Li()})}vi(t,e){return t.filter(n=>this.Ci(n.updateTimeMs,e)&&!this.Mi(n.clientId))}Bi(){return this.runTransaction("getActiveClients","readonly",t=>Ji(t).U().next(e=>this.vi(e,18e5).map(n=>n.clientId)))}get started(){return this.qr}getMutationQueue(t,e){return Ss.lt(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new Ja(t,this.serializer.ct.databaseId)}getDocumentOverlayCache(t){return Is.lt(this.serializer,t)}getBundleCache(){return this.$r}runTransaction(t,e,n){V("IndexedDbPersistence","Starting transaction:",t);let i=e==="readonly"?"readonly":"readwrite",s=function(l){return l===16?up:l===15?zd:l===14?jd:l===13?Gd:l===12?ap:l===11?Bd:void L()}(this.ui),a;return this.Ei.runTransaction(t,i,s,u=>(a=new Jr(u,this.kr?this.kr.next():qt.oe),e==="readwrite-primary"?this.gi(a).next(l=>!!l||this.pi(a)).next(l=>{if(!l)throw dt(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.oi.enqueueRetryable(()=>this.Ii(!1)),new x(P.FAILED_PRECONDITION,Od);return n(a)}).next(l=>this.wi(a).next(()=>l)):this.ki(a).next(()=>n(a)))).then(u=>(a.raiseOnCommittedEvent(),u))}ki(t){return Ur(t).get("owner").next(e=>{if(e!==null&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)&&!this.Si(e)&&!(this.ai||this.allowTabSynchronization&&e.allowTabSynchronization))throw new x(P.FAILED_PRECONDITION,ra)})}wi(t){let e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Ur(t).put("owner",e)}static D(){return ke.D()}yi(t){let e=Ur(t);return e.get("owner").next(n=>this.Si(n)?(V("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):b.resolve())}Ci(t,e){let n=Date.now();return!(t<n-e)&&(!(t>n)||(dt(`Detected an update time that is in the future: ${t} > ${n}`),!1))}Ri(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.li=()=>{this.oi.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.Ai()))},this.document.addEventListener("visibilitychange",this.li),this.inForeground=this.document.visibilityState==="visible")}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var t;typeof((t=this.window)===null||t===void 0?void 0:t.addEventListener)=="function"&&(this.ci=()=>{this.xi();let e=/(?:Version|Mobile)\/1[456]/;Ko()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(t){var e;try{let n=((e=this.di)===null||e===void 0?void 0:e.getItem(this.Fi(t)))!==null;return V("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(n){return dt("IndexedDbPersistence","Failed to get zombied client id.",n),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(t){dt("Failed to set zombie client id.",t)}}Li(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch{}}Fi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}};function Ur(r){return Tt(r,"owner")}function Ji(r){return Tt(r,"clientMetadata")}function mc(r,t){let e=r.projectId;return r.isDefaultDatabase||(e+="."+r.database),"firestore/"+t+"/"+e+"/"}var mu=class r{constructor(t,e,n,i){this.targetId=t,this.fromCache=e,this.qi=n,this.Qi=i}static Ki(t,e){let n=$(),i=$();for(let s of e.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new r(t,e.fromCache,n,i)}};var gu=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}};var xs=class{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=function(){return Ko()?8:Ld(Fr())>0?6:4}()}initialize(t,e){this.zi=t,this.indexManager=e,this.$i=!0}getDocumentsMatchingQuery(t,e,n,i){let s={result:null};return this.ji(t,e).next(a=>{s.result=a}).next(()=>{if(!s.result)return this.Hi(t,e,i,n).next(a=>{s.result=a})}).next(()=>{if(s.result)return;let a=new gu;return this.Ji(t,e,a).next(u=>{if(s.result=u,this.Ui)return this.Yi(t,e,a,u.size)})}).next(()=>s.result)}Yi(t,e,n,i){return n.documentReadCount<this.Wi?(Dn()<=Xt.DEBUG&&V("QueryEngine","SDK will not create cache indexes for query:",Nn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),b.resolve()):(Dn()<=Xt.DEBUG&&V("QueryEngine","Query:",Nn(e),"scans",n.documentReadCount,"local documents and returns",i,"documents as results."),n.documentReadCount>this.Gi*i?(Dn()<=Xt.DEBUG&&V("QueryEngine","The SDK decides to create cache indexes for query:",Nn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Ft(e))):b.resolve())}ji(t,e){if($h(e))return b.resolve(null);let n=Ft(e);return this.indexManager.getIndexType(t,n).next(i=>i===0?null:(e.limit!==null&&i===1&&(e=gs(e,null,"F"),n=Ft(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next(s=>{let a=$(...s);return this.zi.getDocuments(t,a).next(u=>this.indexManager.getMinOffset(t,n).next(l=>{let d=this.Zi(e,u);return this.Xi(e,d,a,l.readTime)?this.ji(t,gs(e,null,"F")):this.es(t,d,e,l)}))})))}Hi(t,e,n,i){return $h(e)||i.isEqual(B.min())?b.resolve(null):this.zi.getDocuments(t,n).next(s=>{let a=this.Zi(e,s);return this.Xi(e,a,n,i)?b.resolve(null):(Dn()<=Xt.DEBUG&&V("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Nn(e)),this.es(t,a,e,Fd(i,-1)).next(u=>u))})}Zi(t,e){let n=new nt(rf(t));return e.forEach((i,s)=>{wi(t,s)&&(n=n.add(s))}),n}Xi(t,e,n,i){if(t.limit===null)return!1;if(n.size!==e.size)return!0;let s=t.limitType==="F"?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Ji(t,e,n){return Dn()<=Xt.DEBUG&&V("QueryEngine","Using full collection scan to execute query:",Nn(e)),this.zi.getDocumentsMatchingQuery(t,e,zt.min(),n)}es(t,e,n,i){return this.zi.getDocumentsMatchingQuery(t,n,i).next(s=>(e.forEach(a=>{s=s.insert(a.key,a)}),s))}};var pu=class{constructor(t,e,n,i){this.persistence=t,this.ts=e,this.serializer=i,this.ns=new st(K),this.rs=new oe(s=>un(s),_i),this.ss=new Map,this.os=t.getRemoteDocumentCache(),this.Qr=t.getTargetCache(),this.$r=t.getBundleCache(),this._s(n)}_s(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Rs(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.ns))}};function qf(r,t,e,n){return new pu(r,t,e,n)}function Uf(r,t){return C(this,null,function*(){let e=O(r);return yield e.persistence.runTransaction("Handle user change","readonly",n=>{let i;return e.mutationQueue.getAllMutationBatches(n).next(s=>(i=s,e._s(t),e.mutationQueue.getAllMutationBatches(n))).next(s=>{let a=[],u=[],l=$();for(let d of i){a.push(d.batchId);for(let f of d.mutations)l=l.add(f.key)}for(let d of s){u.push(d.batchId);for(let f of d.mutations)l=l.add(f.key)}return e.localDocuments.getDocuments(n,l).next(d=>({us:d,removedBatchIds:a,addedBatchIds:u}))})})})}function Bp(r,t){let e=O(r);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",n=>{let i=t.batch.keys(),s=e.os.newChangeBuffer({trackRemovals:!0});return function(u,l,d,f){let g=d.batch,y=g.keys(),S=b.resolve();return y.forEach(N=>{S=S.next(()=>f.getEntry(l,N)).next(k=>{let D=d.docVersions.get(N);q(D!==null),k.version.compareTo(D)<0&&(g.applyToRemoteDocument(k,d),k.isValidDocument()&&(k.setReadTime(d.commitVersion),f.addEntry(k)))})}),S.next(()=>u.mutationQueue.removeMutationBatch(l,g))}(e,n,t,s).next(()=>s.apply(n)).next(()=>e.mutationQueue.performConsistencyCheck(n)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(n,i,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(n,function(u){let l=$();for(let d=0;d<u.mutationResults.length;++d)u.mutationResults[d].transformResults.length>0&&(l=l.add(u.batch.mutations[d].key));return l}(t))).next(()=>e.localDocuments.getDocuments(n,i))})}function Bf(r){let t=O(r);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Qr.getLastRemoteSnapshotVersion(e))}function Gp(r,t){let e=O(r),n=t.snapshotVersion,i=e.ns;return e.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let a=e.os.newChangeBuffer({trackRemovals:!0});i=e.ns;let u=[];t.targetChanges.forEach((f,g)=>{let y=i.get(g);if(!y)return;u.push(e.Qr.removeMatchingKeys(s,f.removedDocuments,g).next(()=>e.Qr.addMatchingKeys(s,f.addedDocuments,g)));let S=y.withSequenceNumber(s.currentSequenceNumber);t.targetMismatches.get(g)!==null?S=S.withResumeToken(Et.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):f.resumeToken.approximateByteSize()>0&&(S=S.withResumeToken(f.resumeToken,n)),i=i.insert(g,S),function(k,D,G){return k.resumeToken.approximateByteSize()===0||D.snapshotVersion.toMicroseconds()-k.snapshotVersion.toMicroseconds()>=3e8?!0:G.addedDocuments.size+G.modifiedDocuments.size+G.removedDocuments.size>0}(y,S,f)&&u.push(e.Qr.updateTargetData(s,S))});let l=Ot(),d=$();if(t.documentUpdates.forEach(f=>{t.resolvedLimboDocuments.has(f)&&u.push(e.persistence.referenceDelegate.updateLimboDocument(s,f))}),u.push(Gf(s,a,t.documentUpdates).next(f=>{l=f.cs,d=f.ls})),!n.isEqual(B.min())){let f=e.Qr.getLastRemoteSnapshotVersion(s).next(g=>e.Qr.setTargetsMetadata(s,s.currentSequenceNumber,n));u.push(f)}return b.waitFor(u).next(()=>a.apply(s)).next(()=>e.localDocuments.getLocalViewOfDocuments(s,l,d)).next(()=>l)}).then(s=>(e.ns=i,s))}function Gf(r,t,e){let n=$(),i=$();return e.forEach(s=>n=n.add(s)),t.getEntries(r,n).next(s=>{let a=Ot();return e.forEach((u,l)=>{let d=s.get(u);l.isFoundDocument()!==d.isFoundDocument()&&(i=i.add(u)),l.isNoDocument()&&l.version.isEqual(B.min())?(t.removeEntry(u,l.readTime),a=a.insert(u,l)):!d.isValidDocument()||l.version.compareTo(d.version)>0||l.version.compareTo(d.version)===0&&d.hasPendingWrites?(t.addEntry(l),a=a.insert(u,l)):V("LocalStore","Ignoring outdated watch update for ",u,". Current version:",d.version," Watch version:",l.version)}),{cs:a,ls:i}})}function jp(r,t){let e=O(r);return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(t===void 0&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}function Jn(r,t){let e=O(r);return e.persistence.runTransaction("Allocate target","readwrite",n=>{let i;return e.Qr.getTargetData(n,t).next(s=>s?(i=s,b.resolve(i)):e.Qr.allocateTargetId(n).next(a=>(i=new Wn(t,a,"TargetPurposeListen",n.currentSequenceNumber),e.Qr.addTargetData(n,i).next(()=>i))))}).then(n=>{let i=e.ns.get(n.targetId);return(i===null||n.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(e.ns=e.ns.insert(n.targetId,n),e.rs.set(t,n.targetId)),n})}function Yn(r,t,e){return C(this,null,function*(){let n=O(r),i=n.ns.get(t),s=e?"readwrite":"readwrite-primary";try{e||(yield n.persistence.runTransaction("Release target",s,a=>n.persistence.referenceDelegate.removeTarget(a,i)))}catch(a){if(!ze(a))throw a;V("LocalStore",`Failed to update sequence numbers for target ${t}: ${a}`)}n.ns=n.ns.remove(t),n.rs.delete(i.target)})}function Vs(r,t,e){let n=O(r),i=B.min(),s=$();return n.persistence.runTransaction("Execute query","readwrite",a=>function(l,d,f){let g=O(l),y=g.rs.get(f);return y!==void 0?b.resolve(g.ns.get(y)):g.Qr.getTargetData(d,f)}(n,a,Ft(t)).next(u=>{if(u)return i=u.lastLimboFreeSnapshotVersion,n.Qr.getMatchingKeysForTargetId(a,u.targetId).next(l=>{s=l})}).next(()=>n.ts.getDocumentsMatchingQuery(a,t,e?i:B.min(),e?s:$())).next(u=>(Kf(n,nf(t),u),{documents:u,hs:s})))}function jf(r,t){let e=O(r),n=O(e.Qr),i=e.ns.get(t);return i?Promise.resolve(i.target):e.persistence.runTransaction("Get target data","readonly",s=>n.ot(s,t).next(a=>a?a.target:null))}function zf(r,t){let e=O(r),n=e.ss.get(t)||B.min();return e.persistence.runTransaction("Get new document changes","readonly",i=>e.os.getAllFromCollectionGroup(i,t,Fd(n,-1),Number.MAX_SAFE_INTEGER)).then(i=>(Kf(e,t,i),i))}function Kf(r,t,e){let n=r.ss.get(t)||B.min();e.forEach((i,s)=>{s.readTime.compareTo(n)>0&&(n=s.readTime)}),r.ss.set(t,n)}function zp(r,t,e,n){return C(this,null,function*(){let i=O(r),s=$(),a=Ot();for(let d of e){let f=t.Ps(d.metadata.name);d.document&&(s=s.add(f));let g=t.Is(d);g.setReadTime(t.Ts(d.metadata.readTime)),a=a.insert(f,g)}let u=i.os.newChangeBuffer({trackRemovals:!0}),l=yield Jn(i,function(f){return Ft(sr(Y.fromString(`__bundle__/docs/${f}`)))}(n));return i.persistence.runTransaction("Apply bundle documents","readwrite",d=>Gf(d,u,a).next(f=>(u.apply(d),f)).next(f=>i.Qr.removeMatchingKeysForTargetId(d,l.targetId).next(()=>i.Qr.addMatchingKeys(d,s,l.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(d,f.cs,f.ls)).next(()=>f.cs)))})}function Kp(n,i){return C(this,arguments,function*(r,t,e=$()){let s=yield Jn(r,Ft(dc(t.bundledQuery))),a=O(r);return a.persistence.runTransaction("Save named query","readwrite",u=>{let l=mt(t.readTime);if(s.snapshotVersion.compareTo(l)>=0)return a.$r.saveNamedQuery(u,t);let d=s.withResumeToken(Et.EMPTY_BYTE_STRING,l);return a.ns=a.ns.insert(d.targetId,d),a.Qr.updateTargetData(u,d).next(()=>a.Qr.removeMatchingKeysForTargetId(u,s.targetId)).next(()=>a.Qr.addMatchingKeys(u,e,s.targetId)).next(()=>a.$r.saveNamedQuery(u,t))})})}function vd(r,t){return`firestore_clients_${r}_${t}`}function Id(r,t,e){let n=`firestore_mutations_${r}_${e}`;return t.isAuthenticated()&&(n+=`_${t.uid}`),n}function ia(r,t){return`firestore_targets_${r}_${t}`}var Ds=class r{constructor(t,e,n,i){this.user=t,this.batchId=e,this.state=n,this.error=i}static Es(t,e,n){let i=JSON.parse(n),s,a=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return a&&i.error&&(a=typeof i.error.message=="string"&&typeof i.error.code=="string",a&&(s=new x(i.error.code,i.error.message))),a?new r(t,e,i.state,s):(dt("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}ds(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},$r=class r{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Es(t,e){let n=JSON.parse(e),i,s=typeof n=="object"&&["not-current","current","rejected"].indexOf(n.state)!==-1&&(n.error===void 0||typeof n.error=="object");return s&&n.error&&(s=typeof n.error.message=="string"&&typeof n.error.code=="string",s&&(i=new x(n.error.code,n.error.message))),s?new r(t,n.state,i):(dt("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}ds(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},Ns=class r{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Es(t,e){let n=JSON.parse(e),i=typeof n=="object"&&n.activeTargetIds instanceof Array,s=lc();for(let a=0;i&&a<n.activeTargetIds.length;++a)i=qd(n.activeTargetIds[a]),s=s.add(n.activeTargetIds[a]);return i?new r(t,s):(dt("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}},_u=class r{constructor(t,e){this.clientId=t,this.onlineState=e}static Es(t){let e=JSON.parse(t);return typeof e=="object"&&["Unknown","Online","Offline"].indexOf(e.onlineState)!==-1&&typeof e.clientId=="string"?new r(e.clientId,e.onlineState):(dt("SharedClientState",`Failed to parse online state: ${t}`),null)}},ci=class{constructor(){this.activeTargetIds=lc()}As(t){this.activeTargetIds=this.activeTargetIds.add(t)}Rs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}ds(){let t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}},Qr=class{constructor(t,e,n,i,s){this.window=t,this.oi=e,this.persistenceKey=n,this.Vs=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new st(K),this.started=!1,this.ys=[];let a=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ws=vd(this.persistenceKey,this.Vs),this.Ss=function(l){return`firestore_sequence_number_${l}`}(this.persistenceKey),this.ps=this.ps.insert(this.Vs,new ci),this.bs=new RegExp(`^firestore_clients_${a}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${a}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${a}_(\\d+)$`),this.vs=function(l){return`firestore_online_state_${l}`}(this.persistenceKey),this.Fs=function(l){return`firestore_bundle_loaded_v2_${l}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(t){return!(!t||!t.localStorage)}start(){return C(this,null,function*(){let t=yield this.syncEngine.Bi();for(let n of t){if(n===this.Vs)continue;let i=this.getItem(vd(this.persistenceKey,n));if(i){let s=Ns.Es(n,i);s&&(this.ps=this.ps.insert(s.clientId,s))}}this.Ms();let e=this.storage.getItem(this.vs);if(e){let n=this.xs(e);n&&this.Os(n)}for(let n of this.ys)this.gs(n);this.ys=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(t){this.setItem(this.Ss,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(t){let e=!1;return this.ps.forEach((n,i)=>{i.activeTargetIds.has(t)&&(e=!0)}),e}addPendingMutation(t){this.Ls(t,"pending")}updateMutationState(t,e,n){this.Ls(t,e,n),this.Bs(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){let n=this.storage.getItem(ia(this.persistenceKey,t));if(n){let i=$r.Es(t,n);i&&(e=i.state)}}return this.ks.As(t),this.Ms(),e}removeLocalQueryTarget(t){this.ks.Rs(t),this.Ms()}isLocalQueryTarget(t){return this.ks.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(ia(this.persistenceKey,t))}updateQueryState(t,e,n){this.qs(t,e,n)}handleUserChange(t,e,n){e.forEach(i=>{this.Bs(i)}),this.currentUser=t,n.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(t){this.Qs(t)}notifyBundleLoaded(t){this.Ks(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(t){let e=this.storage.getItem(t);return V("SharedClientState","READ",t,e),e}setItem(t,e){V("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){V("SharedClientState","REMOVE",t),this.storage.removeItem(t)}gs(t){let e=t;if(e.storageArea===this.storage){if(V("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ws)return void dt("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable(()=>C(this,null,function*(){if(this.started){if(e.key!==null){if(this.bs.test(e.key)){if(e.newValue==null){let n=this.$s(e.key);return this.Us(n,null)}{let n=this.Ws(e.key,e.newValue);if(n)return this.Us(n.clientId,n)}}else if(this.Ds.test(e.key)){if(e.newValue!==null){let n=this.Gs(e.key,e.newValue);if(n)return this.zs(n)}}else if(this.Cs.test(e.key)){if(e.newValue!==null){let n=this.js(e.key,e.newValue);if(n)return this.Hs(n)}}else if(e.key===this.vs){if(e.newValue!==null){let n=this.xs(e.newValue);if(n)return this.Os(n)}}else if(e.key===this.Ss){let n=function(s){let a=qt.oe;if(s!=null)try{let u=JSON.parse(s);q(typeof u=="number"),a=u}catch(u){dt("SharedClientState","Failed to read sequence number from WebStorage",u)}return a}(e.newValue);n!==qt.oe&&this.sequenceNumberHandler(n)}else if(e.key===this.Fs){let n=this.Js(e.newValue);yield Promise.all(n.map(i=>this.syncEngine.Ys(i)))}}}else this.ys.push(e)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Ls(t,e,n){let i=new Ds(this.currentUser,t,e,n),s=Id(this.persistenceKey,this.currentUser,t);this.setItem(s,i.ds())}Bs(t){let e=Id(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Qs(t){let e={clientId:this.Vs,onlineState:t};this.storage.setItem(this.vs,JSON.stringify(e))}qs(t,e,n){let i=ia(this.persistenceKey,t),s=new $r(t,e,n);this.setItem(i,s.ds())}Ks(t){let e=JSON.stringify(Array.from(t));this.setItem(this.Fs,e)}$s(t){let e=this.bs.exec(t);return e?e[1]:null}Ws(t,e){let n=this.$s(t);return Ns.Es(n,e)}Gs(t,e){let n=this.Ds.exec(t),i=Number(n[1]),s=n[2]!==void 0?n[2]:null;return Ds.Es(new _t(s),i,e)}js(t,e){let n=this.Cs.exec(t),i=Number(n[1]);return $r.Es(i,e)}xs(t){return _u.Es(t)}Js(t){return JSON.parse(t)}zs(t){return C(this,null,function*(){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Zs(t.batchId,t.state,t.error);V("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)})}Hs(t){return this.syncEngine.Xs(t.targetId,t.state,t.error)}Us(t,e){let n=e?this.ps.insert(t,e):this.ps.remove(t),i=this.Ns(this.ps),s=this.Ns(n),a=[],u=[];return s.forEach(l=>{i.has(l)||a.push(l)}),i.forEach(l=>{s.has(l)||u.push(l)}),this.syncEngine.eo(a,u).then(()=>{this.ps=n})}Os(t){this.ps.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Ns(t){let e=lc();return t.forEach((n,i)=>{e=e.unionWith(i.activeTargetIds)}),e}},ks=class{constructor(){this.no=new ci,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.no.As(t),this.ro[t]||"not-current"}updateQueryState(t,e,n){this.ro[t]=e}removeLocalQueryTarget(t){this.no.Rs(t)}isLocalQueryTarget(t){return this.no.activeTargetIds.has(t)}clearQueryState(t){delete this.ro[t]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(t){return this.no.activeTargetIds.has(t)}start(){return this.no=new ci,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}};var yu=class{io(t){}shutdown(){}};var Fs=class{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(t){this.uo.push(t)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){V("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let t of this.uo)t(0)}ao(){V("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let t of this.uo)t(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var Yi=null;function sa(){return Yi===null?Yi=function(){return 268435456+Math.round(2147483648*Math.random())}():Yi++,"0x"+Yi.toString(16)}var $p={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var wu=class{constructor(t){this.lo=t.lo,this.ho=t.ho}Po(t){this.Io=t}To(t){this.Eo=t}Ao(t){this.Ro=t}onMessage(t){this.Vo=t}close(){this.ho()}send(t){this.lo(t)}mo(){this.Io()}fo(){this.Eo()}po(t){this.Ro(t)}yo(t){this.Vo(t)}};var xt="WebChannelConnection",vu=class extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let n=e.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.wo=n+"://"+e.host,this.So=`projects/${i}/databases/${s}`,this.bo=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get Do(){return!1}Co(e,n,i,s,a){let u=sa(),l=this.vo(e,n.toUriEncodedString());V("RestConnection",`Sending RPC '${e}' ${u}:`,l,i);let d={"google-cloud-resource-prefix":this.So,"x-goog-request-params":this.bo};return this.Fo(d,s,a),this.Mo(e,l,d,i).then(f=>(V("RestConnection",`Received RPC '${e}' ${u}: `,f),f),f=>{throw jt("RestConnection",`RPC '${e}' ${u} failed with error: `,f,"url: ",l,"request:",i),f})}xo(e,n,i,s,a,u){return this.Co(e,n,i,s,a)}Fo(e,n,i){e["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+ir}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),n&&n.headers.forEach((s,a)=>e[a]=s),i&&i.headers.forEach((s,a)=>e[a]=s)}vo(e,n){let i=$p[e];return`${this.wo}/v1/${n}:${i}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}Mo(t,e,n,i){let s=sa();return new Promise((a,u)=>{let l=new Jo;l.setWithCredentials(!0),l.listenOnce(Xo.COMPLETE,()=>{try{switch(l.getLastErrorCode()){case Mr.NO_ERROR:let f=l.getResponseJson();V(xt,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(f)),a(f);break;case Mr.TIMEOUT:V(xt,`RPC '${t}' ${s} timed out`),u(new x(P.DEADLINE_EXCEEDED,"Request time out"));break;case Mr.HTTP_ERROR:let g=l.getStatus();if(V(xt,`RPC '${t}' ${s} failed with status:`,g,"response text:",l.getResponseText()),g>0){let y=l.getResponseJson();Array.isArray(y)&&(y=y[0]);let S=y?.error;if(S&&S.status&&S.message){let N=function(D){let G=D.toLowerCase().replace(/_/g,"-");return Object.values(P).indexOf(G)>=0?G:P.UNKNOWN}(S.status);u(new x(N,S.message))}else u(new x(P.UNKNOWN,"Server responded with status "+l.getStatus()))}else u(new x(P.UNAVAILABLE,"Connection failed."));break;default:L()}}finally{V(xt,`RPC '${t}' ${s} completed.`)}});let d=JSON.stringify(i);V(xt,`RPC '${t}' ${s} sending request:`,i),l.send(e,"POST",d,n,15)})}Oo(t,e,n){let i=sa(),s=[this.wo,"/","google.firestore.v1.Firestore","/",t,"/channel"],a=ea(),u=ta(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},d=this.longPollingOptions.timeoutSeconds;d!==void 0&&(l.longPollingTimeout=Math.round(1e3*d)),this.useFetchStreams&&(l.xmlHttpFactory=new Yo({})),this.Fo(l.initMessageHeaders,e,n),l.encodeInitMessageHeaders=!0;let f=s.join("");V(xt,`Creating RPC '${t}' stream ${i}: ${f}`,l);let g=a.createWebChannel(f,l),y=!1,S=!1,N=new wu({lo:D=>{S?V(xt,`Not sending because RPC '${t}' stream ${i} is closed:`,D):(y||(V(xt,`Opening RPC '${t}' stream ${i} transport.`),g.open(),y=!0),V(xt,`RPC '${t}' stream ${i} sending:`,D),g.send(D))},ho:()=>g.close()}),k=(D,G,j)=>{D.listen(G,U=>{try{j(U)}catch(Q){setTimeout(()=>{throw Q},0)}})};return k(g,Rn.EventType.OPEN,()=>{S||(V(xt,`RPC '${t}' stream ${i} transport opened.`),N.mo())}),k(g,Rn.EventType.CLOSE,()=>{S||(S=!0,V(xt,`RPC '${t}' stream ${i} transport closed`),N.po())}),k(g,Rn.EventType.ERROR,D=>{S||(S=!0,jt(xt,`RPC '${t}' stream ${i} transport errored:`,D),N.po(new x(P.UNAVAILABLE,"The operation could not be completed")))}),k(g,Rn.EventType.MESSAGE,D=>{var G;if(!S){let j=D.data[0];q(!!j);let U=j,Q=U.error||((G=U[0])===null||G===void 0?void 0:G.error);if(Q){V(xt,`RPC '${t}' stream ${i} received error:`,Q);let H=Q.status,z=function(w){let I=gt[w];if(I!==void 0)return yf(I)}(H),v=Q.message;z===void 0&&(z=P.INTERNAL,v="Unknown error status: "+H+" with message "+Q.message),S=!0,N.po(new x(z,v)),g.close()}else V(xt,`RPC '${t}' stream ${i} received:`,j),N.yo(j)}}),k(u,Zo.STAT_EVENT,D=>{D.stat===Qi.PROXY?V(xt,`RPC '${t}' stream ${i} detected buffering proxy`):D.stat===Qi.NOPROXY&&V(xt,`RPC '${t}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{N.fo()},0),N}};function $f(){return typeof window<"u"?window:null}function ns(){return typeof document<"u"?document:null}function vi(r){return new Oa(r,!0)}var li=class{constructor(t,e,n=1e3,i=1.5,s=6e4){this.oi=t,this.timerId=e,this.No=n,this.Lo=i,this.Bo=s,this.ko=0,this.qo=null,this.Qo=Date.now(),this.reset()}reset(){this.ko=0}Ko(){this.ko=this.Bo}$o(t){this.cancel();let e=Math.floor(this.ko+this.Uo()),n=Math.max(0,Date.now()-this.Qo),i=Math.max(0,e-n);i>0&&V("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.ko} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.qo=this.oi.enqueueAfterDelay(this.timerId,i,()=>(this.Qo=Date.now(),t())),this.ko*=this.Lo,this.ko<this.No&&(this.ko=this.No),this.ko>this.Bo&&(this.ko=this.Bo)}Wo(){this.qo!==null&&(this.qo.skipDelay(),this.qo=null)}cancel(){this.qo!==null&&(this.qo.cancel(),this.qo=null)}Uo(){return(Math.random()-.5)*this.ko}};var Ms=class{constructor(t,e,n,i,s,a,u,l){this.oi=t,this.Go=n,this.zo=i,this.connection=s,this.authCredentialsProvider=a,this.appCheckCredentialsProvider=u,this.listener=l,this.state=0,this.jo=0,this.Ho=null,this.Jo=null,this.stream=null,this.Yo=new li(t,e)}Zo(){return this.state===1||this.state===5||this.Xo()}Xo(){return this.state===2||this.state===3}start(){this.state!==4?this.auth():this.e_()}stop(){return C(this,null,function*(){this.Zo()&&(yield this.close(0))})}t_(){this.state=0,this.Yo.reset()}n_(){this.Xo()&&this.Ho===null&&(this.Ho=this.oi.enqueueAfterDelay(this.Go,6e4,()=>this.r_()))}i_(t){this.s_(),this.stream.send(t)}r_(){return C(this,null,function*(){if(this.Xo())return this.close(0)})}s_(){this.Ho&&(this.Ho.cancel(),this.Ho=null)}o_(){this.Jo&&(this.Jo.cancel(),this.Jo=null)}close(t,e){return C(this,null,function*(){this.s_(),this.o_(),this.Yo.cancel(),this.jo++,t!==4?this.Yo.reset():e&&e.code===P.RESOURCE_EXHAUSTED?(dt(e.toString()),dt("Using maximum backoff delay to prevent overloading the backend."),this.Yo.Ko()):e&&e.code===P.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.__(),this.stream.close(),this.stream=null),this.state=t,yield this.listener.Ao(e)})}__(){}auth(){this.state=1;let t=this.a_(this.jo),e=this.jo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([n,i])=>{this.jo===e&&this.u_(n,i)},n=>{t(()=>{let i=new x(P.UNKNOWN,"Fetching auth token failed: "+n.message);return this.c_(i)})})}u_(t,e){let n=this.a_(this.jo);this.stream=this.l_(t,e),this.stream.Po(()=>{n(()=>this.listener.Po())}),this.stream.To(()=>{n(()=>(this.state=2,this.Jo=this.oi.enqueueAfterDelay(this.zo,1e4,()=>(this.Xo()&&(this.state=3),Promise.resolve())),this.listener.To()))}),this.stream.Ao(i=>{n(()=>this.c_(i))}),this.stream.onMessage(i=>{n(()=>this.onMessage(i))})}e_(){this.state=5,this.Yo.$o(()=>C(this,null,function*(){this.state=0,this.start()}))}c_(t){return V("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}a_(t){return e=>{this.oi.enqueueAndForget(()=>this.jo===t?e():(V("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},Iu=class extends Ms{constructor(t,e,n,i,s,a){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,i,a),this.serializer=s}l_(t,e){return this.connection.Oo("Listen",t,e)}onMessage(t){this.Yo.reset();let e=xp(this.serializer,t),n=function(s){if(!("targetChange"in s))return B.min();let a=s.targetChange;return a.targetIds&&a.targetIds.length?B.min():a.readTime?mt(a.readTime):B.min()}(t);return this.listener.h_(e,n)}P_(t){let e={};e.database=Ua(this.serializer),e.addTarget=function(s,a){let u,l=a.target;if(u=fs(l)?{documents:bf(s,l)}:{query:Rf(s,l)._t},u.targetId=a.targetId,a.resumeToken.approximateByteSize()>0){u.resumeToken=vf(s,a.resumeToken);let d=La(s,a.expectedCount);d!==null&&(u.expectedCount=d)}else if(a.snapshotVersion.compareTo(B.min())>0){u.readTime=Qn(s,a.snapshotVersion.toTimestamp());let d=La(s,a.expectedCount);d!==null&&(u.expectedCount=d)}return u}(this.serializer,t);let n=Dp(this.serializer,t);n&&(e.labels=n),this.i_(e)}I_(t){let e={};e.database=Ua(this.serializer),e.removeTarget=t,this.i_(e)}},Eu=class extends Ms{constructor(t,e,n,i,s,a){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,i,a),this.serializer=s,this.T_=!1}get E_(){return this.T_}start(){this.T_=!1,this.lastStreamToken=void 0,super.start()}__(){this.T_&&this.d_([])}l_(t,e){return this.connection.Oo("Write",t,e)}onMessage(t){if(q(!!t.streamToken),this.lastStreamToken=t.streamToken,this.T_){this.Yo.reset();let e=Vp(t.writeResults,t.commitTime),n=mt(t.commitTime);return this.listener.A_(n,e)}return q(!t.writeResults||t.writeResults.length===0),this.T_=!0,this.listener.R_()}V_(){let t={};t.database=Ua(this.serializer),this.i_(t)}d_(t){let e={streamToken:this.lastStreamToken,writes:t.map(n=>oi(this.serializer,n))};this.i_(e)}};var Tu=class extends class{}{constructor(t,e,n,i){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=i,this.m_=!1}f_(){if(this.m_)throw new x(P.FAILED_PRECONDITION,"The client has already been terminated.")}Co(t,e,n,i){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Co(t,qa(e,n),i,s,a)).catch(s=>{throw s.name==="FirebaseError"?(s.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new x(P.UNKNOWN,s.toString())})}xo(t,e,n,i,s){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([a,u])=>this.connection.xo(t,qa(e,n),i,a,u,s)).catch(a=>{throw a.name==="FirebaseError"?(a.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),a):new x(P.UNKNOWN,a.toString())})}terminate(){this.m_=!0,this.connection.terminate()}},Au=class{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.g_=0,this.p_=null,this.y_=!0}w_(){this.g_===0&&(this.S_("Unknown"),this.p_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.p_=null,this.b_("Backend didn't respond within 10 seconds."),this.S_("Offline"),Promise.resolve())))}D_(t){this.state==="Online"?this.S_("Unknown"):(this.g_++,this.g_>=1&&(this.C_(),this.b_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.S_("Offline")))}set(t){this.C_(),this.g_=0,t==="Online"&&(this.y_=!1),this.S_(t)}S_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}b_(t){let e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.y_?(dt(e),this.y_=!1):V("OnlineStateTracker",e)}C_(){this.p_!==null&&(this.p_.cancel(),this.p_=null)}};var Su=class{constructor(t,e,n,i,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.v_=[],this.F_=new Map,this.M_=new Set,this.x_=[],this.O_=s,this.O_.io(a=>{n.enqueueAndForget(()=>C(this,null,function*(){Ke(this)&&(V("RemoteStore","Restarting streams for network reachability change."),yield function(l){return C(this,null,function*(){let d=O(l);d.M_.add(4),yield or(d),d.N_.set("Unknown"),d.M_.delete(4),yield Ii(d)})}(this))}))}),this.N_=new Au(n,i)}};function Ii(r){return C(this,null,function*(){if(Ke(r))for(let t of r.x_)yield t(!0)})}function or(r){return C(this,null,function*(){for(let t of r.x_)yield t(!1)})}function eo(r,t){let e=O(r);e.F_.has(t.targetId)||(e.F_.set(t.targetId,t),_c(e)?pc(e):ur(e).Xo()&&gc(e,t))}function Xn(r,t){let e=O(r),n=ur(e);e.F_.delete(t),n.Xo()&&Qf(e,t),e.F_.size===0&&(n.Xo()?n.n_():Ke(e)&&e.N_.set("Unknown"))}function gc(r,t){if(r.L_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(B.min())>0){let e=r.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}ur(r).P_(t)}function Qf(r,t){r.L_.xe(t),ur(r).I_(t)}function pc(r){r.L_=new Ma({getRemoteKeysForTarget:t=>r.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>r.F_.get(t)||null,tt:()=>r.datastore.serializer.databaseId}),ur(r).start(),r.N_.w_()}function _c(r){return Ke(r)&&!ur(r).Zo()&&r.F_.size>0}function Ke(r){return O(r).M_.size===0}function Wf(r){r.L_=void 0}function Qp(r){return C(this,null,function*(){r.N_.set("Online")})}function Wp(r){return C(this,null,function*(){r.F_.forEach((t,e)=>{gc(r,t)})})}function Hp(r,t){return C(this,null,function*(){Wf(r),_c(r)?(r.N_.D_(t),pc(r)):r.N_.set("Unknown")})}function Jp(r,t,e){return C(this,null,function*(){if(r.N_.set("Online"),t instanceof _s&&t.state===2&&t.cause)try{yield function(i,s){return C(this,null,function*(){let a=s.cause;for(let u of s.targetIds)i.F_.has(u)&&(yield i.remoteSyncer.rejectListen(u,a),i.F_.delete(u),i.L_.removeTarget(u))})}(r,t)}catch(n){V("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),yield Os(r,n)}else if(t instanceof Un?r.L_.Ke(t):t instanceof ps?r.L_.He(t):r.L_.We(t),!e.isEqual(B.min()))try{let n=yield Bf(r.localStore);e.compareTo(n)>=0&&(yield function(s,a){let u=s.L_.rt(a);return u.targetChanges.forEach((l,d)=>{if(l.resumeToken.approximateByteSize()>0){let f=s.F_.get(d);f&&s.F_.set(d,f.withResumeToken(l.resumeToken,a))}}),u.targetMismatches.forEach((l,d)=>{let f=s.F_.get(l);if(!f)return;s.F_.set(l,f.withResumeToken(Et.EMPTY_BYTE_STRING,f.snapshotVersion)),Qf(s,l);let g=new Wn(f.target,l,d,f.sequenceNumber);gc(s,g)}),s.remoteSyncer.applyRemoteEvent(u)}(r,e))}catch(n){V("RemoteStore","Failed to raise snapshot:",n),yield Os(r,n)}})}function Os(r,t,e){return C(this,null,function*(){if(!ze(t))throw t;r.M_.add(1),yield or(r),r.N_.set("Offline"),e||(e=()=>Bf(r.localStore)),r.asyncQueue.enqueueRetryable(()=>C(this,null,function*(){V("RemoteStore","Retrying IndexedDB access"),yield e(),r.M_.delete(1),yield Ii(r)}))})}function Hf(r,t){return t().catch(e=>Os(r,e,t))}function ar(r){return C(this,null,function*(){let t=O(r),e=Ge(t),n=t.v_.length>0?t.v_[t.v_.length-1].batchId:-1;for(;Yp(t);)try{let i=yield jp(t.localStore,n);if(i===null){t.v_.length===0&&e.n_();break}n=i.batchId,Xp(t,i)}catch(i){yield Os(t,i)}Jf(t)&&Yf(t)})}function Yp(r){return Ke(r)&&r.v_.length<10}function Xp(r,t){r.v_.push(t);let e=Ge(r);e.Xo()&&e.E_&&e.d_(t.mutations)}function Jf(r){return Ke(r)&&!Ge(r).Zo()&&r.v_.length>0}function Yf(r){Ge(r).start()}function Zp(r){return C(this,null,function*(){Ge(r).V_()})}function t_(r){return C(this,null,function*(){let t=Ge(r);for(let e of r.v_)t.d_(e.mutations)})}function e_(r,t,e){return C(this,null,function*(){let n=r.v_.shift(),i=Na.from(n,t,e);yield Hf(r,()=>r.remoteSyncer.applySuccessfulWrite(i)),yield ar(r)})}function n_(r,t){return C(this,null,function*(){t&&Ge(r).E_&&(yield function(n,i){return C(this,null,function*(){if(function(a){return _f(a)&&a!==P.ABORTED}(i.code)){let s=n.v_.shift();Ge(n).t_(),yield Hf(n,()=>n.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield ar(n)}})}(r,t)),Jf(r)&&Yf(r)})}function Ed(r,t){return C(this,null,function*(){let e=O(r);e.asyncQueue.verifyOperationInProgress(),V("RemoteStore","RemoteStore received new credentials");let n=Ke(e);e.M_.add(3),yield or(e),n&&e.N_.set("Unknown"),yield e.remoteSyncer.handleCredentialChange(t),e.M_.delete(3),yield Ii(e)})}function bu(r,t){return C(this,null,function*(){let e=O(r);t?(e.M_.delete(2),yield Ii(e)):t||(e.M_.add(2),yield or(e),e.N_.set("Unknown"))})}function ur(r){return r.B_||(r.B_=function(e,n,i){let s=O(e);return s.f_(),new Iu(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Po:Qp.bind(null,r),To:Wp.bind(null,r),Ao:Hp.bind(null,r),h_:Jp.bind(null,r)}),r.x_.push(t=>C(this,null,function*(){t?(r.B_.t_(),_c(r)?pc(r):r.N_.set("Unknown")):(yield r.B_.stop(),Wf(r))}))),r.B_}function Ge(r){return r.k_||(r.k_=function(e,n,i){let s=O(e);return s.f_(),new Eu(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Po:()=>Promise.resolve(),To:Zp.bind(null,r),Ao:n_.bind(null,r),R_:t_.bind(null,r),A_:e_.bind(null,r)}),r.x_.push(t=>C(this,null,function*(){t?(r.k_.t_(),yield ar(r)):(yield r.k_.stop(),r.v_.length>0&&(V("RemoteStore",`Stopping write stream with ${r.v_.length} pending writes`),r.v_=[]))}))),r.k_}var Ru=class r{constructor(t,e,n,i,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=i,this.removalCallback=s,this.deferred=new yt,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(a=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,n,i,s){let a=Date.now()+n,u=new r(t,e,a,i,s);return u.start(n),u}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new x(P.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function cr(r,t){if(dt("AsyncQueue",`${t}: ${r}`),ze(r))return new x(P.UNAVAILABLE,`${t}: ${r}`);throw r}var Ls=class r{constructor(t){this.comparator=t?(e,n)=>t(e,n)||M.comparator(e.key,n.key):(e,n)=>M.comparator(e.key,n.key),this.keyedMap=Br(),this.sortedSet=new st(this.comparator)}static emptySet(t){return new r(t.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){let e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,n)=>(t(e),!1))}add(t){let e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){let e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof r)||this.size!==t.size)return!1;let e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=n.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){let n=new r;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}};var qs=class{constructor(){this.q_=new st(M.comparator)}track(t){let e=t.doc.key,n=this.q_.get(e);n?t.type!==0&&n.type===3?this.q_=this.q_.insert(e,t):t.type===3&&n.type!==1?this.q_=this.q_.insert(e,{type:n.type,doc:t.doc}):t.type===2&&n.type===2?this.q_=this.q_.insert(e,{type:2,doc:t.doc}):t.type===2&&n.type===0?this.q_=this.q_.insert(e,{type:0,doc:t.doc}):t.type===1&&n.type===0?this.q_=this.q_.remove(e):t.type===1&&n.type===2?this.q_=this.q_.insert(e,{type:1,doc:n.doc}):t.type===0&&n.type===1?this.q_=this.q_.insert(e,{type:2,doc:t.doc}):L():this.q_=this.q_.insert(e,t)}Q_(){let t=[];return this.q_.inorderTraversal((e,n)=>{t.push(n)}),t}},Zn=class r{constructor(t,e,n,i,s,a,u,l,d){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=i,this.mutatedKeys=s,this.fromCache=a,this.syncStateChanged=u,this.excludesMetadataChanges=l,this.hasCachedResults=d}static fromInitialDocuments(t,e,n,i,s){let a=[];return e.forEach(u=>{a.push({type:0,doc:u})}),new r(t,e,Ls.emptySet(e),a,n,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&yi(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;let e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let i=0;i<e.length;i++)if(e[i].type!==n[i].type||!e[i].doc.isEqual(n[i].doc))return!1;return!0}};var Pu=class{constructor(){this.K_=void 0,this.U_=[]}W_(){return this.U_.some(t=>t.G_())}},Cu=class{constructor(){this.queries=new oe(t=>ef(t),yi),this.onlineState="Unknown",this.z_=new Set}};function yc(r,t){return C(this,null,function*(){let e=O(r),n=3,i=t.query,s=e.queries.get(i);s?!s.W_()&&t.G_()&&(n=2):(s=new Pu,n=t.G_()?0:1);try{switch(n){case 0:s.K_=yield e.onListen(i,!0);break;case 1:s.K_=yield e.onListen(i,!1);break;case 2:yield e.onFirstRemoteStoreListen(i)}}catch(a){let u=cr(a,`Initialization of query '${Nn(t.query)}' failed`);return void t.onError(u)}e.queries.set(i,s),s.U_.push(t),t.j_(e.onlineState),s.K_&&t.H_(s.K_)&&vc(e)})}function wc(r,t){return C(this,null,function*(){let e=O(r),n=t.query,i=3,s=e.queries.get(n);if(s){let a=s.U_.indexOf(t);a>=0&&(s.U_.splice(a,1),s.U_.length===0?i=t.G_()?0:1:!s.W_()&&t.G_()&&(i=2))}switch(i){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}})}function r_(r,t){let e=O(r),n=!1;for(let i of t){let s=i.query,a=e.queries.get(s);if(a){for(let u of a.U_)u.H_(i)&&(n=!0);a.K_=i}}n&&vc(e)}function i_(r,t,e){let n=O(r),i=n.queries.get(t);if(i)for(let s of i.U_)s.onError(e);n.queries.delete(t)}function vc(r){r.z_.forEach(t=>{t.next()})}var xu,Td;(Td=xu||(xu={})).J_="default",Td.Cache="cache";var hi=class{constructor(t,e,n){this.query=t,this.Y_=e,this.Z_=!1,this.X_=null,this.onlineState="Unknown",this.options=n||{}}H_(t){if(!this.options.includeMetadataChanges){let n=[];for(let i of t.docChanges)i.type!==3&&n.push(i);t=new Zn(t.query,t.docs,t.oldDocs,n,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.Z_?this.ea(t)&&(this.Y_.next(t),e=!0):this.ta(t,this.onlineState)&&(this.na(t),e=!0),this.X_=t,e}onError(t){this.Y_.error(t)}j_(t){this.onlineState=t;let e=!1;return this.X_&&!this.Z_&&this.ta(this.X_,t)&&(this.na(this.X_),e=!0),e}ta(t,e){if(!t.fromCache||!this.G_())return!0;let n=e!=="Offline";return(!this.options.ra||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}ea(t){if(t.docChanges.length>0)return!0;let e=this.X_&&this.X_.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}na(t){t=Zn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.Z_=!0,this.Y_.next(t)}G_(){return this.options.source!==xu.Cache}};var Vu=class{constructor(t,e){this.ia=t,this.byteLength=e}sa(){return"metadata"in this.ia}};var Us=class{constructor(t){this.serializer=t}Ps(t){return ne(this.serializer,t)}Is(t){return t.metadata.exists?Sf(this.serializer,t.document,!1):wt.newNoDocument(this.Ps(t.metadata.name),this.Ts(t.metadata.readTime))}Ts(t){return mt(t)}},Du=class{constructor(t,e,n){this.oa=t,this.localStore=e,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Xf(t)}_a(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.ia.namedQuery)this.queries.push(t.ia.namedQuery);else if(t.ia.documentMetadata){this.documents.push({metadata:t.ia.documentMetadata}),t.ia.documentMetadata.exists||++e;let n=Y.fromString(t.ia.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.ia.document&&(this.documents[this.documents.length-1].document=t.ia.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}aa(t){let e=new Map,n=new Us(this.serializer);for(let i of t)if(i.metadata.queries){let s=n.Ps(i.metadata.name);for(let a of i.metadata.queries){let u=(e.get(a)||$()).add(s);e.set(a,u)}}return e}complete(){return C(this,null,function*(){let t=yield zp(this.localStore,new Us(this.serializer),this.documents,this.oa.id),e=this.aa(this.documents);for(let n of this.queries)yield Kp(this.localStore,n,e.get(n.name));return this.progress.taskState="Success",{progress:this.progress,ua:this.collectionGroups,ca:t}})}};function Xf(r){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:r.totalDocuments,totalBytes:r.totalBytes}}var Bs=class{constructor(t){this.key=t}},Gs=class{constructor(t){this.key=t}},js=class{constructor(t,e){this.query=t,this.la=e,this.ha=null,this.hasCachedResults=!1,this.current=!1,this.Pa=$(),this.mutatedKeys=$(),this.Ia=rf(t),this.Ta=new Ls(this.Ia)}get Ea(){return this.la}da(t,e){let n=e?e.Aa:new qs,i=e?e.Ta:this.Ta,s=e?e.mutatedKeys:this.mutatedKeys,a=i,u=!1,l=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,d=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(t.inorderTraversal((f,g)=>{let y=i.get(f),S=wi(this.query,g)?g:null,N=!!y&&this.mutatedKeys.has(y.key),k=!!S&&(S.hasLocalMutations||this.mutatedKeys.has(S.key)&&S.hasCommittedMutations),D=!1;y&&S?y.data.isEqual(S.data)?N!==k&&(n.track({type:3,doc:S}),D=!0):this.Ra(y,S)||(n.track({type:2,doc:S}),D=!0,(l&&this.Ia(S,l)>0||d&&this.Ia(S,d)<0)&&(u=!0)):!y&&S?(n.track({type:0,doc:S}),D=!0):y&&!S&&(n.track({type:1,doc:y}),D=!0,(l||d)&&(u=!0)),D&&(S?(a=a.add(S),s=k?s.add(f):s.delete(f)):(a=a.delete(f),s=s.delete(f)))}),this.query.limit!==null)for(;a.size>this.query.limit;){let f=this.query.limitType==="F"?a.last():a.first();a=a.delete(f.key),s=s.delete(f.key),n.track({type:1,doc:f})}return{Ta:a,Aa:n,Xi:u,mutatedKeys:s}}Ra(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n,i){let s=this.Ta;this.Ta=t.Ta,this.mutatedKeys=t.mutatedKeys;let a=t.Aa.Q_();a.sort((f,g)=>function(S,N){let k=D=>{switch(D){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return L()}};return k(S)-k(N)}(f.type,g.type)||this.Ia(f.doc,g.doc)),this.Va(n),i=i!=null&&i;let u=e&&!i?this.ma():[],l=this.Pa.size===0&&this.current&&!i?1:0,d=l!==this.ha;return this.ha=l,a.length!==0||d?{snapshot:new Zn(this.query,t.Ta,s,a,t.mutatedKeys,l===0,d,!1,!!n&&n.resumeToken.approximateByteSize()>0),fa:u}:{fa:u}}j_(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({Ta:this.Ta,Aa:new qs,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{fa:[]}}ga(t){return!this.la.has(t)&&!!this.Ta.has(t)&&!this.Ta.get(t).hasLocalMutations}Va(t){t&&(t.addedDocuments.forEach(e=>this.la=this.la.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.la=this.la.delete(e)),this.current=t.current)}ma(){if(!this.current)return[];let t=this.Pa;this.Pa=$(),this.Ta.forEach(n=>{this.ga(n.key)&&(this.Pa=this.Pa.add(n.key))});let e=[];return t.forEach(n=>{this.Pa.has(n)||e.push(new Gs(n))}),this.Pa.forEach(n=>{t.has(n)||e.push(new Bs(n))}),e}pa(t){this.la=t.hs,this.Pa=$();let e=this.da(t.documents);return this.applyChanges(e,!0)}ya(){return Zn.fromInitialDocuments(this.query,this.Ta,this.mutatedKeys,this.ha===0,this.hasCachedResults)}},Nu=class{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}},ku=class{constructor(t){this.key=t,this.wa=!1}},Fu=class{constructor(t,e,n,i,s,a){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=a,this.Sa={},this.ba=new oe(u=>ef(u),yi),this.Da=new Map,this.Ca=new Set,this.va=new st(M.comparator),this.Fa=new Map,this.Ma=new ui,this.xa={},this.Oa=new Map,this.Na=Hn.Ln(),this.onlineState="Unknown",this.La=void 0}get isPrimaryClient(){return this.La===!0}};function s_(r,t,e=!0){return C(this,null,function*(){let n=no(r),i,s=n.ba.get(t);return s?(n.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.ya()):i=yield Zf(n,t,e,!0),i})}function o_(r,t){return C(this,null,function*(){let e=no(r);yield Zf(e,t,!0,!1)})}function Zf(r,t,e,n){return C(this,null,function*(){let i=yield Jn(r.localStore,Ft(t)),s=i.targetId,a=e?r.sharedClientState.addLocalQueryTarget(s):"not-current",u;return n&&(u=yield Ic(r,t,s,a==="current",i.resumeToken)),r.isPrimaryClient&&e&&eo(r.remoteStore,i),u})}function Ic(r,t,e,n,i){return C(this,null,function*(){r.Ba=(g,y,S)=>function(k,D,G,j){return C(this,null,function*(){let U=D.view.da(G);U.Xi&&(U=yield Vs(k.localStore,D.query,!1).then(({documents:v})=>D.view.da(v,U)));let Q=j&&j.targetChanges.get(D.targetId),H=j&&j.targetMismatches.get(D.targetId)!=null,z=D.view.applyChanges(U,k.isPrimaryClient,Q,H);return Mu(k,D.targetId,z.fa),z.snapshot})}(r,g,y,S);let s=yield Vs(r.localStore,t,!0),a=new js(t,s.hs),u=a.da(s.documents),l=ii.createSynthesizedTargetChangeForCurrentChange(e,n&&r.onlineState!=="Offline",i),d=a.applyChanges(u,r.isPrimaryClient,l);Mu(r,e,d.fa);let f=new Nu(t,e,a);return r.ba.set(t,f),r.Da.has(e)?r.Da.get(e).push(t):r.Da.set(e,[t]),d.snapshot})}function a_(r,t,e){return C(this,null,function*(){let n=O(r),i=n.ba.get(t),s=n.Da.get(i.targetId);if(s.length>1)return n.Da.set(i.targetId,s.filter(a=>!yi(a,t))),void n.ba.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(i.targetId),n.sharedClientState.isActiveQueryTarget(i.targetId)||(yield Yn(n.localStore,i.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(i.targetId),e&&Xn(n.remoteStore,i.targetId),tr(n,i.targetId)}).catch(je))):(tr(n,i.targetId),yield Yn(n.localStore,i.targetId,!0))})}function u_(r,t){return C(this,null,function*(){let e=O(r),n=e.ba.get(t),i=e.Da.get(n.targetId);e.isPrimaryClient&&i.length===1&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),Xn(e.remoteStore,n.targetId))})}function c_(r,t,e){return C(this,null,function*(){let n=Sc(r);try{let i=yield function(a,u){let l=O(a),d=at.now(),f=u.reduce((S,N)=>S.add(N.key),$()),g,y;return l.persistence.runTransaction("Locally write mutations","readwrite",S=>{let N=Ot(),k=$();return l.os.getEntries(S,f).next(D=>{N=D,N.forEach((G,j)=>{j.isValidDocument()||(k=k.add(G))})}).next(()=>l.localDocuments.getOverlayedDocuments(S,N)).next(D=>{g=D;let G=[];for(let j of u){let U=Tp(j,g.get(j.key).overlayedDocument);U!=null&&G.push(new Ht(j.key,U,Wd(U.value.mapValue),ht.exists(!0)))}return l.mutationQueue.addMutationBatch(S,d,G,u)}).next(D=>{y=D;let G=D.applyToLocalDocumentSet(g,k);return l.documentOverlayCache.saveOverlays(S,D.batchId,G)})}).then(()=>({batchId:y.batchId,changes:of(g)}))}(n.localStore,t);n.sharedClientState.addPendingMutation(i.batchId),function(a,u,l){let d=a.xa[a.currentUser.toKey()];d||(d=new st(K)),d=d.insert(u,l),a.xa[a.currentUser.toKey()]=d}(n,i.batchId,e),yield ve(n,i.changes),yield ar(n.remoteStore)}catch(i){let s=cr(i,"Failed to persist write");e.reject(s)}})}function tm(r,t){return C(this,null,function*(){let e=O(r);try{let n=yield Gp(e.localStore,t);t.targetChanges.forEach((i,s)=>{let a=e.Fa.get(s);a&&(q(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?a.wa=!0:i.modifiedDocuments.size>0?q(a.wa):i.removedDocuments.size>0&&(q(a.wa),a.wa=!1))}),yield ve(e,n,t)}catch(n){yield je(n)}})}function Ad(r,t,e){let n=O(r);if(n.isPrimaryClient&&e===0||!n.isPrimaryClient&&e===1){let i=[];n.ba.forEach((s,a)=>{let u=a.view.j_(t);u.snapshot&&i.push(u.snapshot)}),function(a,u){let l=O(a);l.onlineState=u;let d=!1;l.queries.forEach((f,g)=>{for(let y of g.U_)y.j_(u)&&(d=!0)}),d&&vc(l)}(n.eventManager,t),i.length&&n.Sa.h_(i),n.onlineState=t,n.isPrimaryClient&&n.sharedClientState.setOnlineState(t)}}function l_(r,t,e){return C(this,null,function*(){let n=O(r);n.sharedClientState.updateQueryState(t,"rejected",e);let i=n.Fa.get(t),s=i&&i.key;if(s){let a=new st(M.comparator);a=a.insert(s,wt.newNoDocument(s,B.min()));let u=$().add(s),l=new ri(B.min(),new Map,new st(K),a,u);yield tm(n,l),n.va=n.va.remove(s),n.Fa.delete(t),Ac(n)}else yield Yn(n.localStore,t,!1).then(()=>tr(n,t,e)).catch(je)})}function h_(r,t){return C(this,null,function*(){let e=O(r),n=t.batch.batchId;try{let i=yield Bp(e.localStore,t);Tc(e,n,null),Ec(e,n),e.sharedClientState.updateMutationState(n,"acknowledged"),yield ve(e,i)}catch(i){yield je(i)}})}function d_(r,t,e){return C(this,null,function*(){let n=O(r);try{let i=yield function(a,u){let l=O(a);return l.persistence.runTransaction("Reject batch","readwrite-primary",d=>{let f;return l.mutationQueue.lookupMutationBatch(d,u).next(g=>(q(g!==null),f=g.keys(),l.mutationQueue.removeMutationBatch(d,g))).next(()=>l.mutationQueue.performConsistencyCheck(d)).next(()=>l.documentOverlayCache.removeOverlaysForBatchId(d,f,u)).next(()=>l.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(d,f)).next(()=>l.localDocuments.getDocuments(d,f))})}(n.localStore,t);Tc(n,t,e),Ec(n,t),n.sharedClientState.updateMutationState(t,"rejected",e),yield ve(n,i)}catch(i){yield je(i)}})}function f_(r,t){return C(this,null,function*(){let e=O(r);Ke(e.remoteStore)||V("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let n=yield function(a){let u=O(a);return u.persistence.runTransaction("Get highest unacknowledged batch id","readonly",l=>u.mutationQueue.getHighestUnacknowledgedBatchId(l))}(e.localStore);if(n===-1)return void t.resolve();let i=e.Oa.get(n)||[];i.push(t),e.Oa.set(n,i)}catch(n){let i=cr(n,"Initialization of waitForPendingWrites() operation failed");t.reject(i)}})}function Ec(r,t){(r.Oa.get(t)||[]).forEach(e=>{e.resolve()}),r.Oa.delete(t)}function Tc(r,t,e){let n=O(r),i=n.xa[n.currentUser.toKey()];if(i){let s=i.get(t);s&&(e?s.reject(e):s.resolve(),i=i.remove(t)),n.xa[n.currentUser.toKey()]=i}}function tr(r,t,e=null){r.sharedClientState.removeLocalQueryTarget(t);for(let n of r.Da.get(t))r.ba.delete(n),e&&r.Sa.ka(n,e);r.Da.delete(t),r.isPrimaryClient&&r.Ma.Vr(t).forEach(n=>{r.Ma.containsKey(n)||em(r,n)})}function em(r,t){r.Ca.delete(t.path.canonicalString());let e=r.va.get(t);e!==null&&(Xn(r.remoteStore,e),r.va=r.va.remove(t),r.Fa.delete(e),Ac(r))}function Mu(r,t,e){for(let n of e)n instanceof Bs?(r.Ma.addReference(n.key,t),m_(r,n)):n instanceof Gs?(V("SyncEngine","Document no longer in limbo: "+n.key),r.Ma.removeReference(n.key,t),r.Ma.containsKey(n.key)||em(r,n.key)):L()}function m_(r,t){let e=t.key,n=e.path.canonicalString();r.va.get(e)||r.Ca.has(n)||(V("SyncEngine","New document in limbo: "+e),r.Ca.add(n),Ac(r))}function Ac(r){for(;r.Ca.size>0&&r.va.size<r.maxConcurrentLimboResolutions;){let t=r.Ca.values().next().value;r.Ca.delete(t);let e=new M(Y.fromString(t)),n=r.Na.next();r.Fa.set(n,new ku(e)),r.va=r.va.insert(e,n),eo(r.remoteStore,new Wn(Ft(sr(e.path)),n,"TargetPurposeLimboResolution",qt.oe))}}function ve(r,t,e){return C(this,null,function*(){let n=O(r),i=[],s=[],a=[];n.ba.isEmpty()||(n.ba.forEach((u,l)=>{a.push(n.Ba(l,t,e).then(d=>{if((d||e)&&n.isPrimaryClient&&n.sharedClientState.updateQueryState(l.targetId,d?.fromCache?"not-current":"current"),d){i.push(d);let f=mu.Ki(l.targetId,d);s.push(f)}}))}),yield Promise.all(a),n.Sa.h_(i),yield function(l,d){return C(this,null,function*(){let f=O(l);try{yield f.persistence.runTransaction("notifyLocalViewChanges","readwrite",g=>b.forEach(d,y=>b.forEach(y.qi,S=>f.persistence.referenceDelegate.addReference(g,y.targetId,S)).next(()=>b.forEach(y.Qi,S=>f.persistence.referenceDelegate.removeReference(g,y.targetId,S)))))}catch(g){if(!ze(g))throw g;V("LocalStore","Failed to update sequence numbers: "+g)}for(let g of d){let y=g.targetId;if(!g.fromCache){let S=f.ns.get(y),N=S.snapshotVersion,k=S.withLastLimboFreeSnapshotVersion(N);f.ns=f.ns.insert(y,k)}}})}(n.localStore,s))})}function g_(r,t){return C(this,null,function*(){let e=O(r);if(!e.currentUser.isEqual(t)){V("SyncEngine","User change. New user:",t.toKey());let n=yield Uf(e.localStore,t);e.currentUser=t,function(s,a){s.Oa.forEach(u=>{u.forEach(l=>{l.reject(new x(P.CANCELLED,a))})}),s.Oa.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),yield ve(e,n.us)}})}function p_(r,t){let e=O(r),n=e.Fa.get(t);if(n&&n.wa)return $().add(n.key);{let i=$(),s=e.Da.get(t);if(!s)return i;for(let a of s){let u=e.ba.get(a);i=i.unionWith(u.view.Ea)}return i}}function __(r,t){return C(this,null,function*(){let e=O(r),n=yield Vs(e.localStore,t.query,!0),i=t.view.pa(n);return e.isPrimaryClient&&Mu(e,t.targetId,i.fa),i})}function y_(r,t){return C(this,null,function*(){let e=O(r);return zf(e.localStore,t).then(n=>ve(e,n))})}function w_(r,t,e,n){return C(this,null,function*(){let i=O(r),s=yield function(u,l){let d=O(u),f=O(d.mutationQueue);return d.persistence.runTransaction("Lookup mutation documents","readonly",g=>f.vn(g,l).next(y=>y?d.localDocuments.getDocuments(g,y):b.resolve(null)))}(i.localStore,t);s!==null?(e==="pending"?yield ar(i.remoteStore):e==="acknowledged"||e==="rejected"?(Tc(i,t,n||null),Ec(i,t),function(u,l){O(O(u).mutationQueue).Mn(l)}(i.localStore,t)):L(),yield ve(i,s)):V("SyncEngine","Cannot apply mutation batch with id: "+t)})}function v_(r,t){return C(this,null,function*(){let e=O(r);if(no(e),Sc(e),t===!0&&e.La!==!0){let n=e.sharedClientState.getAllActiveQueryTargets(),i=yield Sd(e,n.toArray());e.La=!0,yield bu(e.remoteStore,!0);for(let s of i)eo(e.remoteStore,s)}else if(t===!1&&e.La!==!1){let n=[],i=Promise.resolve();e.Da.forEach((s,a)=>{e.sharedClientState.isLocalQueryTarget(a)?n.push(a):i=i.then(()=>(tr(e,a),Yn(e.localStore,a,!0))),Xn(e.remoteStore,a)}),yield i,yield Sd(e,n),function(a){let u=O(a);u.Fa.forEach((l,d)=>{Xn(u.remoteStore,d)}),u.Ma.mr(),u.Fa=new Map,u.va=new st(M.comparator)}(e),e.La=!1,yield bu(e.remoteStore,!1)}})}function Sd(r,t,e){return C(this,null,function*(){let n=O(r),i=[],s=[];for(let a of t){let u,l=n.Da.get(a);if(l&&l.length!==0){u=yield Jn(n.localStore,Ft(l[0]));for(let d of l){let f=n.ba.get(d),g=yield __(n,f);g.snapshot&&s.push(g.snapshot)}}else{let d=yield jf(n.localStore,a);u=yield Jn(n.localStore,d),yield Ic(n,nm(d),a,!1,u.resumeToken)}i.push(u)}return n.Sa.h_(s),i})}function nm(r){return tf(r.path,r.collectionGroup,r.orderBy,r.filters,r.limit,"F",r.startAt,r.endAt)}function I_(r){return function(e){return O(O(e).persistence).Bi()}(O(r).localStore)}function E_(r,t,e,n){return C(this,null,function*(){let i=O(r);if(i.La)return void V("SyncEngine","Ignoring unexpected query state notification.");let s=i.Da.get(t);if(s&&s.length>0)switch(e){case"current":case"not-current":{let a=yield zf(i.localStore,nf(s[0])),u=ri.createSynthesizedRemoteEventForCurrentChange(t,e==="current",Et.EMPTY_BYTE_STRING);yield ve(i,a,u);break}case"rejected":yield Yn(i.localStore,t,!0),tr(i,t,n);break;default:L()}})}function T_(r,t,e){return C(this,null,function*(){let n=no(r);if(n.La){for(let i of t){if(n.Da.has(i)&&n.sharedClientState.isActiveQueryTarget(i)){V("SyncEngine","Adding an already active target "+i);continue}let s=yield jf(n.localStore,i),a=yield Jn(n.localStore,s);yield Ic(n,nm(s),a.targetId,!1,a.resumeToken),eo(n.remoteStore,a)}for(let i of e)n.Da.has(i)&&(yield Yn(n.localStore,i,!1).then(()=>{Xn(n.remoteStore,i),tr(n,i)}).catch(je))}})}function no(r){let t=O(r);return t.remoteStore.remoteSyncer.applyRemoteEvent=tm.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=p_.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=l_.bind(null,t),t.Sa.h_=r_.bind(null,t.eventManager),t.Sa.ka=i_.bind(null,t.eventManager),t}function Sc(r){let t=O(r);return t.remoteStore.remoteSyncer.applySuccessfulWrite=h_.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=d_.bind(null,t),t}function A_(r,t,e){let n=O(r);(function(s,a,u){return C(this,null,function*(){try{let l=yield a.getMetadata();if(yield function(S,N){let k=O(S),D=mt(N.createTime);return k.persistence.runTransaction("hasNewerBundle","readonly",G=>k.$r.getBundleMetadata(G,N.id)).then(G=>!!G&&G.createTime.compareTo(D)>=0)}(s.localStore,l))return yield a.close(),u._completeWith(function(S){return{taskState:"Success",documentsLoaded:S.totalDocuments,bytesLoaded:S.totalBytes,totalDocuments:S.totalDocuments,totalBytes:S.totalBytes}}(l)),Promise.resolve(new Set);u._updateProgress(Xf(l));let d=new Du(l,s.localStore,a.serializer),f=yield a.qa();for(;f;){let y=yield d._a(f);y&&u._updateProgress(y),f=yield a.qa()}let g=yield d.complete();return yield ve(s,g.ca,void 0),yield function(S,N){let k=O(S);return k.persistence.runTransaction("Save bundle","readwrite",D=>k.$r.saveBundleMetadata(D,N))}(s.localStore,l),u._completeWith(g.progress),Promise.resolve(g.ua)}catch(l){return jt("SyncEngine",`Loading bundle failed with ${l}`),u._failWith(l),Promise.resolve(new Set)}})})(n,t,e).then(i=>{n.sharedClientState.notifyBundleLoaded(i)})}var di=class{constructor(){this.synchronizeTabs=!1}initialize(t){return C(this,null,function*(){this.serializer=vi(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),yield this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)})}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return qf(this.persistence,new xs,t.initialUser,this.serializer)}createPersistence(t){return new Ps(Cs.Hr,this.serializer)}createSharedClientState(t){return new ks}terminate(){return C(this,null,function*(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}};var zs=class r extends di{constructor(t,e,n){super(),this.Qa=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}initialize(t){return C(this,null,function*(){yield Go(r.prototype,this,"initialize").call(this,t),yield this.Qa.initialize(this,t),yield Sc(this.Qa.syncEngine),yield ar(this.Qa.remoteStore),yield this.persistence.fi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}createLocalStore(t){return qf(this.persistence,new xs,t.initialUser,this.serializer)}createGarbageCollectionScheduler(t,e){let n=this.persistence.referenceDelegate.garbageCollector;return new Za(n,t.asyncQueue,e)}createIndexBackfillerScheduler(t,e){let n=new _a(e,this.persistence);return new pa(t.asyncQueue,n)}createPersistence(t){let e=mc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=this.cacheSizeBytes!==void 0?Gt.withCacheSize(this.cacheSizeBytes):Gt.DEFAULT;return new fu(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,$f(),ns(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(t){return new ks}},Ou=class r extends zs{constructor(t,e){super(t,e,!1),this.Qa=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}initialize(t){return C(this,null,function*(){yield Go(r.prototype,this,"initialize").call(this,t);let e=this.Qa.syncEngine;this.sharedClientState instanceof Qr&&(this.sharedClientState.syncEngine={Zs:w_.bind(null,e),Xs:E_.bind(null,e),eo:T_.bind(null,e),Bi:I_.bind(null,e),Ys:y_.bind(null,e)},yield this.sharedClientState.start()),yield this.persistence.fi(n=>C(this,null,function*(){yield v_(this.Qa.syncEngine,n),this.gcScheduler&&(n&&!this.gcScheduler.started?this.gcScheduler.start():n||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(n&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():n||this.indexBackfillerScheduler.stop())}))})}createSharedClientState(t){let e=$f();if(!Qr.D(e))throw new x(P.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=mc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Qr(e,t.asyncQueue,n,t.clientId,t.initialUser)}},fi=class{initialize(t,e){return C(this,null,function*(){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=n=>Ad(this.syncEngine,n,1),this.remoteStore.remoteSyncer.handleCredentialChange=g_.bind(null,this.syncEngine),yield bu(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(t){return function(){return new Cu}()}createDatastore(t){let e=vi(t.databaseInfo.databaseId),n=function(s){return new vu(s)}(t.databaseInfo);return function(s,a,u,l){return new Tu(s,a,u,l)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return function(n,i,s,a,u){return new Su(n,i,s,a,u)}(this.localStore,this.datastore,t.asyncQueue,e=>Ad(this.syncEngine,e,0),function(){return Fs.D()?new Fs:new yu}())}createSyncEngine(t,e){return function(i,s,a,u,l,d,f){let g=new Fu(i,s,a,u,l,d);return f&&(g.La=!0),g}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return C(this,null,function*(){var t;yield function(n){return C(this,null,function*(){let i=O(n);V("RemoteStore","RemoteStore shutting down."),i.M_.add(5),yield or(i),i.O_.shutdown(),i.N_.set("Unknown")})}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate()})}};function bd(r,t=10240){let e=0;return{read(){return C(this,null,function*(){if(e<r.byteLength){let i={value:r.slice(e,e+t),done:!1};return e+=t,i}return{done:!0}})},cancel(){return C(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var er=class{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ka(this.observer.next,t)}error(t){this.observer.error?this.Ka(this.observer.error,t):dt("Uncaught Error in snapshot listener:",t.toString())}$a(){this.muted=!0}Ka(t,e){this.muted||setTimeout(()=>{this.muted||t(e)},0)}};var Lu=class{constructor(t,e){this.Ua=t,this.serializer=e,this.metadata=new yt,this.buffer=new Uint8Array,this.Wa=function(){return new TextDecoder("utf-8")}(),this.Ga().then(n=>{n&&n.sa()?this.metadata.resolve(n.ia.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(n?.ia)}`))},n=>this.metadata.reject(n))}close(){return this.Ua.cancel()}getMetadata(){return C(this,null,function*(){return this.metadata.promise})}qa(){return C(this,null,function*(){return yield this.getMetadata(),this.Ga()})}Ga(){return C(this,null,function*(){let t=yield this.za();if(t===null)return null;let e=this.Wa.decode(t),n=Number(e);isNaN(n)&&this.ja(`length string (${e}) is not valid number`);let i=yield this.Ha(n);return new Vu(JSON.parse(i),t.length+n)})}Ja(){return this.buffer.findIndex(t=>t===123)}za(){return C(this,null,function*(){for(;this.Ja()<0&&!(yield this.Ya()););if(this.buffer.length===0)return null;let t=this.Ja();t<0&&this.ja("Reached the end of bundle when a length string is expected.");let e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e})}Ha(t){return C(this,null,function*(){for(;this.buffer.length<t;)(yield this.Ya())&&this.ja("Reached the end of bundle when more is expected.");let e=this.Wa.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e})}ja(t){throw this.Ua.cancel(),new Error(`Invalid bundle format: ${t}`)}Ya(){return C(this,null,function*(){let t=yield this.Ua.read();if(!t.done){let e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done})}};var qu=class{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(t){return C(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new x(P.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let e=yield function(i,s){return C(this,null,function*(){let a=O(i),u={documents:s.map(g=>si(a.serializer,g))},l=yield a.xo("BatchGetDocuments",a.serializer.databaseId,Y.emptyPath(),u,s.length),d=new Map;l.forEach(g=>{let y=Cp(a.serializer,g);d.set(y.key.toString(),y)});let f=[];return s.forEach(g=>{let y=d.get(g.toString());q(!!y),f.push(y)}),f})}(this.datastore,t);return e.forEach(n=>this.recordVersion(n)),e})}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(n){this.lastTransactionError=n}this.writtenDocs.add(t.toString())}delete(t){this.write(new Be(t,this.precondition(t))),this.writtenDocs.add(t.toString())}commit(){return C(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,n)=>{let i=M.fromPath(n);this.mutations.push(new ti(i,this.precondition(i)))}),yield function(n,i){return C(this,null,function*(){let s=O(n),a={writes:i.map(u=>oi(s.serializer,u))};yield s.Co("Commit",s.serializer.databaseId,Y.emptyPath(),a)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw L();e=B.min()}let n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new x(P.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){let e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(B.min())?ht.exists(!1):ht.updateTime(e):ht.none()}preconditionForUpdate(t){let e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(B.min()))throw new x(P.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return ht.updateTime(e)}return ht.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}};var Uu=class{constructor(t,e,n,i,s){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=i,this.deferred=s,this.Za=n.maxAttempts,this.Yo=new li(this.asyncQueue,"transaction_retry")}Xa(){this.Za-=1,this.eu()}eu(){this.Yo.$o(()=>C(this,null,function*(){let t=new qu(this.datastore),e=this.tu(t);e&&e.then(n=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(n)}).catch(i=>{this.nu(i)}))}).catch(n=>{this.nu(n)})}))}tu(t){try{let e=this.updateFunction(t);return!pi(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}nu(t){this.Za>0&&this.ru(t)?(this.Za-=1,this.asyncQueue.enqueueAndForget(()=>(this.eu(),Promise.resolve()))):this.deferred.reject(t)}ru(t){if(t.name==="FirebaseError"){let e=t.code;return e==="aborted"||e==="failed-precondition"||e==="already-exists"||!_f(e)}return!1}};var Bu=class{constructor(t,e,n,i){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=i,this.user=_t.UNAUTHENTICATED,this.clientId=ss.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,s=>C(this,null,function*(){V("FirestoreClient","Received user=",s.uid),yield this.authCredentialListener(s),this.user=s})),this.appCheckCredentials.start(n,s=>(V("FirestoreClient","Received new app check token=",s),this.appCheckCredentialListener(s,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new x(P.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();let t=new yt;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>C(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){let n=cr(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}};function rs(r,t){return C(this,null,function*(){r.asyncQueue.verifyOperationInProgress(),V("FirestoreClient","Initializing OfflineComponentProvider");let e=r.configuration;yield t.initialize(e);let n=e.initialUser;r.setCredentialChangeListener(i=>C(this,null,function*(){n.isEqual(i)||(yield Uf(t.localStore,i),n=i)})),t.persistence.setDatabaseDeletedListener(()=>r.terminate()),r._offlineComponents=t})}function Gu(r,t){return C(this,null,function*(){r.asyncQueue.verifyOperationInProgress();let e=yield bc(r);V("FirestoreClient","Initializing OnlineComponentProvider"),yield t.initialize(e,r.configuration),r.setCredentialChangeListener(n=>Ed(t.remoteStore,n)),r.setAppCheckTokenChangeListener((n,i)=>Ed(t.remoteStore,i)),r._onlineComponents=t})}function rm(r){return r.name==="FirebaseError"?r.code===P.FAILED_PRECONDITION||r.code===P.UNIMPLEMENTED:!(typeof DOMException<"u"&&r instanceof DOMException)||r.code===22||r.code===20||r.code===11}function bc(r){return C(this,null,function*(){if(!r._offlineComponents)if(r._uninitializedComponentsProvider){V("FirestoreClient","Using user provided OfflineComponentProvider");try{yield rs(r,r._uninitializedComponentsProvider._offline)}catch(t){let e=t;if(!rm(e))throw e;jt("Error using user provided cache. Falling back to memory cache: "+e),yield rs(r,new di)}}else V("FirestoreClient","Using default OfflineComponentProvider"),yield rs(r,new di);return r._offlineComponents})}function ro(r){return C(this,null,function*(){return r._onlineComponents||(r._uninitializedComponentsProvider?(V("FirestoreClient","Using user provided OnlineComponentProvider"),yield Gu(r,r._uninitializedComponentsProvider._online)):(V("FirestoreClient","Using default OnlineComponentProvider"),yield Gu(r,new fi))),r._onlineComponents})}function im(r){return bc(r).then(t=>t.persistence)}function Rc(r){return bc(r).then(t=>t.localStore)}function sm(r){return ro(r).then(t=>t.remoteStore)}function Pc(r){return ro(r).then(t=>t.syncEngine)}function S_(r){return ro(r).then(t=>t.datastore)}function nr(r){return C(this,null,function*(){let t=yield ro(r),e=t.eventManager;return e.onListen=s_.bind(null,t.syncEngine),e.onUnlisten=a_.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=o_.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=u_.bind(null,t.syncEngine),e})}function b_(r){return r.asyncQueue.enqueue(()=>C(this,null,function*(){let t=yield im(r),e=yield sm(r);return t.setNetworkEnabled(!0),function(i){let s=O(i);return s.M_.delete(0),Ii(s)}(e)}))}function R_(r){return r.asyncQueue.enqueue(()=>C(this,null,function*(){let t=yield im(r),e=yield sm(r);return t.setNetworkEnabled(!1),function(i){return C(this,null,function*(){let s=O(i);s.M_.add(0),yield or(s),s.N_.set("Offline")})}(e)}))}function P_(r,t){let e=new yt;return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(i,s,a){return C(this,null,function*(){try{let u=yield function(d,f){let g=O(d);return g.persistence.runTransaction("read document","readonly",y=>g.localDocuments.getDocument(y,f))}(i,s);u.isFoundDocument()?a.resolve(u):u.isNoDocument()?a.resolve(null):a.reject(new x(P.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(u){let l=cr(u,`Failed to get document '${s} from cache`);a.reject(l)}})}(yield Rc(r),t,e)})),e.promise}function om(r,t,e={}){let n=new yt;return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(s,a,u,l,d){let f=new er({next:y=>{a.enqueueAndForget(()=>wc(s,g));let S=y.docs.has(u);!S&&y.fromCache?d.reject(new x(P.UNAVAILABLE,"Failed to get document because the client is offline.")):S&&y.fromCache&&l&&l.source==="server"?d.reject(new x(P.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):d.resolve(y)},error:y=>d.reject(y)}),g=new hi(sr(u.path),f,{includeMetadataChanges:!0,ra:!0});return yc(s,g)}(yield nr(r),r.asyncQueue,t,e,n)})),n.promise}function C_(r,t){let e=new yt;return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(i,s,a){return C(this,null,function*(){try{let u=yield Vs(i,s,!0),l=new js(s,u.hs),d=l.da(u.documents),f=l.applyChanges(d,!1);a.resolve(f.snapshot)}catch(u){let l=cr(u,`Failed to execute query '${s} against cache`);a.reject(l)}})}(yield Rc(r),t,e)})),e.promise}function am(r,t,e={}){let n=new yt;return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(s,a,u,l,d){let f=new er({next:y=>{a.enqueueAndForget(()=>wc(s,g)),y.fromCache&&l.source==="server"?d.reject(new x(P.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):d.resolve(y)},error:y=>d.reject(y)}),g=new hi(u,f,{includeMetadataChanges:!0,ra:!0});return yc(s,g)}(yield nr(r),r.asyncQueue,t,e,n)})),n.promise}function x_(r,t){let e=new er(t);return r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(i,s){O(i).z_.add(s),s.next()}(yield nr(r),e)})),()=>{e.$a(),r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return function(i,s){O(i).z_.delete(s)}(yield nr(r),e)}))}}function V_(r,t,e,n){let i=function(a,u){let l;return l=typeof a=="string"?wf().encode(a):a,function(f,g){return new Lu(f,g)}(function(f,g){if(f instanceof Uint8Array)return bd(f,g);if(f instanceof ArrayBuffer)return bd(new Uint8Array(f),g);if(f instanceof ReadableStream)return f.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(l),u)}(e,vi(t));r.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){A_(yield Pc(r),i,n)}))}function D_(r,t){return r.asyncQueue.enqueue(()=>C(this,null,function*(){return function(n,i){let s=O(n);return s.persistence.runTransaction("Get named query","readonly",a=>s.$r.getNamedQuery(a,i))}(yield Rc(r),t)}))}function um(r){let t={};return r.timeoutSeconds!==void 0&&(t.timeoutSeconds=r.timeoutSeconds),t}var Rd=new Map;function Cc(r,t,e){if(!e)throw new x(P.INVALID_ARGUMENT,`Function ${r}() cannot be called with an empty ${t}.`)}function xc(r,t,e,n){if(t===!0&&n===!0)throw new x(P.INVALID_ARGUMENT,`${r} and ${e} cannot be used together.`)}function Pd(r){if(!M.isDocumentKey(r))throw new x(P.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${r} has ${r.length}.`)}function Cd(r){if(M.isDocumentKey(r))throw new x(P.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${r} has ${r.length}.`)}function io(r){if(r===void 0)return"undefined";if(r===null)return"null";if(typeof r=="string")return r.length>20&&(r=`${r.substring(0,20)}...`),JSON.stringify(r);if(typeof r=="number"||typeof r=="boolean")return""+r;if(typeof r=="object"){if(r instanceof Array)return"an array";{let t=function(n){return n.constructor?n.constructor.name:null}(r);return t?`a custom ${t} object`:"an object"}}return typeof r=="function"?"a function":L()}function X(r,t){if("_delegate"in r&&(r=r._delegate),!(r instanceof t)){if(t.name===r.constructor.name)throw new x(P.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let e=io(r);throw new x(P.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return r}function cm(r,t){if(t<=0)throw new x(P.INVALID_ARGUMENT,`Function ${r}() requires a positive number, but it was: ${t}.`)}var Ks=class{constructor(t){var e,n;if(t.host===void 0){if(t.ssl!==void 0)throw new x(P.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=(e=t.ssl)===null||e===void 0||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<1048576)throw new x(P.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}xc("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=um((n=t.experimentalLongPollingOptions)!==null&&n!==void 0?n:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new x(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new x(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new x(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(n,i){return n.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}},dn=class{constructor(t,e,n,i){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Ks({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new x(P.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!==void 0}_setSettings(t){if(this._settingsFrozen)throw new x(P.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Ks(t),t.credentials!==void 0&&(this._authCredentials=function(n){if(!n)return new oa;switch(n.type){case"firstParty":return new la(n.sessionIndex||"0",n.iamToken||null,n.authTokenFactory||null);case"provider":return n.client;default:throw new x(P.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let n=Rd.get(e);n&&(V("ComponentProvider","Removing Datastore"),Rd.delete(e),n.terminate())}(this),Promise.resolve()}};function Vc(r,t,e,n={}){var i;let s=(r=X(r,dn))._getSettings(),a=`${t}:${e}`;if(s.host!=="firestore.googleapis.com"&&s.host!==a&&jt("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),r._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),n.mockUserToken){let u,l;if(typeof n.mockUserToken=="string")u=n.mockUserToken,l=_t.MOCK_USER;else{u=uh(n.mockUserToken,(i=r._app)===null||i===void 0?void 0:i.options.projectId);let d=n.mockUserToken.sub||n.mockUserToken.user_id;if(!d)throw new x(P.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");l=new _t(d)}r._authCredentials=new aa(new is(u,l))}}var St=class r{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new r(this.firestore,t,this._query)}},rt=class r{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new re(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new r(this.firestore,t,this._key)}},re=class r extends St{constructor(t,e,n){super(t,e,sr(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let t=this._path.popLast();return t.isEmpty()?null:new rt(this.firestore,null,new M(t))}withConverter(t){return new r(this.firestore,t,this._path)}};function Dc(r,t,...e){if(r=ct(r),Cc("collection","path",t),r instanceof dn){let n=Y.fromString(t,...e);return Cd(n),new re(r,null,n)}{if(!(r instanceof rt||r instanceof re))throw new x(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let n=r._path.child(Y.fromString(t,...e));return Cd(n),new re(r.firestore,null,n)}}function lm(r,t){if(r=X(r,dn),Cc("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new x(P.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new St(r,null,function(n){return new Wt(Y.emptyPath(),n)}(t))}function Ei(r,t,...e){if(r=ct(r),arguments.length===1&&(t=ss.newId()),Cc("doc","path",t),r instanceof dn){let n=Y.fromString(t,...e);return Pd(n),new rt(r,null,new M(n))}{if(!(r instanceof rt||r instanceof re))throw new x(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let n=r._path.child(Y.fromString(t,...e));return Pd(n),new rt(r.firestore,r instanceof re?r.converter:null,new M(n))}}function Nc(r,t){return r=ct(r),t=ct(t),(r instanceof rt||r instanceof re)&&(t instanceof rt||t instanceof re)&&r.firestore===t.firestore&&r.path===t.path&&r.converter===t.converter}function kc(r,t){return r=ct(r),t=ct(t),r instanceof St&&t instanceof St&&r.firestore===t.firestore&&yi(r._query,t._query)&&r.converter===t.converter}var ju=class{constructor(){this.iu=Promise.resolve(),this.su=[],this.ou=!1,this._u=[],this.au=null,this.uu=!1,this.cu=!1,this.lu=[],this.Yo=new li(this,"async_queue_retry"),this.hu=()=>{let e=ns();e&&V("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Yo.Wo()};let t=ns();t&&typeof t.addEventListener=="function"&&t.addEventListener("visibilitychange",this.hu)}get isShuttingDown(){return this.ou}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Pu(),this.Iu(t)}enterRestrictedMode(t){if(!this.ou){this.ou=!0,this.cu=t||!1;let e=ns();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.hu)}}enqueue(t){if(this.Pu(),this.ou)return new Promise(()=>{});let e=new yt;return this.Iu(()=>this.ou&&this.cu?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.su.push(t),this.Tu()))}Tu(){return C(this,null,function*(){if(this.su.length!==0){try{yield this.su[0](),this.su.shift(),this.Yo.reset()}catch(t){if(!ze(t))throw t;V("AsyncQueue","Operation failed with retryable error: "+t)}this.su.length>0&&this.Yo.$o(()=>this.Tu())}})}Iu(t){let e=this.iu.then(()=>(this.uu=!0,t().catch(n=>{this.au=n,this.uu=!1;let i=function(a){let u=a.message||"";return a.stack&&(u=a.stack.includes(a.message)?a.stack:a.message+`
`+a.stack),u}(n);throw dt("INTERNAL UNHANDLED ERROR: ",i),n}).then(n=>(this.uu=!1,n))));return this.iu=e,e}enqueueAfterDelay(t,e,n){this.Pu(),this.lu.indexOf(t)>-1&&(e=0);let i=Ru.createAndSchedule(this,t,e,n,s=>this.Eu(s));return this._u.push(i),i}Pu(){this.au&&L()}verifyOperationInProgress(){}du(){return C(this,null,function*(){let t;do t=this.iu,yield t;while(t!==this.iu)})}Au(t){for(let e of this._u)if(e.timerId===t)return!0;return!1}Ru(t){return this.du().then(()=>{this._u.sort((e,n)=>e.targetTimeMs-n.targetTimeMs);for(let e of this._u)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.du()})}Vu(t){this.lu.push(t)}Eu(t){let e=this._u.indexOf(t);this._u.splice(e,1)}};function zu(r){return function(e,n){if(typeof e!="object"||e===null)return!1;let i=e;for(let s of n)if(s in i&&typeof i[s]=="function")return!0;return!1}(r,["next","error","complete"])}var Ku=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new yt,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}};var hm=-1,ot=class extends dn{constructor(t,e,n,i){super(t,e,n,i),this.type="firestore",this._queue=function(){return new ju}(),this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return this._firestoreClient||dm(this),this._firestoreClient.terminate()}};function dy(r,t){let e=typeof r=="object"?r:gh(),n=typeof r=="string"?r:t||"(default)",i=fh(e,"firestore").getImmediate({identifier:n});if(!i._initialized){let s=ah("firestore");s&&Vc(i,...s)}return i}function vt(r){return r._firestoreClient||dm(r),r._firestoreClient.verifyNotTerminated(),r._firestoreClient}function dm(r){var t,e,n;let i=r._freezeSettings(),s=function(u,l,d,f){return new ya(u,l,d,f.host,f.ssl,f.experimentalForceLongPolling,f.experimentalAutoDetectLongPolling,um(f.experimentalLongPollingOptions),f.useFetchStreams)}(r._databaseId,((t=r._app)===null||t===void 0?void 0:t.options.appId)||"",r._persistenceKey,i);r._firestoreClient=new Bu(r._authCredentials,r._appCheckCredentials,r._queue,s),!((e=i.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((n=i.localCache)===null||n===void 0)&&n._onlineComponentProvider)&&(r._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function fm(r,t){Em(r=X(r,ot));let e=vt(r);if(e._uninitializedComponentsProvider)throw new x(P.FAILED_PRECONDITION,"SDK cache is already specified.");jt("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let n=r._freezeSettings(),i=new fi;return gm(e,i,new zs(i,n.cacheSizeBytes,t?.forceOwnership))}function mm(r){Em(r=X(r,ot));let t=vt(r);if(t._uninitializedComponentsProvider)throw new x(P.FAILED_PRECONDITION,"SDK cache is already specified.");jt("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let e=r._freezeSettings(),n=new fi;return gm(t,n,new Ou(n,e.cacheSizeBytes))}function gm(r,t,e){let n=new yt;return r.asyncQueue.enqueue(()=>C(this,null,function*(){try{yield rs(r,e),yield Gu(r,t),n.resolve()}catch(i){let s=i;if(!rm(s))throw s;jt("Error enabling indexeddb cache. Falling back to memory cache: "+s),n.reject(s)}})).then(()=>n.promise)}function pm(r){if(r._initialized&&!r._terminated)throw new x(P.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let t=new yt;return r._queue.enqueueAndForgetEvenWhileRestricted(()=>C(this,null,function*(){try{yield function(n){return C(this,null,function*(){if(!ke.D())return Promise.resolve();let i=n+"main";yield ke.delete(i)})}(mc(r._databaseId,r._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function _m(r){return function(e){let n=new yt;return e.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return f_(yield Pc(e),n)})),n.promise}(vt(r=X(r,ot)))}function ym(r){return b_(vt(r=X(r,ot)))}function wm(r){return R_(vt(r=X(r,ot)))}function vm(r,t){let e=vt(r=X(r,ot)),n=new Ku;return V_(e,r._databaseId,t,n),n}function Im(r,t){return D_(vt(r=X(r,ot)),t).then(e=>e?new St(r,null,e.query):null)}function Em(r){if(r._initialized||r._terminated)throw new x(P.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var ae=class r{constructor(t){this._byteString=t}static fromBase64String(t){try{return new r(Et.fromBase64String(t))}catch(e){throw new x(P.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new r(Et.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}};var Jt=class{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new x(P.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ft(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}};var ye=class{constructor(t){this._methodName=t}};var fn=class{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new x(P.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new x(P.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return K(this._lat,t._lat)||K(this._long,t._long)}};var N_=/^__.*__$/,$u=class{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return this.fieldMask!==null?new Ht(t,this.data,this.fieldMask,e,this.fieldTransforms):new Ue(t,this.data,e,this.fieldTransforms)}},$s=class{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Ht(t,this.data,this.fieldMask,e,this.fieldTransforms)}};function Tm(r){switch(r){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw L()}}var Qs=class r{constructor(t,e,n,i,s,a){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=i,s===void 0&&this.mu(),this.fieldTransforms=s||[],this.fieldMask=a||[]}get path(){return this.settings.path}get fu(){return this.settings.fu}gu(t){return new r(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}pu(t){var e;let n=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.gu({path:n,yu:!1});return i.wu(t),i}Su(t){var e;let n=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.gu({path:n,yu:!1});return i.mu(),i}bu(t){return this.gu({path:void 0,yu:!0})}Du(t){return Ws(t,this.settings.methodName,this.settings.Cu||!1,this.path,this.settings.vu)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}mu(){if(this.path)for(let t=0;t<this.path.length;t++)this.wu(this.path.get(t))}wu(t){if(t.length===0)throw this.Du("Document fields must not be empty");if(Tm(this.fu)&&N_.test(t))throw this.Du('Document fields cannot begin and end with "__"')}},Qu=class{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||vi(t)}Fu(t,e,n,i=!1){return new Qs({fu:t,methodName:e,vu:n,path:ft.emptyPath(),yu:!1,Cu:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function _n(r){let t=r._freezeSettings(),e=vi(r._databaseId);return new Qu(r._databaseId,!!t.ignoreUndefinedProperties,e)}function so(r,t,e,n,i,s={}){let a=r.Fu(s.merge||s.mergeFields?2:0,t,e,i);Oc("Data must be an object, but it was:",a,n);let u=bm(n,a),l,d;if(s.merge)l=new Ut(a.fieldMask),d=a.fieldTransforms;else if(s.mergeFields){let f=[];for(let g of s.mergeFields){let y=Xu(t,g,e);if(!a.contains(y))throw new x(P.INVALID_ARGUMENT,`Field '${y}' is specified in your field mask but missing from your input data.`);Pm(f,y)||f.push(y)}l=new Ut(f),d=a.fieldTransforms.filter(g=>l.covers(g.field))}else l=null,d=a.fieldTransforms;return new $u(new Vt(u),l,d)}var mi=class r extends ye{_toFieldTransform(t){if(t.fu!==2)throw t.fu===1?t.Du(`${this._methodName}() can only appear at the top level of your update data`):t.Du(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof r}};function Am(r,t,e){return new Qs({fu:3,vu:t.settings.vu,methodName:r._methodName,yu:e},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}var Wu=class r extends ye{_toFieldTransform(t){return new cn(t.path,new Le)}isEqual(t){return t instanceof r}},Hu=class r extends ye{constructor(t,e){super(t),this.Mu=e}_toFieldTransform(t){let e=Am(this,t,!0),n=this.Mu.map(s=>yn(s,e)),i=new pe(n);return new cn(t.path,i)}isEqual(t){return t instanceof r&&$o(this.Mu,t.Mu)}},Ju=class r extends ye{constructor(t,e){super(t),this.Mu=e}_toFieldTransform(t){let e=Am(this,t,!0),n=this.Mu.map(s=>yn(s,e)),i=new _e(n);return new cn(t.path,i)}isEqual(t){return t instanceof r&&$o(this.Mu,t.Mu)}},Yu=class r extends ye{constructor(t,e){super(t),this.xu=e}_toFieldTransform(t){let e=new qe(t.serializer,lf(t.serializer,this.xu));return new cn(t.path,e)}isEqual(t){return t instanceof r&&this.xu===t.xu}};function Fc(r,t,e,n){let i=r.Fu(1,t,e);Oc("Data must be an object, but it was:",i,n);let s=[],a=Vt.empty();pn(n,(l,d)=>{let f=Lc(t,l,e);d=ct(d);let g=i.Su(f);if(d instanceof mi)s.push(f);else{let y=yn(d,g);y!=null&&(s.push(f),a.set(f,y))}});let u=new Ut(s);return new $s(a,u,i.fieldTransforms)}function Mc(r,t,e,n,i,s){let a=r.Fu(1,t,e),u=[Xu(t,n,e)],l=[i];if(s.length%2!=0)throw new x(P.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let y=0;y<s.length;y+=2)u.push(Xu(t,s[y])),l.push(s[y+1]);let d=[],f=Vt.empty();for(let y=u.length-1;y>=0;--y)if(!Pm(d,u[y])){let S=u[y],N=l[y];N=ct(N);let k=a.Su(S);if(N instanceof mi)d.push(S);else{let D=yn(N,k);D!=null&&(d.push(S),f.set(S,D))}}let g=new Ut(d);return new $s(f,g,a.fieldTransforms)}function Sm(r,t,e,n=!1){return yn(e,r.Fu(n?4:3,t))}function yn(r,t){if(Rm(r=ct(r)))return Oc("Unsupported field value:",t,r),bm(r,t);if(r instanceof ye)return function(n,i){if(!Tm(i.fu))throw i.Du(`${n._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Du(`${n._methodName}() is not currently supported inside arrays`);let s=n._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(r,t),null;if(r===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),r instanceof Array){if(t.settings.yu&&t.fu!==4)throw t.Du("Nested arrays are not supported");return function(n,i){let s=[],a=0;for(let u of n){let l=yn(u,i.bu(a));l==null&&(l={nullValue:"NULL_VALUE"}),s.push(l),a++}return{arrayValue:{values:s}}}(r,t)}return function(n,i){if((n=ct(n))===null)return{nullValue:"NULL_VALUE"};if(typeof n=="number")return lf(i.serializer,n);if(typeof n=="boolean")return{booleanValue:n};if(typeof n=="string")return{stringValue:n};if(n instanceof Date){let s=at.fromDate(n);return{timestampValue:Qn(i.serializer,s)}}if(n instanceof at){let s=new at(n.seconds,1e3*Math.floor(n.nanoseconds/1e3));return{timestampValue:Qn(i.serializer,s)}}if(n instanceof fn)return{geoPointValue:{latitude:n.latitude,longitude:n.longitude}};if(n instanceof ae)return{bytesValue:vf(i.serializer,n._byteString)};if(n instanceof rt){let s=i.databaseId,a=n.firestore._databaseId;if(!a.isEqual(s))throw i.Du(`Document reference is for database ${a.projectId}/${a.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:hc(n.firestore._databaseId||i.databaseId,n._key.path)}}throw i.Du(`Unsupported field value: ${io(n)}`)}(r,t)}function bm(r,t){let e={};return Kd(r)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):pn(r,(n,i)=>{let s=yn(i,t.pu(n));s!=null&&(e[n]=s)}),{mapValue:{fields:e}}}function Rm(r){return!(typeof r!="object"||r===null||r instanceof Array||r instanceof Date||r instanceof at||r instanceof fn||r instanceof ae||r instanceof rt||r instanceof ye)}function Oc(r,t,e){if(!Rm(e)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(e)){let n=io(e);throw n==="an object"?t.Du(r+" a custom object"):t.Du(r+" "+n)}}function Xu(r,t,e){if((t=ct(t))instanceof Jt)return t._internalPath;if(typeof t=="string")return Lc(r,t);throw Ws("Field path arguments must be of type string or ",r,!1,void 0,e)}var k_=new RegExp("[~\\*/\\[\\]]");function Lc(r,t,e){if(t.search(k_)>=0)throw Ws(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,r,!1,void 0,e);try{return new Jt(...t.split("."))._internalPath}catch{throw Ws(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,r,!1,void 0,e)}}function Ws(r,t,e,n,i){let s=n&&!n.isEmpty(),a=i!==void 0,u=`Function ${t}() called with invalid data`;e&&(u+=" (via `toFirestore()`)"),u+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${n}`),a&&(l+=` in document ${i}`),l+=")"),new x(P.INVALID_ARGUMENT,u+r+l)}function Pm(r,t){return r.some(e=>e.isEqual(t))}var mn=class{constructor(t,e,n,i,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new rt(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let t=new Zu(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){let e=this._document.data.field(oo("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}},Zu=class extends mn{data(){return super.data()}};function oo(r,t){return typeof t=="string"?Lc(r,t):t instanceof Jt?t._internalPath:t._delegate._internalPath}function Cm(r){if(r.limitType==="L"&&r.explicitOrderBy.length===0)throw new x(P.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var gi=class{},gn=class extends gi{};function Ie(r,t,...e){let n=[];t instanceof gi&&n.push(t),n=n.concat(e),function(s){let a=s.filter(l=>l instanceof tc).length,u=s.filter(l=>l instanceof Hs).length;if(a>1||a>0&&u>0)throw new x(P.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(n);for(let i of n)r=i._apply(r);return r}var Hs=class r extends gn{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new r(t,e,n)}_apply(t){let e=this._parse(t);return qm(t._query,e),new St(t.firestore,t.converter,Va(t._query,e))}_parse(t){let e=_n(t.firestore);return function(s,a,u,l,d,f,g){let y;if(d.isKeyField()){if(f==="array-contains"||f==="array-contains-any")throw new x(P.INVALID_ARGUMENT,`Invalid Query. You can't perform '${f}' queries on documentId().`);if(f==="in"||f==="not-in"){Vd(g,f);let S=[];for(let N of g)S.push(xd(l,s,N));y={arrayValue:{values:S}}}else y=xd(l,s,g)}else f!=="in"&&f!=="not-in"&&f!=="array-contains-any"||Vd(g,f),y=Sm(u,a,g,f==="in"||f==="not-in");return W.create(d,f,y)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}};function xm(r,t,e){let n=t,i=oo("where",r);return Hs._create(i,n,e)}var tc=class r extends gi{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new r(t,e)}_parse(t){let e=this._queryConstraints.map(n=>n._parse(t)).filter(n=>n.getFilters().length>0);return e.length===1?e[0]:tt.create(e,this._getOperator())}_apply(t){let e=this._parse(t);return e.getFilters().length===0?t:(function(i,s){let a=i,u=s.getFlattenedFilters();for(let l of u)qm(a,l),a=Va(a,l)}(t._query,e),new St(t.firestore,t.converter,Va(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var ec=class r extends gn{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new r(t,e)}_apply(t){let e=function(i,s,a){if(i.startAt!==null)throw new x(P.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new x(P.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new an(s,a)}(t._query,this._field,this._direction);return new St(t.firestore,t.converter,function(i,s){let a=i.explicitOrderBy.concat([s]);return new Wt(i.path,i.collectionGroup,a,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(t._query,e))}};function Vm(r,t="asc"){let e=t,n=oo("orderBy",r);return ec._create(n,e)}var Js=class r extends gn{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new r(t,e,n)}_apply(t){return new St(t.firestore,t.converter,gs(t._query,this._limit,this._limitType))}};function Dm(r){return cm("limit",r),Js._create("limit",r,"F")}function Nm(r){return cm("limitToLast",r),Js._create("limitToLast",r,"L")}var Ys=class r extends gn{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new r(t,e,n)}_apply(t){let e=Lm(t,this.type,this._docOrFields,this._inclusive);return new St(t.firestore,t.converter,function(i,s){return new Wt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(t._query,e))}};function km(...r){return Ys._create("startAt",r,!0)}function Fm(...r){return Ys._create("startAfter",r,!1)}var Xs=class r extends gn{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new r(t,e,n)}_apply(t){let e=Lm(t,this.type,this._docOrFields,this._inclusive);return new St(t.firestore,t.converter,function(i,s){return new Wt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(t._query,e))}};function Mm(...r){return Xs._create("endBefore",r,!1)}function Om(...r){return Xs._create("endAt",r,!0)}function Lm(r,t,e,n){if(e[0]=ct(e[0]),e[0]instanceof mn)return function(s,a,u,l,d){if(!l)throw new x(P.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${u}().`);let f=[];for(let g of qn(s))if(g.field.isKeyField())f.push(on(a,l.key));else{let y=l.data.field(g.field);if(to(y))throw new x(P.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+g.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(y===null){let S=g.field.canonicalString();throw new x(P.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${S}' (used as the orderBy) does not exist.`)}f.push(y)}return new se(f,d)}(r._query,r.firestore._databaseId,t,e[0]._document,n);{let i=_n(r.firestore);return function(a,u,l,d,f,g){let y=a.explicitOrderBy;if(f.length>y.length)throw new x(P.INVALID_ARGUMENT,`Too many arguments provided to ${d}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let S=[];for(let N=0;N<f.length;N++){let k=f[N];if(y[N].field.isKeyField()){if(typeof k!="string")throw new x(P.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${d}(), but got a ${typeof k}`);if(!cc(a)&&k.indexOf("/")!==-1)throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${d}() must be a plain document ID, but '${k}' contains a slash.`);let D=a.path.child(Y.fromString(k));if(!M.isDocumentKey(D))throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${d}() must result in a valid document path, but '${D}' is not because it contains an odd number of segments.`);let G=new M(D);S.push(on(u,G))}else{let D=Sm(l,d,k);S.push(D)}}return new se(S,g)}(r._query,r.firestore._databaseId,i,t,e,n)}}function xd(r,t,e){if(typeof(e=ct(e))=="string"){if(e==="")throw new x(P.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!cc(t)&&e.indexOf("/")!==-1)throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);let n=t.path.child(Y.fromString(e));if(!M.isDocumentKey(n))throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${n}' is not because it has an odd number of segments (${n.length}).`);return on(r,new M(n))}if(e instanceof rt)return on(r,e._key);throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${io(e)}.`)}function Vd(r,t){if(!Array.isArray(r)||r.length===0)throw new x(P.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function qm(r,t){let e=function(i,s){for(let a of i)for(let u of a.getFlattenedFilters())if(s.indexOf(u.op)>=0)return u.op;return null}(r.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new x(P.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new x(P.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}var rr=class{convertValue(t,e="none"){switch(sn(t)){case 0:return null;case 1:return t.booleanValue;case 2:return lt(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Fe(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw L()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){let n={};return pn(t,(i,s)=>{n[i]=this.convertValue(s,e)}),n}convertGeoPoint(t){return new fn(lt(t.latitude),lt(t.longitude))}convertArray(t,e){return(t.values||[]).map(n=>this.convertValue(n,e))}convertServerTimestamp(t,e){switch(e){case"previous":let n=ac(t);return n==null?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(Yr(t));default:return null}}convertTimestamp(t){let e=ge(t);return new at(e.seconds,e.nanos)}convertDocumentKey(t,e){let n=Y.fromString(t);q(Vf(n));let i=new Me(n.get(1),n.get(3)),s=new M(n.popFirst(5));return i.isEqual(e)||dt(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}};function ao(r,t,e){let n;return n=r?e&&(e.merge||e.mergeFields)?r.toFirestore(t,e):r.toFirestore(t):t,n}var nc=class extends rr{constructor(t){super(),this.firestore=t}convertBytes(t){return new ae(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new rt(this.firestore,null,e)}};var me=class{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}},Kt=class extends mn{constructor(t,e,n,i,s,a){super(t,e,n,i,a),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){let e=new De(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){let n=this._document.data.field(oo("DocumentSnapshot.get",t));if(n!==null)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}},De=class extends Kt{data(t={}){return super.data(t)}},Yt=class{constructor(t,e,n,i){this._firestore=t,this._userDataWriter=e,this._snapshot=i,this.metadata=new me(i.hasPendingWrites,i.fromCache),this.query=n}get docs(){let t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(n=>{t.call(e,new De(this._firestore,this._userDataWriter,n.key,n,new me(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){let e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new x(P.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let a=0;return i._snapshot.docChanges.map(u=>{let l=new De(i._firestore,i._userDataWriter,u.doc.key,u.doc,new me(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter);return u.doc,{type:"added",doc:l,oldIndex:-1,newIndex:a++}})}{let a=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(u=>s||u.type!==3).map(u=>{let l=new De(i._firestore,i._userDataWriter,u.doc.key,u.doc,new me(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter),d=-1,f=-1;return u.type!==0&&(d=a.indexOf(u.doc.key),a=a.delete(u.doc.key)),u.type!==1&&(a=a.add(u.doc),f=a.indexOf(u.doc.key)),{type:F_(u.type),doc:l,oldIndex:d,newIndex:f}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}};function F_(r){switch(r){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return L()}}function qc(r,t){return r instanceof Kt&&t instanceof Kt?r._firestore===t._firestore&&r._key.isEqual(t._key)&&(r._document===null?t._document===null:r._document.isEqual(t._document))&&r._converter===t._converter:r instanceof Yt&&t instanceof Yt&&r._firestore===t._firestore&&kc(r.query,t.query)&&r.metadata.isEqual(t.metadata)&&r._snapshot.isEqual(t._snapshot)}function Um(r){r=X(r,rt);let t=X(r.firestore,ot);return om(vt(t),r._key).then(e=>jc(t,r,e))}var we=class extends rr{constructor(t){super(),this.firestore=t}convertBytes(t){return new ae(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new rt(this.firestore,null,e)}};function Bm(r){r=X(r,rt);let t=X(r.firestore,ot),e=vt(t),n=new we(t);return P_(e,r._key).then(i=>new Kt(t,n,r._key,i,new me(i!==null&&i.hasLocalMutations,!0),r.converter))}function Gm(r){r=X(r,rt);let t=X(r.firestore,ot);return om(vt(t),r._key,{source:"server"}).then(e=>jc(t,r,e))}function jm(r){r=X(r,St);let t=X(r.firestore,ot),e=vt(t),n=new we(t);return Cm(r._query),am(e,r._query).then(i=>new Yt(t,n,r,i))}function zm(r){r=X(r,St);let t=X(r.firestore,ot),e=vt(t),n=new we(t);return C_(e,r._query).then(i=>new Yt(t,n,r,i))}function Km(r){r=X(r,St);let t=X(r.firestore,ot),e=vt(t),n=new we(t);return am(e,r._query,{source:"server"}).then(i=>new Yt(t,n,r,i))}function Uc(r,t,e){r=X(r,rt);let n=X(r.firestore,ot),i=ao(r.converter,t,e);return lr(n,[so(_n(n),"setDoc",r._key,i,r.converter!==null,e).toMutation(r._key,ht.none())])}function Bc(r,t,e,...n){r=X(r,rt);let i=X(r.firestore,ot),s=_n(i),a;return a=typeof(t=ct(t))=="string"||t instanceof Jt?Mc(s,"updateDoc",r._key,t,e,n):Fc(s,"updateDoc",r._key,t),lr(i,[a.toMutation(r._key,ht.exists(!0))])}function $m(r){return lr(X(r.firestore,ot),[new Be(r._key,ht.none())])}function Qm(r,t){let e=X(r.firestore,ot),n=Ei(r),i=ao(r.converter,t);return lr(e,[so(_n(r.firestore),"addDoc",n._key,i,r.converter!==null,{}).toMutation(n._key,ht.exists(!1))]).then(()=>n)}function Gc(r,...t){var e,n,i;r=ct(r);let s={includeMetadataChanges:!1,source:"default"},a=0;typeof t[a]!="object"||zu(t[a])||(s=t[a],a++);let u={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(zu(t[a])){let g=t[a];t[a]=(e=g.next)===null||e===void 0?void 0:e.bind(g),t[a+1]=(n=g.error)===null||n===void 0?void 0:n.bind(g),t[a+2]=(i=g.complete)===null||i===void 0?void 0:i.bind(g)}let l,d,f;if(r instanceof rt)d=X(r.firestore,ot),f=sr(r._key.path),l={next:g=>{t[a]&&t[a](jc(d,r,g))},error:t[a+1],complete:t[a+2]};else{let g=X(r,St);d=X(g.firestore,ot),f=g._query;let y=new we(d);l={next:S=>{t[a]&&t[a](new Yt(d,y,g,S))},error:t[a+1],complete:t[a+2]},Cm(r._query)}return function(y,S,N,k){let D=new er(k),G=new hi(S,D,N);return y.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return yc(yield nr(y),G)})),()=>{D.$a(),y.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return wc(yield nr(y),G)}))}}(vt(d),f,u,l)}function Wm(r,t){return x_(vt(r=X(r,ot)),zu(t)?t:{next:t})}function lr(r,t){return function(n,i){let s=new yt;return n.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){return c_(yield Pc(n),i,s)})),s.promise}(vt(r),t)}function jc(r,t,e){let n=e.docs.get(t._key),i=new we(r);return new Kt(r,i,t._key,n,new me(e.hasPendingWrites,e.fromCache),t.converter)}var M_={maxAttempts:5};var Zs=class{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=_n(t)}set(t,e,n){this._verifyNotCommitted();let i=xe(t,this._firestore),s=ao(i.converter,e,n),a=so(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,n);return this._mutations.push(a.toMutation(i._key,ht.none())),this}update(t,e,n,...i){this._verifyNotCommitted();let s=xe(t,this._firestore),a;return a=typeof(e=ct(e))=="string"||e instanceof Jt?Mc(this._dataReader,"WriteBatch.update",s._key,e,n,i):Fc(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(a.toMutation(s._key,ht.exists(!0))),this}delete(t){this._verifyNotCommitted();let e=xe(t,this._firestore);return this._mutations=this._mutations.concat(new Be(e._key,ht.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new x(P.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function xe(r,t){if((r=ct(r)).firestore!==t)throw new x(P.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return r}var rc=class extends class{constructor(e,n){this._firestore=e,this._transaction=n,this._dataReader=_n(e)}get(e){let n=xe(e,this._firestore),i=new nc(this._firestore);return this._transaction.lookup([n._key]).then(s=>{if(!s||s.length!==1)return L();let a=s[0];if(a.isFoundDocument())return new mn(this._firestore,i,a.key,a,n.converter);if(a.isNoDocument())return new mn(this._firestore,i,n._key,null,n.converter);throw L()})}set(e,n,i){let s=xe(e,this._firestore),a=ao(s.converter,n,i),u=so(this._dataReader,"Transaction.set",s._key,a,s.converter!==null,i);return this._transaction.set(s._key,u),this}update(e,n,i,...s){let a=xe(e,this._firestore),u;return u=typeof(n=ct(n))=="string"||n instanceof Jt?Mc(this._dataReader,"Transaction.update",a._key,n,i,s):Fc(this._dataReader,"Transaction.update",a._key,n),this._transaction.update(a._key,u),this}delete(e){let n=xe(e,this._firestore);return this._transaction.delete(n._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){let e=xe(t,this._firestore),n=new we(this._firestore);return super.get(t).then(i=>new Kt(this._firestore,n,e._key,i._document,new me(!1,!1),e.converter))}};function Hm(r,t,e){r=X(r,ot);let n=Object.assign(Object.assign({},M_),e);return function(s){if(s.maxAttempts<1)throw new x(P.INVALID_ARGUMENT,"Max attempts must be at least 1")}(n),function(s,a,u){let l=new yt;return s.asyncQueue.enqueueAndForget(()=>C(this,null,function*(){let d=yield S_(s);new Uu(s.asyncQueue,d,u,a,l).Xa()})),l.promise}(vt(r),i=>t(new rc(r,i)),n)}function Jm(){return new mi("deleteField")}function Ym(){return new Wu("serverTimestamp")}function Xm(...r){return new Hu("arrayUnion",r)}function Zm(...r){return new Ju("arrayRemove",r)}function tg(r){return new Yu("increment",r)}(function(t,e=!0){(function(i){ir=i})(mh),dh(new Ki("firestore",(n,{instanceIdentifier:i,options:s})=>{let a=n.getProvider("app").getImmediate(),u=new ot(new ua(n.getProvider("auth-internal")),new da(n.getProvider("app-check-internal")),function(d,f){if(!Object.prototype.hasOwnProperty.apply(d.options,["projectId"]))throw new x(P.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Me(d.options.projectId,f)}(a,i),a);return s=Object.assign({useFetchStreams:e},s),u._setSettings(s),u},"PUBLIC").setMultipleInstances(!0)),Qo(Dh,"4.6.2",t),Qo(Dh,"4.6.2","esm2017")})();var O_="@firebase/firestore-compat",L_="0.3.31";function Hc(r,t){if(t===void 0)return{merge:!1};if(t.mergeFields!==void 0&&t.merge!==void 0)throw new x("invalid-argument",`Invalid options passed to function ${r}(): You cannot specify both "merge" and "mergeFields".`);return t}function eg(){if(typeof Uint8Array>"u")throw new x("unimplemented","Uint8Arrays are not available in this environment.")}function ng(){if(!$d())throw new x("unimplemented","Blobs are unavailable in Firestore in this environment.")}var uo=class r{constructor(t){this._delegate=t}static fromBase64String(t){return ng(),new r(ae.fromBase64String(t))}static fromUint8Array(t){return eg(),new r(ae.fromUint8Array(t))}toBase64(){return ng(),this._delegate.toBase64()}toUint8Array(){return eg(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function zc(r){return q_(r,["next","error","complete"])}function q_(r,t){if(typeof r!="object"||r===null)return!1;let e=r;for(let n of t)if(n in e&&typeof e[n]=="function")return!0;return!1}var Kc=class{enableIndexedDbPersistence(t,e){return fm(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return mm(t._delegate)}clearIndexedDbPersistence(t){return pm(t._delegate)}},co=class{constructor(t,e,n){this._delegate=e,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},t instanceof Me||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){let e=this._delegate._getSettings();!t.merge&&e.host!==t.host&&jt("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&(t=Object.assign(Object.assign({},e),t),delete t.merge),this._delegate._setSettings(t)}useEmulator(t,e,n={}){Vc(this._delegate,t,e,n)}enableNetwork(){return ym(this._delegate)}disableNetwork(){return wm(this._delegate)}enablePersistence(t){let e=!1,n=!1;return t&&(e=!!t.synchronizeTabs,n=!!t.experimentalForceOwningTab,xc("synchronizeTabs",e,"experimentalForceOwningTab",n)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return _m(this._delegate)}onSnapshotsInSync(t){return Wm(this._delegate,t)}get app(){if(!this._appCompat)throw new x("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new fr(this,Dc(this._delegate,t))}catch(e){throw Mt(e,"collection()","Firestore.collection()")}}doc(t){try{return new ue(this,Ei(this._delegate,t))}catch(e){throw Mt(e,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new En(this,lm(this._delegate,t))}catch(e){throw Mt(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Hm(this._delegate,e=>t(new lo(this,e)))}batch(){return vt(this._delegate),new ho(new Zs(this._delegate,t=>lr(this._delegate,t)))}loadBundle(t){return vm(this._delegate,t)}namedQuery(t){return Im(this._delegate,t).then(e=>e?new En(this,e):null)}},hr=class extends rr{constructor(t){super(),this.firestore=t}convertBytes(t){return new uo(new ae(t))}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return ue.forKey(e,this.firestore,null)}};function U_(r){Dd(r)}var lo=class{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new hr(t)}get(t){let e=wn(t);return this._delegate.get(e).then(n=>new vn(this._firestore,new Kt(this._firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,e.converter)))}set(t,e,n){let i=wn(t);return n?(Hc("Transaction.set",n),this._delegate.set(i,e,n)):this._delegate.set(i,e),this}update(t,e,n,...i){let s=wn(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,n,...i),this}delete(t){let e=wn(t);return this._delegate.delete(e),this}},ho=class{constructor(t){this._delegate=t}set(t,e,n){let i=wn(t);return n?(Hc("WriteBatch.set",n),this._delegate.set(i,e,n)):this._delegate.set(i,e),this}update(t,e,n,...i){let s=wn(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,n,...i),this}delete(t){let e=wn(t);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}},dr=class r{constructor(t,e,n){this._firestore=t,this._userDataWriter=e,this._delegate=n}fromFirestore(t,e){let n=new De(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new In(this._firestore,n),e??{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){let n=r.INSTANCES,i=n.get(t);i||(i=new WeakMap,n.set(t,i));let s=i.get(e);return s||(s=new r(t,new hr(t),e),i.set(e,s)),s}};dr.INSTANCES=new WeakMap;var ue=class r{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new hr(t)}static forPath(t,e,n){if(t.length%2!==0)throw new x("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${t.canonicalString()} has ${t.length}`);return new r(e,new rt(e._delegate,n,new M(t)))}static forKey(t,e,n){return new r(e,new rt(e._delegate,n,t))}get id(){return this._delegate.id}get parent(){return new fr(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new fr(this.firestore,Dc(this._delegate,t))}catch(e){throw Mt(e,"collection()","DocumentReference.collection()")}}isEqual(t){return t=ct(t),t instanceof rt?Nc(this._delegate,t):!1}set(t,e){e=Hc("DocumentReference.set",e);try{return e?Uc(this._delegate,t,e):Uc(this._delegate,t)}catch(n){throw Mt(n,"setDoc()","DocumentReference.set()")}}update(t,e,...n){try{return arguments.length===1?Bc(this._delegate,t):Bc(this._delegate,t,e,...n)}catch(i){throw Mt(i,"updateDoc()","DocumentReference.update()")}}delete(){return $m(this._delegate)}onSnapshot(...t){let e=rg(t),n=ig(t,i=>new vn(this.firestore,new Kt(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return Gc(this._delegate,e,n)}get(t){let e;return t?.source==="cache"?e=Bm(this._delegate):t?.source==="server"?e=Gm(this._delegate):e=Um(this._delegate),e.then(n=>new vn(this.firestore,new Kt(this.firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,this._delegate.converter)))}withConverter(t){return new r(this.firestore,t?this._delegate.withConverter(dr.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function Mt(r,t,e){return r.message=r.message.replace(t,e),r}function rg(r){for(let t of r)if(typeof t=="object"&&!zc(t))return t;return{}}function ig(r,t){var e,n;let i;return zc(r[0])?i=r[0]:zc(r[1])?i=r[1]:typeof r[0]=="function"?i={next:r[0],error:r[1],complete:r[2]}:i={next:r[1],error:r[2],complete:r[3]},{next:s=>{i.next&&i.next(t(s))},error:(e=i.error)===null||e===void 0?void 0:e.bind(i),complete:(n=i.complete)===null||n===void 0?void 0:n.bind(i)}}var vn=class{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new ue(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return qc(this._delegate,t._delegate)}},In=class extends vn{data(t){let e=this._delegate.data(t);return this._delegate._converter||Nd(e!==void 0,"Document in a QueryDocumentSnapshot should exist"),e}},En=class r{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new hr(t)}where(t,e,n){try{return new r(this.firestore,Ie(this._delegate,xm(t,e,n)))}catch(i){throw Mt(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(t,e){try{return new r(this.firestore,Ie(this._delegate,Vm(t,e)))}catch(n){throw Mt(n,/(orderBy|where)\(\)/,"Query.$1()")}}limit(t){try{return new r(this.firestore,Ie(this._delegate,Dm(t)))}catch(e){throw Mt(e,"limit()","Query.limit()")}}limitToLast(t){try{return new r(this.firestore,Ie(this._delegate,Nm(t)))}catch(e){throw Mt(e,"limitToLast()","Query.limitToLast()")}}startAt(...t){try{return new r(this.firestore,Ie(this._delegate,km(...t)))}catch(e){throw Mt(e,"startAt()","Query.startAt()")}}startAfter(...t){try{return new r(this.firestore,Ie(this._delegate,Fm(...t)))}catch(e){throw Mt(e,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new r(this.firestore,Ie(this._delegate,Mm(...t)))}catch(e){throw Mt(e,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new r(this.firestore,Ie(this._delegate,Om(...t)))}catch(e){throw Mt(e,"endAt()","Query.endAt()")}}isEqual(t){return kc(this._delegate,t._delegate)}get(t){let e;return t?.source==="cache"?e=zm(this._delegate):t?.source==="server"?e=Km(this._delegate):e=jm(this._delegate),e.then(n=>new Ti(this.firestore,new Yt(this.firestore._delegate,this._userDataWriter,this._delegate,n._snapshot)))}onSnapshot(...t){let e=rg(t),n=ig(t,i=>new Ti(this.firestore,new Yt(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return Gc(this._delegate,e,n)}withConverter(t){return new r(this.firestore,t?this._delegate.withConverter(dr.getInstance(this.firestore,t)):this._delegate.withConverter(null))}},$c=class{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new In(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},Ti=class{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new En(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(t=>new In(this._firestore,t))}docChanges(t){return this._delegate.docChanges(t).map(e=>new $c(this._firestore,e))}forEach(t,e){this._delegate.forEach(n=>{t.call(e,new In(this._firestore,n))})}isEqual(t){return qc(this._delegate,t._delegate)}},fr=class r extends En{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let t=this._delegate.parent;return t?new ue(this.firestore,t):null}doc(t){try{return t===void 0?new ue(this.firestore,Ei(this._delegate)):new ue(this.firestore,Ei(this._delegate,t))}catch(e){throw Mt(e,"doc()","CollectionReference.doc()")}}add(t){return Qm(this._delegate,t).then(e=>new ue(this.firestore,e))}isEqual(t){return Nc(this._delegate,t._delegate)}withConverter(t){return new r(this.firestore,t?this._delegate.withConverter(dr.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function wn(r){return X(r,rt)}var Qc=class r{constructor(...t){this._delegate=new Jt(...t)}static documentId(){return new r(ft.keyField().canonicalString())}isEqual(t){return t=ct(t),t instanceof Jt?this._delegate._internalPath.isEqual(t._internalPath):!1}};var Wc=class r{constructor(t){this._delegate=t}static serverTimestamp(){let t=Ym();return t._methodName="FieldValue.serverTimestamp",new r(t)}static delete(){let t=Jm();return t._methodName="FieldValue.delete",new r(t)}static arrayUnion(...t){let e=Xm(...t);return e._methodName="FieldValue.arrayUnion",new r(e)}static arrayRemove(...t){let e=Zm(...t);return e._methodName="FieldValue.arrayRemove",new r(e)}static increment(t){let e=tg(t);return e._methodName="FieldValue.increment",new r(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}};var B_={Firestore:co,GeoPoint:fn,Timestamp:at,Blob:uo,Transaction:lo,WriteBatch:ho,DocumentReference:ue,DocumentSnapshot:vn,Query:En,QueryDocumentSnapshot:In,QuerySnapshot:Ti,CollectionReference:fr,FieldPath:Qc,FieldValue:Wc,setLogLevel:U_,CACHE_SIZE_UNLIMITED:hm};function G_(r,t){r.INTERNAL.registerComponent(new Ki("firestore-compat",e=>{let n=e.getProvider("app-compat").getImmediate(),i=e.getProvider("firestore").getImmediate();return t(n,i)},"PUBLIC").setServiceProps(Object.assign({},B_)))}function j_(r){G_(r,(t,e)=>new co(t,e,new Kc)),r.registerVersion(O_,L_)}j_(Wo);function z_(r,t=eh){return new th(e=>{let n;return t!=null?t.schedule(()=>{n=r.onSnapshot({includeMetadataChanges:!0},e)}):n=r.onSnapshot({includeMetadataChanges:!0},e),()=>{n?.()}})}function sg(r,t){return z_(r,t)}function K_(r,t){return sg(r,t).pipe(zi(void 0),Gi(),Qt(e=>{let[n,i]=e;return i.exists?n?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function Xc(r,t){return sg(r,t).pipe(Qt(e=>({payload:e,type:"query"})))}var fo=class{ref;afs;constructor(t,e){this.ref=t,this.afs=e}set(t,e){return this.ref.set(t,e)}update(t){return this.ref.update(t)}delete(){return this.ref.delete()}collection(t,e){let n=this.ref.collection(t),{ref:i,query:s}=ug(n,e);return new go(i,s,this.afs)}snapshotChanges(){return K_(this.ref,this.afs.schedulers.outsideAngular).pipe(Bt)}valueChanges(t={}){return this.snapshotChanges().pipe(Qt(({payload:e})=>t.idField?Bo(Bi({},e.data()),{[t.idField]:e.id}):e.data()))}get(t){return Nr(this.ref.get(t)).pipe(Bt)}};function mo(r,t){return Xc(r,t).pipe(zi(void 0),Gi(),Qt(e=>{let[n,i]=e,s=i.payload.docChanges(),a=s.map(u=>({type:u.type,payload:u}));return n&&JSON.stringify(n.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((u,l)=>{let d=s.find(g=>g.doc.ref.isEqual(u.ref)),f=n?.payload.docs.find(g=>g.ref.isEqual(u.ref));d&&JSON.stringify(d.doc.metadata)===JSON.stringify(u.metadata)||!d&&f&&JSON.stringify(f.metadata)===JSON.stringify(u.metadata)||a.push({type:"modified",payload:{oldIndex:l,newIndex:l,type:"modified",doc:u}})}),a}))}function og(r,t,e){return mo(r,e).pipe(ji((n,i)=>$_(n,i.map(s=>s.payload),t),[]),nh(),Qt(n=>n.map(i=>({type:i.type,payload:i}))))}function $_(r,t,e){return t.forEach(n=>{e.indexOf(n.type)>-1&&(r=Q_(r,n))}),r}function Jc(r,t,e,...n){let i=r.slice();return i.splice(t,e,...n),i}function Q_(r,t){switch(t.type){case"added":if(!(r[t.newIndex]&&r[t.newIndex].doc.ref.isEqual(t.doc.ref)))return Jc(r,t.newIndex,0,t);break;case"modified":if(r[t.oldIndex]==null||r[t.oldIndex].doc.ref.isEqual(t.doc.ref))if(t.oldIndex!==t.newIndex){let e=r.slice();return e.splice(t.oldIndex,1),e.splice(t.newIndex,0,t),e}else return Jc(r,t.newIndex,1,t);break;case"removed":if(r[t.oldIndex]&&r[t.oldIndex].doc.ref.isEqual(t.doc.ref))return Jc(r,t.oldIndex,1);break}return r}function ag(r){return(!r||r.length===0)&&(r=["added","removed","modified"]),r}var go=class{ref;query;afs;constructor(t,e,n){this.ref=t,this.query=e,this.afs=n}stateChanges(t){let e=mo(this.query,this.afs.schedulers.outsideAngular);return t&&t.length>0&&(e=e.pipe(Qt(n=>n.filter(i=>t.indexOf(i.type)>-1)))),e.pipe(zi(void 0),Gi(),zo(([n,i])=>i.length>0||!n),Qt(([,n])=>n),Bt)}auditTrail(t){return this.stateChanges(t).pipe(ji((e,n)=>[...e,...n],[]))}snapshotChanges(t){let e=ag(t);return og(this.query,e,this.afs.schedulers.outsideAngular).pipe(Bt)}valueChanges(t={}){return Xc(this.query,this.afs.schedulers.outsideAngular).pipe(Qt(e=>e.payload.docs.map(n=>t.idField?Bo(Bi({},n.data()),{[t.idField]:n.id}):n.data())),Bt)}get(t){return Nr(this.query.get(t)).pipe(Bt)}add(t){return this.ref.add(t)}doc(t){return new fo(this.ref.doc(t),this.afs)}},Yc=class{query;afs;constructor(t,e){this.query=t,this.afs=e}stateChanges(t){return!t||t.length===0?mo(this.query,this.afs.schedulers.outsideAngular).pipe(Bt):mo(this.query,this.afs.schedulers.outsideAngular).pipe(Qt(e=>e.filter(n=>t.indexOf(n.type)>-1)),zo(e=>e.length>0),Bt)}auditTrail(t){return this.stateChanges(t).pipe(ji((e,n)=>[...e,...n],[]))}snapshotChanges(t){let e=ag(t);return og(this.query,e,this.afs.schedulers.outsideAngular).pipe(Bt)}valueChanges(t={}){return Xc(this.query,this.afs.schedulers.outsideAngular).pipe(Qt(n=>n.payload.docs.map(i=>t.idField?Bi({[t.idField]:i.id},i.data()):i.data())),Bt)}get(t){return Nr(this.query.get(t)).pipe(Bt)}},W_=new kr("angularfire2.enableFirestorePersistence"),H_=new kr("angularfire2.firestore.persistenceSettings"),J_=new kr("angularfire2.firestore.settings"),Y_=new kr("angularfire2.firestore.use-emulator");function ug(r,t=e=>e){return{query:t(r),ref:r}}var jy=(()=>{class r{schedulers;firestore;persistenceEnabled$;constructor(e,n,i,s,a,u,l,d,f,g,y,S,N,k,D,G,j){this.schedulers=l;let U=vh(e,u,n),Q=f;g&&Ph(U,u,y,N,k,D,S,G),[this.firestore,this.persistenceEnabled$]=Ih(`${U.name}.firestore`,"AngularFirestore",U.name,()=>{let H=u.runOutsideAngular(()=>U.firestore());if(s&&H.settings(s),Q&&H.useEmulator(...Q),i&&!oh(a)){let z=()=>{try{return Nr(H.enablePersistence(d||void 0).then(()=>!0,()=>!1))}catch(v){return typeof console<"u"&&console.warn(v),jo(!1)}};return[H,u.runOutsideAngular(z)]}else return[H,jo(!1)]},[s,Q,i])}collection(e,n){let i;typeof e=="string"?i=this.firestore.collection(e):i=e;let{ref:s,query:a}=ug(i,n),u=this.schedulers.ngZone.run(()=>s);return new go(u,a,this)}collectionGroup(e,n){let i=n||(a=>a),s=this.firestore.collectionGroup(e);return new Yc(i(s),this)}doc(e){let n;typeof e=="string"?n=this.firestore.doc(e):n=e;let i=this.schedulers.ngZone.run(()=>n);return new fo(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(n){return new(n||r)(It(yh),It(wh,8),It(W_,8),It(J_,8),It(ih),It(sh),It(_h),It(H_,8),It(Y_,8),It(Ch,8),It(Eh,8),It(Th,8),It(Ah,8),It(Sh,8),It(bh,8),It(Rh,8),It(ph,8))};static \u0275prov=rh({token:r,factory:r.\u0275fac,providedIn:"any"})}return r})();export{dy as a,jy as b};
